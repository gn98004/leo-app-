<!DOCTYPE html>

<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<title>å¿ƒé‡ XinYou - Demo V3</title>
<meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport"/>
<style>
    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", "Microsoft JhengHei", sans-serif;
      background: #f3f4f6;
      color: #111827;
      font-size: 18px;
    }

    /* é ‚éƒ¨åˆ— */
    .top-bar {
      position: sticky;
      top: 0;
      z-index: 30;
      height: 60px;
      padding: 0 16px;
      background: #ffffff;
      border-bottom: 0.5px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .top-bar-inner {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .top-title {
      font-size: 22px;
      font-weight: 700;
    }
    .top-right {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .icon-button {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: #f3f4f6;
      cursor: pointer;
    }
    .icon-gear {
      width: 22px;
      height: 22px;
      opacity: 0.8;
    }

    .page {
      display: none;
      padding-bottom: 72px;
    }
    .page.active {
      display: block;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 2px 4px rgba(15,23,42,0.08);
    }

    /* äººå€‘ (2x2) */
    .people-wrapper {
      padding: 14px 14px 6px;
    }
    .people-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }
    .people-card {
      border-radius: 18px;
      overflow: hidden;
      background: #ffffff;
      box-shadow: 0 2px 5px rgba(15, 23, 42, 0.12);
      cursor: pointer;
      display: flex;
      flex-direction: column;
    }
    .people-photo {
      width: 100%;
      padding-top: 140%;
      position: relative;
      background: #e5e7eb;
      overflow: hidden;
    }
    .people-photo img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .people-info {
      padding: 8px 10px 10px;
    }
    .people-name-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .people-name {
      font-size: 18px;
      font-weight: 700;
    }
    .people-age {
      font-size: 14px;
      color: #6b7280;
    }
    .people-desc {
      margin-top: 6px;
      font-size: 14px;
      color: #6b7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-badge {
      margin-top: 6px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      font-size: 13px;
      border-radius: 999px;
      background: #e5f9e7;
      color: #16a34a;
    }
    .status-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #22c55e;
    }
    .status-busy {
      background: #fef9c3;
      color: #ca8a04;
    }
    .status-busy .status-dot { background: #eab308; }
    .status-away {
      background: #e5e7eb;
      color: #4b5563;
    }
    .status-away .status-dot { background: #6b7280; }
    .status-eating {
      background: #fee2e2;
      color: #b91c1c;
    }
    .status-eating .status-dot { background: #dc2626; }
    .status-shower {
      background: #e0f2fe;
      color: #0369a1;
    }
    .status-shower .status-dot { background: #0284c7; }

    .pager {
      display: flex;
      justify-content: center;
      padding: 10px 0 6px;
    }
    .pager-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 8px 18px;
      font-size: 16px;
      background: #ffffff;
      cursor: pointer;
      color: #374151;
    }
    .pager-btn:hover {
      background: #f3f4f6;
    }

    /* å¥½å‹ */
    .tabs-row {
      display: flex;
      background: #ffffff;
      border-bottom: 0.5px solid #e5e7eb;
    }
    .tab-btn {
      flex: 1;
      text-align: center;
      padding: 10px 0;
      font-size: 16px;
      cursor: pointer;
      color: #6b7280;
    }
    .tab-btn.active {
      color: #2563eb;
      border-bottom: 3px solid #2563eb;
      font-weight: 700;
    }
    .list {
      list-style: none;
      margin: 0;
      padding: 0;
      background: #ffffff;
    }
    .list-item {
      display: flex;
      padding: 12px 16px;
      border-bottom: 0.5px solid #f0f0f0;
      cursor: pointer;
    }
    .avatar {
      width: 56px;
      height: 56px;
      border-radius: 18px;
      overflow: hidden;
      margin-right: 12px;
      background: #e5e7eb;
      flex-shrink: 0;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .item-main {
      flex: 1;
      min-width: 0;
    }
    .item-row1 {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .item-row1-left {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .item-name {
      font-size: 18px;
      font-weight: 700;
    }
    .item-mood {
      font-size: 22px;
    }
    .item-row2 {
      margin-top: 4px;
      font-size: 14px;
      color: #6b7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .item-row3 {
      margin-top: 4px;
      font-size: 14px;
      color: #4b5563;
    }
    .item-row3 span.label {
      color: #9ca3af;
      margin-right: 4px;
    }
    .status-inline {
      margin-left: 4px;
    }

    /* è©³ç´°æª”æ¡ˆ & ç›¸ç°¿ */
    .profile-header {
      padding: 14px 16px;
      background: #ffffff;
      border-bottom: 0.5px solid #e5e7eb;
    }
    .profile-row-main {
      display: flex;
      align-items: center;
    }
    .profile-main {
      flex: 1;
      min-width: 0;
    }
    .profile-name-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .profile-status-inline {
      flex-shrink: 0;
    }
    .profile-status-edit {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
    }
    .profile-status-edit select {
      font-size: 14px;
      padding: 4px 6px;
    }
    .profile-status-inline .status-badge {
      margin-top: 0;
    }
    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 22px;
      overflow: hidden;
      margin-right: 14px;
      background: #e5e7eb;
      flex-shrink: 0;
    }
    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .profile-name {
      font-size: 22px;
      font-weight: 700;
    }
    .profile-sub {
      margin-top: 4px;
      font-size: 16px;
      color: #6b7280;
    }
    .profile-actions {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      border-radius: 12px;
      border: 1px solid #d1d5db;
      padding: 7px 12px;
      font-size: 16px;
      background: #f9fafb;
      cursor: pointer;
    }
    .btn-primary {
      border-color: #2563eb;
      background: #2563eb;
      color: #ffffff;
    }
    .btn-sm {
      padding: 4px 8px;
      font-size: 13px;
      border-radius: 999px;
      margin-right: 6px;
    }

    .section {
      margin-top: 12px;
      background: #ffffff;
      border-top: 0.5px solid #e5e7eb;
      border-bottom: 0.5px solid #e5e7eb;
    }
    .section-title {
      padding: 10px 16px;
      font-size: 18px;
      font-weight: 700;
      color: #374151;
      border-bottom: 0.5px solid #f3f4f6;
    }

    /* æ–°ï¼šå…©é¡†å¤§æŒ‰éˆ• */
    .profile-cta-row {
      padding: 12px 16px 14px;
      display: flex;
      gap: 10px;
    }
    .big-cta-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      font-size: 17px;
      padding: 10px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .big-cta-btn.secondary {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      color: #374151;
    }
    .big-cta-btn.primary {
      background: #f97316;
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(248, 148, 60, 0.45);
    }

    /* ç›¸ç°¿å€å¡Šï¼ˆåˆ¥äººæª”æ¡ˆç”¨ï¼‰ */
    .album-grid {
      padding: 12px 16px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .album-item {
      position: relative;
      width: 100%;
      padding-top: 100%;
      border-radius: 14px;
      overflow: hidden;
      background: #e5e7eb;
      cursor: pointer;
    }
    .album-item img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: filter 0.15s ease, transform 0.15s ease, opacity 0.15s ease;
    }
    .album-item.locked img {
      filter: blur(8px);
      transform: scale(1.06);
      opacity: 0.9;
    }
    .album-item.locked::after {
      content: "ğŸ”’ è§€çœ‹å»£å‘Šè§£é– 30 åˆ†é˜";
      position: absolute;
      left: 6px;
      right: 6px;
      bottom: 6px;
      padding: 3px 6px;
      border-radius: 999px;
      background: rgba(15,23,42,0.78);
      color: #f9fafb;
      font-size: 11px;
      text-align: center;
    }
    .set-cover-btn {
      position: absolute;
      bottom: 4px;
      right: 4px;
      background: rgba(0,0,0,0.55);
      color: white;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 10px;
      border: none;
      display: none;
    }
    .album-item:hover .set-cover-btn {
      display: inline-block;
    }
    .album-gift-btn {
      position: absolute;
      left: 4px;
      bottom: 4px;
      background: rgba(248, 113, 113, 0.92);
      color: #fff;
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 999px;
      border: none;
    }
    .album-note {
      font-size: 13px;
      color: #6b7280;
      padding: 0 16px 12px;
    }

    /* å…¨è¢å¹•åœ–ç‰‡ Viewer */
    .photo-viewer {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .photo-viewer.show {
      display: flex;
    }
    .photo-viewer img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
    }
    .photo-viewer-close {
      position: fixed;
      top: 14px;
      right: 14px;
      color: white;
      font-size: 30px;
      cursor: pointer;
    }

    /* é€ç¦®å‹•ç•« */
    .gift-heart {
      position: fixed;
      font-size: 28px;
      pointer-events: none;
      animation: floatUp 1s ease-out forwards;
      z-index: 2100;
    }
    @keyframes floatUp {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-70px) scale(1.5); }
    }

    /* åŸºæœ¬è³‡æ–™ + æ—¥è¨˜ */
    .info-table {
      width: 100%;
      border-collapse: collapse;
    }
    .info-table tr {
      border-bottom: 0.5px solid #f3f4f6;
    }
    .info-key {
      width: 90px;
      padding: 10px 16px;
      font-size: 16px;
      color: #6b7280;
    }
    .info-value {
      padding: 10px 16px 10px 0;
      font-size: 16px;
    }
    .diary-list {
      padding: 8px 16px 12px;
    }
    .diary-item {
      padding: 7px 0;
      border-bottom: 0.5px dashed #e5e7eb;
      font-size: 16px;
    }
    .diary-item:last-child {
      border-bottom: none;
    }
    .diary-date {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 3px;
    }

    /* èŠå¤©é  */
    .chat-wrapper {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }
    /* èŠå¤©åˆ—è¡¨ + å³å´æ»‘å…¥è¦–çª— */
    #page-chat {
      position: relative;
    }
    .chat-panel {
      position: fixed;
      top: 60px;
      left: 0;
      right: 0;
      bottom: 64px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.25s ease-out;
      box-shadow: -2px 0 8px rgba(15,23,42,0.15);
      z-index: 35;
    }
    .chat-panel.show {
      transform: translateX(0);
    }
    .chat-panel-header {
      height: 48px;
      display: flex;
      align-items: center;
      padding: 0 10px;
      border-bottom: 0.5px solid #e5e7eb;
    }
    .chat-back-btn {
      border: none;
      background: transparent;
      font-size: 22px;
      margin-right: 8px;
      cursor: pointer;
    }
    .chat-panel-title {
      font-size: 18px;
      font-weight: 600;
    }
    .chat-panel-subtitle {
      font-size: 12px;
      color: #9ca3af;
      margin-left: 2px;
      margin-top: 2px;
    }
    .chat-panel-body {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px 12px 6px;
    }
    .bubble-row {
      display: flex;
      margin-bottom: 8px;
    }
    .bubble-row.me {
      justify-content: flex-end;
    }
    .bubble {
      max-width: 74%;
      padding: 10px 12px;
      border-radius: 20px;
      font-size: 16px;
      line-height: 1.5;
      background: #ffffff;
      border: 0.5px solid #e5e7eb;
    }
    .bubble.them {
      background: #ffffff;
      border: 0.5px solid #e5e7eb;
    }
    .bubble.me {
      background: #4ade80;
      color: #064e3b;
    }
    .chat-image {
      max-width: 220px;
      max-height: 220px;
      border-radius: 12px;
      display: block;
    }

    .chat-theme-bar {
      display: flex;
      padding: 8px 10px 0;
      gap: 8px;
      background: transparent;
    }
    .chat-theme-pill {
      flex: 1;
      text-align: center;
      font-size: 14px;
      padding: 6px 0;
      border-radius: 999px;
      cursor: pointer;
      border: 1px solid #d1d5db;
      background: #ffffff;
    }
    .chat-theme-pill.active {
      background: #111827;
      color: #f9fafb;
      border-color: #111827;
    }

    .chat-theme-light .chat-messages { background: #f3f4f6; }
    .chat-theme-pink .chat-messages { background: #fef2f2; }
    .chat-theme-blue .chat-messages { background: #eff6ff; }
    .chat-theme-dark .chat-messages { background: #030712; }
    .chat-theme-dark .bubble.them {
      background: #111827;
      color: #e5e7eb;
      border-color: #111827;
    }

    .chat-input-area {
      background: #f9fafb;
      border-top: 0.5px solid #e5e7eb;
    }

    .chat-more-menu {
      display: none;
      padding: 6px 10px;
      border-bottom: 0.5px solid #e5e7eb;
      background: #ffffff;
      gap: 8px;
      flex-wrap: wrap;
    }
    .chat-more-menu.show {
      display: flex;
    }
    .chat-more-btn {
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      cursor: pointer;
    }

    .chat-sticker-bar {
      display: none;
      padding: 6px 10px 4px;
      border-bottom: 0.5px solid #e5e7eb;
      background: #ffffff;
    }
    .chat-sticker-bar.show {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .sticker-btn {
      font-size: 24px;
      padding: 4px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      cursor: pointer;
    }

    .chat-input-bar {
      display: flex;
      padding: 8px 10px;
      align-items: center;
      gap: 8px;
    }
    .chat-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 8px 14px;
      font-size: 16px;
      outline: none;
      background: #ffffff;
    }
    .chat-send-btn {
      padding: 8px 14px;
      font-size: 16px;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      cursor: pointer;
    }
    .chat-plus-btn {
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      background: #e5e7eb;
      cursor: pointer;
      font-size: 20px;
    }

    /* æˆ‘çš„æª”æ¡ˆ */
    .my-section-note {
      font-size: 14px;
      color: #6b7280;
      padding: 0 16px 12px;
    }
    .form-list {
      background: #ffffff;
      border-top: 0.5px solid #e5e7eb;
      border-bottom: 0.5px solid #e5e7eb;
    }
    .form-row {
      padding: 12px 16px;
      border-bottom: 0.5px solid #f3f4f6;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
    }
    .form-row:last-child { border-bottom: none; }
    .form-label { color: #374151; }
    .form-value { color: #6b7280; }

    .toggle {
      width: 46px;
      height: 26px;
      border-radius: 999px;
      background: #e5e7eb;
      position: relative;
      cursor: pointer;
    }
    .toggle-knob {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
      transition: all 0.16s ease;
    }
    .toggle.on { background: #22c55e; }
    .toggle.on .toggle-knob { left: 23px; }

    select, textarea {
      font-size: 15px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      width: 100%;
      outline: none;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* èª°ä¾†çœ‹éæˆ‘ */
    .footprint-list {
      padding: 8px 16px 12px;
    }
    .footprint-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 15px;
    }
    .footprint-avatar {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      overflow: hidden;
      background: #e5e7eb;
      margin-right: 10px;
      flex-shrink: 0;
    }
    .footprint-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .footprint-main {
      flex: 1;
    }
    .footprint-name {
      font-weight: 600;
    }
    .footprint-sub {
      font-size: 13px;
      color: #6b7280;
    }

    /* æ’è¡Œæ¦œ */
    .rank-wrapper {
      padding: 10px 12px 14px;
    }
    .rank-tabs {
      display: flex;
      background: #ffffff;
      border-radius: 999px;
      padding: 4px;
      margin: 4px 10px 12px;
      box-shadow: 0 2px 4px rgba(15,23,42,0.08);
    }
    .rank-tab {
      flex: 1;
      text-align: center;
      font-size: 15px;
      padding: 6px 0;
      border-radius: 999px;
      cursor: pointer;
      color: #6b7280;
    }
    .rank-tab.active {
      background: #111827;
      color: #f9fafb;
      font-weight: 700;
    }
    .rank-pyramid-card {
      padding: 12px 10px 16px;
    }
    .rank-row {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
      gap: 16px;
    }
    .rank-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 13px;
      background: #fef3c7;
      color: #92400e;
    }
    .rank-badge span.icon {
      font-size: 18px;
    }
    .rank-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .rank-avatar-wrap {
      border-radius: 999px;
      padding: 3px;
      background: linear-gradient(135deg, #fde68a, #fbbf24);
      box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.4);
    }
    .rank-avatar-wrap.king {
      padding: 4px;
      box-shadow: 0 0 0 3px rgba(250, 204, 21, 0.6);
    }
    .rank-avatar {
      width: 110px;
      height: 110px;
      border-radius: 999px;
      overflow: hidden;
      background: #e5e7eb;
    }
    .rank-avatar.medium {
      width: 80px;
      height: 80px;
    }
    .rank-avatar.small {
      width: 65px;
      height: 65px;
    }
    .rank-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .rank-name {
      font-size: 16px;
      font-weight: 700;
      margin-top: 6px;
    }
    .rank-sub {
      font-size: 14px;
      color: #6b7280;
    }

    .rank-list {
      margin-top: 10px;
      background: #ffffff;
      border-radius: 18px;
      overflow: hidden;
      border: 0.5px solid #e5e7eb;
    }
    .rank-list-item {
      display: flex;
      align-items: center;
      padding: 10px 14px;
      border-bottom: 0.5px solid #f3f4f6;
      font-size: 15px;
    }
    .rank-list-item:last-child { border-bottom: none; }
    .rank-pos {
      width: 26px;
      color: #6b7280;
    }
    .rank-list-avatar {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      overflow: hidden;
      background: #e5e7eb;
      margin-right: 10px;
      flex-shrink: 0;
    }
    .rank-list-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .rank-list-main {
      flex: 1;
      min-width: 0;
    }
    .rank-list-name {
      font-weight: 600;
    }
    .rank-list-sub {
      font-size: 13px;
      color: #9ca3af;
    }
    .rank-score {
      font-size: 13px;
      color: #4b5563;
    }
    .rank-note {
      margin-top: 10px;
      font-size: 13px;
      color: #6b7280;
      text-align: center;
      padding: 0 10px;
    }

    /* åº•éƒ¨å°è¦½ */
    .bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 64px;
      background: #ffffff;
      border-top: 0.5px solid #e5e7eb;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 40;
    }
    .nav-item {
      flex: 1;
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
      cursor: pointer;
    }
    .nav-item-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    .nav-icon {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #d1d5db;
      font-size: 16px;
      font-weight: 700;
      background: #f9fafb;
    }
    .nav-item.active {
      color: #2563eb;
    }
    .nav-item.active .nav-icon {
      border-color: #2563eb;
      background: #eff6ff;
      color: #2563eb;
    }

    /* ================== åŸºæœ¬è³‡æ–™å½ˆçª— & ç™»å…¥ ================== */
    .hm-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(3px);
    }
    .hm-modal {
      width: 90%;
      max-width: 420px;
      max-height: 90vh;
      background: #ffffff;
      border-radius: 18px;
      padding: 20px 18px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .hm-modal-header h2 {
      font-size: 20px;
      margin: 0 0 4px 0;
    }
    .hm-modal-header p {
      margin: 0 0 12px 0;
      font-size: 13px;
      color: #666;
    }
    .hm-form-group {
      margin-bottom: 14px;
    }
    .hm-form-group label {
      display: block;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .hm-required {
      color: #e53935;
    }
    .hm-form-group input[type="text"],
    .hm-form-group input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
      box-sizing: border-box;
    }
    .hm-form-group input:focus {
      outline: none;
      border-color: #ff3b81;
      box-shadow: 0 0 0 1px rgba(255, 59, 129, 0.15);
    }
    .hm-inline {
      display: flex;
      gap: 10px;
    }
    .hm-inline > div {
      flex: 1;
    }
    .hm-checkbox-group label {
      display: flex;
      align-items: center;
      font-size: 13px;
      gap: 6px;
    }
    .hm-checkbox-group input[type="checkbox"] {
      width: 16px;
      height: 16px;
    }
    .hm-help-text {
      font-size: 11px;
      color: #888;
      margin: 2px 0 6px 0;
    }
    .hm-social-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .hm-social-label {
      display: inline-block;
      min-width: 78px;
      font-size: 12px;
      color: #444;
    }
    .hm-modal-footer {
      margin-top: 14px;
      text-align: center;
    }
    .hm-btn-primary {
      width: 100%;
      padding: 10px 0;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #ff4b8a, #ff7a5c);
      color: #fff;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    .hm-btn-primary:active {
      transform: scale(0.98);
    }
    .hm-btn-secondary {
      width: 100%;
      padding: 10px 0;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #374151;
      font-size: 15px;
      cursor: pointer;
      margin-top: 8px;
    }
    .hm-btn-secondary span {
      margin-left: 6px;
    }
    .hm-privacy-text {
      margin-top: 8px;
      font-size: 11px;
      color: #999;
      text-align: center;
    }

    /* ================== æˆ‘çš„è³‡æ–™å¡ç‰‡ ================== */
    #hm-profile-section {
      padding: 16px;
      box-sizing: border-box;
    }
    .hm-profile-card {
      background: rgba(255, 255, 255, 0.96);
      border-radius: 18px;
      padding: 14px 16px 12px 16px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .hm-profile-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .hm-profile-avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff4b8a, #ff7a5c);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 18px;
      flex-shrink: 0;
    }
    .hm-profile-avatar span {
      user-select: none;
    }
    .hm-profile-basic h3 {
      margin: 0 0 4px 0;
      font-size: 17px;
    }
    .hm-profile-basic p {
      margin: 0;
      font-size: 13px;
      color: #666;
    }
    .hm-profile-region {
      margin-top: 2px;
    }
    .hm-profile-bind {
      margin-top: 2px;
      font-size: 11px;
      color: #9ca3af;
    }
    .hm-profile-social-block {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px solid #f0f0f0;
    }
    .hm-profile-social-title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }
    .hm-profile-social-title {
      font-size: 14px;
      font-weight: 600;
    }
    .hm-profile-social-sub {
      font-size: 11px;
      color: #999;
    }
    .hm-profile-social-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .hm-profile-social-empty {
      font-size: 12px;
      color: #aaa;
    }
    .hm-social-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      text-decoration: none;
      border: 1px solid #eee;
      background: #fafafa;
      color: #444;
      cursor: pointer;
    }
    .hm-social-chip:hover {
      background: #fff2f7;
    }
    .hm-social-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
    }
    .hm-social-threads .hm-social-icon {
      background: #000;
      color: #fff;
    }
    .hm-social-x .hm-social-icon {
      background: #000;
      color: #fff;
    }
    .hm-social-instagram .hm-social-icon {
      background: #ff5f6d;
      color: #fff;
    }
    .hm-social-facebook .hm-social-icon {
      background: #1877f2;
      color: #fff;
    }
    .hm-social-other .hm-social-icon {
      background: #7b61ff;
      color: #fff;
    }
    .hm-profile-footer {
      margin-top: 12px;
      text-align: right;
    }
    .hm-btn-outline {
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      border: 1px solid #ff7a5c;
      background: #fff;
      color: #ff7a5c;
      cursor: pointer;
    }
    .hm-btn-outline:active {
      transform: scale(0.97);
    }

    /* VIP ç­‰ç´šæ¨™ç±¤ï¼ˆæ”¾åœ¨é ­åƒæ—é‚Šç”¨ï¼‰ */
    .vip-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: 6px;
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      background: linear-gradient(135deg, #fbbf24, #f97316);
      color: #111827;
      font-weight: 700;
    }

    /* æˆ‘çš„ 6 å¼µç…§ç‰‡å€å¡Š */
    .my-album-note {
      font-size: 13px;
      color: #6b7280;
      padding: 6px 16px 0;
    }
    .my-album-grid {
      padding: 12px 16px 12px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    .my-album-item {
      position: relative;
      width: 100%;
      padding-top: 100%;
      border-radius: 14px;
      overflow: hidden;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .my-album-item img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .my-album-slot-label {
      position: absolute;
      bottom: 4px;
      left: 4px;
      right: 4px;
      font-size: 11px;
      color: #f9fafb;
      text-shadow: 0 1px 3px rgba(0,0,0,0.6);
    }
    .my-album-upload-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: none;
      background: rgba(31,41,55,0.9);
      color: #f9fafb;
      cursor: pointer;
    }
    .my-album-lock-overlay {
      position: absolute;
      inset: 0;
      background: rgba(15,23,42,0.82);
      color: #f9fafb;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      text-align: center;
      padding: 6px;
    }
    .my-album-lock-btn {
      margin-top: 6px;
      padding: 4px 10px;
      font-size: 11px;
      border-radius: 999px;
      border: none;
      background: #f97316;
      color: #ffffff;
      cursor: pointer;
    }
    .my-album-vip-demo {
      padding: 0 16px 10px;
      font-size: 12px;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .my-album-vip-demo button {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      cursor: pointer;
    }

    /* å¥½å‹ tab ç´…é» */
    .friend-tab-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 16px;
      padding: 0 6px;
      margin-left: 4px;
      font-size: 11px;
      border-radius: 999px;
      background: #ef4444;
      color: #fff;
    }
  
    /* å¿ƒæƒ…æ—¥è¨˜å»£å ´ */
    .mood-wrapper {
      padding: 10px 12px 80px;
    }
    .mood-top-card {
      padding: 12px 14px;
      margin-bottom: 10px;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }
    .mood-top-main {
      flex: 1;
    }
    .mood-title {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }
    .mood-sub {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.4;
    }
    .mood-top-side {
      text-align: right;
      font-size: 12px;
      color: #6b7280;
      white-space: nowrap;
    }
    .mood-roses-label {
      margin-bottom: 2px;
    }
    .mood-roses-count {
      font-size: 20px;
      font-weight: 700;
      color: #be123c;
    }
    .mood-compose-card {
      margin-top: 2px;
      padding: 10px 14px 12px;
    }
    .mood-compose-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #111827;
    }
    .mood-compose-card textarea {
      width: 100%;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      font-size: 15px;
      resize: vertical;
      min-height: 70px;
      outline: none;
      font-family: inherit;
    }
    .mood-compose-card textarea:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #bfdbfe;
    }
    .mood-compose-options {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      align-items: center;
      font-size: 13px;
      color: #4b5563;
    }
    .mood-compose-options label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .mood-compose-footer {
      margin-top: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 12px;
      color: #6b7280;
    }
    .mood-rose-cost span {
      font-weight: 600;
      color: #be123c;
    }
    .mood-list-section {
      margin-top: 12px;
    }
    .mood-list {
      padding: 8px 0 40px;
    }
    .mood-item {
      margin: 0 0 8px;
      padding: 10px 14px 10px;
      border-radius: 16px;
      border: 0.5px solid #e5e7eb;
      background: #ffffff;
      box-shadow: 0 1px 2px rgba(15,23,42,0.03);
    }
    .mood-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 4px;
    }
    .mood-item-author {
      flex: 1;
      min-width: 0;
    }
    .mood-item-author-name {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
    }
    .mood-item-meta {
      margin-top: 2px;
      font-size: 11px;
      color: #9ca3af;
    }
    .mood-item-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      white-space: nowrap;
    }
    .mood-item-content {
      font-size: 14px;
      color: #374151;
      line-height: 1.5;
      margin-top: 4px;
      word-break: break-word;
    }
    .mood-item-actions {
      margin-top: 6px;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      font-size: 12px;
    }
    .mood-item-reply-btn {
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 3px 10px;
      background: #f9fafb;
      cursor: pointer;
    }
    .mood-item-reply-btn:active {
      transform: scale(0.97);
    }
    .mood-item-reply-count {
      font-size: 11px;
      color: #9ca3af;
    }
    .empty-hint {
      padding: 10px 16px 40px;
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
    }
    @media (min-width: 768px) {
      .mood-wrapper {
        max-width: 480px;
        margin: 0 auto;
      }
    }
</style>
</head>
<body>
<!-- é ‚éƒ¨ -->
<div class="top-bar">
<div class="top-bar-inner">
<div class="top-title" id="topTitle">äººå€‘ Â· å¿ƒé‡ XinYou</div>
<div class="top-right" id="topRightSlot"></div>
</div>
</div>
<!-- äººå€‘é  -->
<div class="page active" id="page-people">
<div class="people-wrapper">
<div class="people-grid" id="peopleGrid"></div>
<div class="pager">
<button class="pager-btn" id="nextBatchBtn">æ›ä¸€æ‰¹çœ‹çœ‹ âœ</button>
</div>
</div>
</div>
<!-- è©³ç´°æª”æ¡ˆé  -->
<div class="page" id="page-profileDetail">
<div id="profileDetailContent"></div>
</div>
<!-- å¥½å‹é  -->
<div class="page" id="page-friends">
<div class="tabs-row">
<div class="tab-btn active" data-friendtab="friends">å¥½å‹</div>
<div class="tab-btn" data-friendtab="sent">é€å‡ºç”³è«‹</div>
<div class="tab-btn" data-friendtab="received">æ”¶åˆ°ç”³è«‹</div>
</div>
<ul class="list" id="friendsList"></ul>
</div>

<!-- å¿ƒæƒ…å»£å ´é  -->
<div class="page" id="page-mood">
  <div class="mood-wrapper">
    <div class="card mood-top-card">
      <div class="mood-top-main">
        <div class="mood-title">å¿ƒæƒ…æ—¥è¨˜å»£å ´</div>
        <div class="mood-sub">
          åŒ¿åæˆ–é¡¯ç¤ºæš±ç¨±ï¼Œåˆ†äº«ä»Šå¤©çš„å¿ƒæƒ…ã€‚<br/>
          ç™¼ä½ˆè²¼æ–‡æœƒæ¶ˆè€—ä¸€æŸç«ç‘°èŠ±æŸï¼ˆDemoï¼šä¹‹å¾Œæœƒæ¥æ¯æ—¥ç°½åˆ°èˆ‡å„²å€¼æ©Ÿåˆ¶ï¼‰ã€‚
        </div>
      </div>
      <div class="mood-top-side">
        <div class="mood-roses-label">å¯ç”¨ç«ç‘°èŠ±æŸ</div>
        <div class="mood-roses-count" id="moodRoseCount">0</div>
        <button class="hm-btn-outline" type="button" id="btnMoodRules">èªªæ˜</button>
      </div>
    </div>

    <div class="card mood-compose-card">
      <div class="mood-compose-title">ç™¼ä½ˆä»Šå¤©çš„å¿ƒæƒ…</div>
      <textarea id="moodContentInput" placeholder="ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼äº‹ï¼Ÿå¯«å¹¾å¥è®“äººç†è§£ä½ å¿ƒæƒ…çš„è©±å§ã€‚"></textarea>
      <div class="mood-compose-options">
        <label>
          <input type="checkbox" id="moodAllowReplies" checked/>
          å…è¨±åˆ¥äººå›è¦†é€™å‰‡è²¼æ–‡
        </label>
        <label>
          <input type="radio" name="moodIdentity" value="anon" checked/>
          åŒ¿åç™¼ä½ˆ
        </label>
        <label>
          <input type="radio" name="moodIdentity" value="public"/>
          é¡¯ç¤ºæˆ‘çš„æš±ç¨±
        </label>
      </div>
      <div class="mood-compose-footer">
        <div class="mood-rose-cost">æ¯æ¬¡ç™¼ä½ˆæœƒæ¶ˆè€— <span>1</span> æŸç«ç‘°èŠ±æŸ</div>
        <button class="btn btn-primary btn-sm" type="button" id="btnPostMood">ç™¼ä½ˆ</button>
      </div>
    </div>

    <div class="mood-list-section">
      <div class="section-title">æœ€æ–°å¿ƒæƒ…</div>
      <div id="moodList" class="mood-list"></div>
      <div id="moodEmptyHint" class="empty-hint">ç›®å‰é‚„æ²’æœ‰ä»»ä½•è²¼æ–‡ï¼Œè©¦è‘—æˆç‚ºç¬¬ä¸€å€‹åˆ†äº«å¿ƒæƒ…çš„äººå§ã€‚</div>
    </div>
  </div>
</div>
<!-- æ’è¡Œæ¦œé  -->
<div class="page" id="page-rank">
<div class="rank-tabs">
<div class="rank-tab active" data-ranktab="pop">äººæ°£æ¦œ</div>
<div class="rank-tab" data-ranktab="receive">æ”¶ç¦®æ¦œ</div>
<div class="rank-tab" data-ranktab="send">é€ç¦®æ¦œ</div>
</div>
<div class="rank-wrapper">
<div class="card rank-pyramid-card" id="rankPyramid"></div>
<div class="rank-list" id="rankList"></div>
<div class="rank-note">
       æ’è¡Œæ¦œç›®å‰ç‚ºç¤ºæ„ç‰ˆã€‚æ­£å¼ç‰ˆæœƒä¾ç…§èŠå¤©é‡ã€ç¦®ç‰©ã€äº’å‹•åˆ†æ•¸è¨ˆç®—ã€‚<br/>
       No.1 å¯è‡ªç”±é¸æ“‡é¡¯ç¤ºã€ŒKingã€æˆ–ã€ŒQueenã€ã€‚
     </div>
</div>
</div>
<!-- èŠå¤©é  -->
<div class="page" id="page-chat">
<div class="section chat-list-section">
<div class="section-title">èŠå¤©åˆ—è¡¨</div>
<ul class="list" id="chatThreadList"></ul>
</div>
<!-- å³å´æ»‘å…¥çš„èŠå¤©å®¤è¦–çª— -->
<div class="chat-panel" id="chatPanel">
<div class="chat-panel-header">
<button class="chat-back-btn" id="chatBackBtn">â†</button>
<div>
<div class="chat-panel-title" id="chatPanelTitle">èŠå¤©</div>
<div class="chat-panel-subtitle" id="chatPanelSubtitle"></div>
</div>
</div>
<div class="chat-panel-body">
<div class="chat-theme-bar">
<div class="chat-theme-pill active" data-theme="light">æ·ºè‰²</div>
<div class="chat-theme-pill" data-theme="pink">æ·¡ç²‰</div>
<div class="chat-theme-pill" data-theme="blue">æ·¡è—</div>
<div class="chat-theme-pill" data-theme="dark">æ·±è‰²</div>
</div>
<div class="chat-wrapper chat-theme-light" id="chatWrapper">
<div class="chat-messages" id="chatMessages">
<div class="bubble-row">
<div class="bubble them">
               è«‹å…ˆå¾å·¦å´ã€ŒèŠå¤©åˆ—è¡¨ã€é¸æ“‡å®˜æ–¹è¨Šæ¯æˆ–å¥½å‹ï¼Œå†é–‹å§‹å°è©±ã€‚ï¼ˆDemoï¼‰
             </div>
</div>
</div>
<div class="chat-input-area">
<div class="chat-more-menu" id="chatMoreMenu">
<button class="chat-more-btn" data-type="sticker">ğŸ˜Š è²¼åœ–</button>
<button class="chat-more-btn" id="chatPhotoBtn">ğŸ–¼ ç…§ç‰‡</button>
<button class="chat-more-btn" id="chatGifBtn">GIF å‹•åœ–</button>
</div>
<div class="chat-sticker-bar" id="stickerBar">
<button class="sticker-btn">ğŸ˜Š</button>
<button class="sticker-btn">ğŸ˜‚</button>
<button class="sticker-btn">ğŸ¥º</button>
<button class="sticker-btn">â¤ï¸</button>
<button class="sticker-btn">ğŸ‘</button>
<button class="sticker-btn">ğŸ”¥</button>
</div>
<div class="chat-input-bar">
<button class="chat-plus-btn" id="chatPlusBtn">ï¼‹</button>
<input class="chat-input" id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯..."/>
<button class="chat-send-btn" id="chatSendBtn">å‚³é€</button>
</div>
<input accept="image/*" id="chatPhotoInput" style="display:none" type="file"/><div class="photo-preview" style="display:flex;flex-wrap:wrap;gap:8px;padding:10px 0;"></div>
<input accept="image/gif,image/*,video/*" id="chatGifInput" style="display:none" type="file"/>
</div>
</div>
</div>
</div>
</div>
<!-- æˆ‘çš„é  -->
<div class="page" id="page-me">
<div class="profile-header">
<div class="profile-row-main">
<div class="profile-avatar">
<img alt="æˆ‘çš„é ­åƒ" id="myAvatarImage" onclick="document.getElementById('myAvatarFileInput').click();" src="https://picsum.photos/200/200?random=99" style="cursor:pointer;"/>
<input accept="image/*" id="myAvatarFileInput" onchange="hmHandleAvatarFile(this)" style="display:none;" type="file"/>
</div>
<div class="profile-main">
<div class="profile-name-row">
<div class="profile-name">
<span id="myProfileName">æœªè¨­å®šå§“å</span>
<span class="vip-badge" id="myVipBadge" style="display:none;"></span>
</div>
<div class="profile-status-inline">
<span class="status-badge" id="myStatusBadge">
<span class="status-dot"></span><span id="myStatusText">å·²ä¸Šç·š</span>
</span>
</div>
</div>
<div class="profile-sub" id="myProfileSub">å°ç£ Â· å°šæœªå¡«å¯«å±…ä½å€åŸŸèˆ‡èº«é«˜é«”é‡</div>
<div class="profile-status-edit">
<label for="statusSelect" style="font-size:14px; margin-right:4px;">ç‹€æ…‹ï¼š</label>
<select id="statusSelect">
<option value="online">å·²ä¸Šç·š</option>
<option value="busy">å¿™ç¢Œä¸­â€¦</option>
<option value="eating">ç”¨é¤å»â€¦</option>
<option value="shower">æ´—æ¾¡ä¸­â€¦</option>
<option value="away">æš«é›¢ä¸­â€¦</option>
<option value="offline">é›¢ç·šä¸­</option>
<option value="chatty">æƒ³èŠå¤©</option>
</select>
</div>
</div>
</div>
</div>
<!-- HeartMeet æˆ‘çš„è³‡æ–™å¡ç‰‡ï¼ˆé€£å‹•å½ˆè·³è¦–çª—è³‡æ–™ï¼‰ -->
<section id="hm-profile-section">
<div class="hm-profile-card">
<div class="hm-profile-header">
<div class="hm-profile-avatar">
<span id="hm-profile-avatar-text">Me</span>
</div>
<div class="hm-profile-basic">
<h3 id="hm-profile-name">æœªè¨­å®šå§“å</h3>
<p id="hm-profile-meta">èº«é«˜ / é«”é‡ æœªå¡«å¯«</p>
<p class="hm-profile-region" id="hm-profile-region">å±…ä½å€åŸŸï¼šæœªå¡«å¯«</p>
<p class="hm-profile-bind" id="hm-profile-bind">å°šæœªç¶å®šå¸³è™Ÿ</p>
</div>
</div>
<div class="hm-profile-social-block">
<div class="hm-profile-social-title-row">
<span class="hm-profile-social-title">ç¤¾ç¾¤ä¸²è¯</span>
<span class="hm-profile-social-sub">å¤šå¹³å°é€£çµï¼Œå¢åŠ çœŸå¯¦æ„Ÿ</span>
</div>
<div class="hm-profile-social-list" id="hm-profile-social-list">
<span class="hm-profile-social-empty">ç›®å‰å°šæœªä¸²è¯ä»»ä½•ç¤¾ç¾¤å¸³è™Ÿ</span>
</div>
</div>
<div class="hm-profile-footer">
<button class="hm-btn-outline" id="hm-profile-edit-btn">
           ç·¨è¼¯åŸºæœ¬è³‡æ–™ / ç¤¾ç¾¤ä¸²è¯
         </button>
</div>
</div>
</section>
<!-- æˆ‘çš„ 6 å¼µç…§ç‰‡å€ -->
<div class="section">
<div class="section-title">æˆ‘çš„ç…§ç‰‡ï¼ˆæœ€å¤š 6 å¼µï¼Œç¤ºæ„ï¼‰</div>
<div class="my-album-note">
       å‰ 2 å¼µç‚ºå…è²»é è¦½ï¼Œå¾Œ 4 å¼µéœ€è§€çœ‹ä¸€æ¬¡å»£å‘Šæš«æ™‚è§£é–ï¼›æˆç‚º VIP1ï½VIP5 å¾Œï¼Œ6 å¼µå°‡å…¨éƒ¨æ°¸ä¹…é–‹æ”¾ï¼ˆDemo æ¨¡å¼ç”¨æŒ‰éˆ•åˆ‡æ› VIP ç­‰ç´šï¼‰ã€‚
     </div>
<div class="my-album-grid" id="myAlbumGrid"></div>
<div class="my-album-vip-demo">
<span id="vipLevelText">ç›®å‰ VIP ç­‰ç´šï¼šç„¡ï¼ˆDemoï¼‰</span>
<button id="vipLevelToggleBtn" type="button">åˆ‡æ› VIP ç­‰ç´šï¼ˆ0â†’5 å¾ªç’°ï¼‰</button>
</div>
</div>
<div class="section">
<div class="section-title">å¥½å‹é™å®šçš„å°èªï¼ˆåªæœ‰å¥½å‹çœ‹å¾—åˆ°ï¼‰</div>
<div class="diary-list">
<div class="diary-item">
<div style="font-size:16px; margin-bottom:4px;">
           åœ¨é€™è£¡å¯«ä¸€äº›æ¯”è¼ƒç§äººçš„å¿ƒæƒ…ï¼Œåªè®“å¥½å‹çœ‹å¾—åˆ°ã€‚
         </div>
<textarea id="friendNoteInput">ä»Šå¤©å¥½é›£éï¼Œå¸Œæœ›èƒ½æœ‰å¥½å¤©æ°£å‡ºç¾ã€‚</textarea>
<div style="margin-top:8px; font-size:14px; color:#9ca3af;">
           å¥½å‹åˆ—è¡¨é¡¯ç¤ºé è¦½ï¼š
         </div>
<div class="item-row3" id="friendNotePreview" style="margin-top:4px;">
<span class="label">å¥½å‹é™å®šï¼š</span>ä»Šå¤©å¥½é›£éï¼Œå¸Œæœ›èƒ½æœ‰å¥½å¤©æ°£å‡ºç¾ã€‚
         </div>
</div>
</div>
</div>
<div class="section">
<div class="section-title">èª°ä¾†çœ‹éæˆ‘ï¼ˆæœ€è¿‘è¶³è·¡ç¤ºæ„ï¼‰</div>
<div class="footprint-list">
<div class="footprint-item">
<div class="footprint-avatar">
<img alt="footprint1" src="https://picsum.photos/200/200?random=301"/>
</div>
<div class="footprint-main">
<div class="footprint-name">å°èŒµ</div>
<div class="footprint-sub">ä¾†è‡ª å°åŒ— Â· 2 å°æ™‚å‰ä¾†çœ‹éä½ </div>
</div>
</div>
<div class="footprint-item">
<div class="footprint-avatar">
<img alt="footprint2" src="https://picsum.photos/200/200?random=302"/>
</div>
<div class="footprint-main">
<div class="footprint-name">Ken</div>
<div class="footprint-sub">ä¾†è‡ª é«˜é›„ Â· æ˜¨å¤©æ™šä¸Šè·¯éä½ çš„æª”æ¡ˆ</div>
</div>
</div>
<div class="footprint-item">
<div class="footprint-avatar">
<img alt="footprint3" src="https://picsum.photos/200/200?random=303"/>
</div>
<div class="footprint-main">
<div class="footprint-name">Rin</div>
<div class="footprint-sub">ä¾†è‡ª æ–°åŒ— Â· 3 å¤©å‰æ‹œè¨ª</div>
</div>
</div>
<div class="my-section-note">
         æ­£å¼ç‰ˆå¯ä»¥æŠŠé€™è£¡åšæˆ VIP æ‰èƒ½çœ‹å®Œæ•´åå–®ï¼æ™‚é–“çš„åŠŸèƒ½ã€‚
       </div>
</div>
</div>
<div class="section">
<div class="section-title">æˆ‘çš„æ—¥è¨˜ï¼ˆå…è²» 5 å‰‡ï¼ŒVIP å¯è‡³ 30 å‰‡ï¼‰</div>
<div class="diary-list" id="myDiaryList"></div>
<div class="diary-list">
<div class="diary-item">
<div id="myDiaryLimitText" style="font-size:14px; color:#6b7280; margin-bottom:6px;">
           å…è²»ç”¨æˆ¶å¯å»ºç«‹ 5 å‰‡ä»£è¡¨æ—¥è¨˜ï¼›å‡ç´š VIP å¾Œå¯æ“´å……åˆ° 30 å‰‡ã€‚é€™äº›æ—¥è¨˜æœƒæˆç‚ºä½ å°å¤–å±•ç¤ºçš„é‡é»è³‡æ–™ã€‚ï¼ˆDemoï¼‰
         </div>
<textarea id="myDiaryInput" placeholder="å¯«ä¸€å‰‡æƒ³è®“åˆ¥äººçœ‹åˆ°çš„å¿ƒæƒ…æ—¥è¨˜..."></textarea>
<div style="margin-top:6px; display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
<input accept="image/*" id="myDiaryImageUpload" style="display:none;" type="file"/>
<input accept="image/*" capture="environment" id="myDiaryImageCamera" style="display:none;" type="file"/>
<button class="hm-btn-outline" id="myDiaryImageUploadBtn" type="button">ä¸Šå‚³ç…§ç‰‡</button>
<button class="hm-btn-outline" id="myDiaryImageCameraBtn" type="button">æ‹ç…§</button>
<div style="display:flex; align-items:center; gap:4px;">
<input id="myDiaryImageSize" max="100" min="40" style="width:120px;" type="range" value="80"/>
<span id="myDiaryImageSizeText" style="font-size:12px; color:#6b7280;">ç…§ç‰‡å¤§å°ï¼š80%</span>
</div>
<button class="hm-btn-outline" id="myDiaryAddBtn" type="button">æ–°å¢æ—¥è¨˜</button>
</div>
<div id="myDiaryImagePreview" style="margin-top:8px; display:none;">
  <div style="font-size:12px; color:#6b7280; margin-bottom:4px;">åœ–ç‰‡é è¦½ï¼ˆåƒ…æœ¬æ©Ÿé¡¯ç¤ºï¼Œä¸æœƒä¸Šå‚³åˆ°ä¼ºæœå™¨ï¼‰ï¼š</div>
  <img id="myDiaryImagePreviewImg" alt="æ—¥è¨˜åœ–ç‰‡é è¦½" style="max-width:100%; border-radius:12px; display:block;"/>
</div>
</div>
</div>
</div>
<!-- å¸³è™Ÿèˆ‡å®‰å…¨ï¼šå·²ç§»åˆ°æœ€åº•éƒ¨ -->
<div class="section">
<div class="section-title">æœå°‹èˆ‡é€šçŸ¥è¨­å®šï¼ˆç¤ºæ„ï¼‰</div>
<div class="form-list">
<div class="form-row">
<div class="form-label">åœ‹å®¶ / åœ°å€</div>
<div class="form-value">å°ç£ Â· å…¨éƒ¨åœ°å€ &gt;</div>
</div>
<div class="form-row">
<div class="form-label">æ¥å—å¥½å‹ç”³è«‹</div>
<div class="toggle on"><div class="toggle-knob"></div></div>
</div>
<div class="form-row">
<div class="form-label">èŠå¤©é€šçŸ¥</div>
<div class="toggle on"><div class="toggle-knob"></div></div>
</div>
</div>
<div class="my-section-note">
       é€™è£¡ä¹‹å¾Œå¯ä»¥é€£åˆ°çœŸæ­£çš„è¨­å®šé ï¼Œè®“ç”¨æˆ¶ç´°èª¿é€šçŸ¥ã€æœå°‹æ¢ä»¶ç­‰ã€‚
     </div>
</div>
<div class="section">
<div class="section-title">å¸³è™Ÿèˆ‡å®‰å…¨</div>
<div class="diary-list">
<div class="diary-item">
<div style="font-size:16px; margin-bottom:6px;">
           è‹¥ä½ æ˜¯åœ¨ä»–äººè£ç½®ä¸Šä½¿ç”¨ï¼Œå»ºè­°é›¢é–‹å‰å…ˆç™»å‡ºï¼Œä»¥å…å€‹äººè³‡æ–™è¢«ä»–äººæŸ¥çœ‹ã€‚
         </div>
<button class="hm-btn-outline" id="hm-logout-btn" type="button">
           ç™»å‡ºç›®å‰å¸³è™Ÿï¼ˆæ¸…é™¤æœ¬æ©Ÿæš«å­˜è³‡æ–™ï¼‰
         </button>
<div style="margin-top:8px; font-size:13px; color:#9ca3af;">
           Demoï¼šç™»å‡ºæœƒæ¸…é™¤æœ¬æ©Ÿçš„ç¶å®šè³‡è¨Šã€åŸºæœ¬è³‡æ–™èˆ‡ç›¸ç°¿æš«å­˜ï¼Œä¸‹æ¬¡é€²å…¥æ™‚æœƒé‡æ–°è·³å‡ºç¶å®šèˆ‡å¡«å¯«è³‡æ–™çš„è¦–çª—ã€‚
         </div>
</div>
</div>
</div>
</div>

<!-- åº•éƒ¨å°èˆª -->
<div class="bottom-nav">
  <div class="nav-item active" data-page="people">
    <div class="nav-item-inner">
      <div class="nav-icon">äºº</div>
      <span>å·§é‡</span>
    </div>
  </div>
  <div class="nav-item" data-page="friends">
    <div class="nav-item-inner">
      <div class="nav-icon">å‹</div>
      <span>å¥½å‹</span>
    </div>
  </div>
  <div class="nav-item" data-page="mood">
    <div class="nav-item-inner">
      <div class="nav-icon">å¿ƒ</div>
      <span>å¿ƒæƒ…</span>
    </div>
  </div>
  <div class="nav-item" data-page="rank" style="display:none;">
    <div class="nav-item-inner">
      <div class="nav-icon">å† </div>
      <span>æ’è¡Œæ¦œ</span>
    </div>
  </div>
  <div class="nav-item" data-page="chat">
    <div class="nav-item-inner">
      <div class="nav-icon">èŠ</div>
      <span>èŠå¤©</span>
    </div>
  </div>
  <div class="nav-item" data-page="me">
    <div class="nav-item-inner">
      <div class="nav-icon">æˆ‘</div>
      <span>æˆ‘çš„</span>
    </div>
  </div>
</div>


<div>

</div>
<p class="hm-privacy-text">
       â€» Demo ç‰ˆæœ¬ä¸æœƒçœŸçš„é€£åˆ° Google / Facebook / Appleï¼Œåƒ…æ¨¡æ“¬ç¶å®šæµç¨‹ã€‚
     </p>
</div>
</div>
<!-- åŸºæœ¬è³‡æ–™å½ˆè·³è¦–çª—ï¼šHeartMeet Profile Modal -->
<div class="hm-modal-backdrop" id="hm-profile-modal">
<div class="hm-modal">
<div class="hm-modal-header">
<h2>å®ŒæˆåŸºæœ¬è³‡æ–™ï¼Œé–‹å§‹é…å°</h2>
<p>ç›®å‰åƒ…æ”¯æ´e mailç™»å…¥ã€‚</p>
</div>
<form id="hm-profile-form">
<div class="hm-form-group">
<label for="hm-name">* <span class="hm-required">*</span>ç¨±å‘¼ï¼ˆæš±ç¨±ï¼‰</label>
<input id="hm-name" name="name" placeholder="çµ¦è‡ªå·±ä¸€å€‹å¥½è¨˜çš„ç¨±å‘¼" required="" type="text"/>
</div>
<div class="hm-form-group hm-inline">
<div>
<label for="hm-height">* <span class="hm-required">*</span>èº«é«˜ (cm)</label>
<input id="hm-height" max="230" min="120" name="height" placeholder="ä¾‹å¦‚ï¼š172" required="" type="number"/>
</div>
   <!-- å…¨è¢å¹• Viewer -->
<div class="photo-viewer" id="photoViewer">
<img alt="photo" src=""/>
<div class="photo-viewer-close" onclick="closeViewer()">âœ•</div>
</div>
<!-- ç™»å…¥ç¶å®š Modal -->

<div>
<label for="hm-weight">* <span class="hm-required">*</span>é«”é‡ (kg)</label>
<input id="hm-weight" max="200" min="35" name="weight" placeholder="ä¾‹å¦‚ï¼š65" required="" type="number"/>
</div>
</div>
<div class="hm-form-group">
<label for="hm-region">å±…ä½å€åŸŸï¼ˆå¯ç¨å¾Œå†å¡«ï¼‰</label>
<input id="hm-region" name="region" placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚ ä¿¡ç¾©å€ / èŠ±è“®ç¸£ ç‘ç©—é„‰" type="text"/>
</div>
<div class="hm-form-group">
<label>ç¤¾ç¾¤å¸³è™Ÿä¸²è¯ï¼ˆå¯é¸å¡«ï¼Œå¢åŠ ä¿¡ä»»æ„Ÿï¼‰</label>
<p class="hm-help-text">
           Threads / X / IG / FB çš†å¯å…ˆç•¥éï¼Œä¹‹å¾Œä¹Ÿå¯ä»¥åœ¨ã€Œæˆ‘çš„è³‡æ–™ã€ä¸­å†è£œä¸Šæˆ–ä¿®æ”¹ç¤¾ç¾¤å¸³è™Ÿã€‚
         </p>
<div class="hm-social-row">
<span class="hm-social-label">Threads</span>
<input id="hm-threads" name="threads" placeholder="è²¼ä¸Š Threads å€‹äººé é€£çµæˆ–å¸³è™Ÿï¼ˆé¸å¡«ï¼‰" type="text"/>
</div>
<div class="hm-social-row">
<span class="hm-social-label">X (Twitter)</span>
<input id="hm-x" name="x" placeholder="è²¼ä¸Š X å€‹äººé é€£çµæˆ–å¸³è™Ÿï¼ˆé¸å¡«ï¼‰" type="text"/>
</div>
<div class="hm-social-row">
<span class="hm-social-label">Instagram</span>
<input id="hm-instagram" name="instagram" placeholder="è²¼ä¸Š IG å€‹äººé é€£çµæˆ–å¸³è™Ÿï¼ˆé¸å¡«ï¼‰" type="text"/>
</div>
<div class="hm-social-row">
<span class="hm-social-label">Facebook</span>
<input id="hm-facebook" name="facebook" placeholder="è²¼ä¸Š FB å€‹äººé é€£çµæˆ–å¸³è™Ÿï¼ˆé¸å¡«ï¼‰" type="text"/>
</div>
<div class="hm-social-row">
<span class="hm-social-label">å…¶ä»–</span>
<input id="hm-other" name="other" placeholder="ä¾‹å¦‚ï¼šLINE ID / å®˜æ–¹ç¶²ç«™ / YouTube é »é“ï¼ˆé¸å¡«ï¼‰" type="text"/>
</div>
</div>
<div class="hm-form-group hm-checkbox-group">
<label>
<input id="hm-agree" required="" type="checkbox"/>
           æˆ‘å·²é–±è®€ä¸¦åŒæ„ HeartMeet çš„æœå‹™æ¢æ¬¾èˆ‡éš±ç§æ”¿ç­–
         </label>
</div>
<div class="hm-modal-footer">
<button class="hm-btn-primary" type="submit">å®Œæˆä¸¦é–‹å§‹ä½¿ç”¨</button>
</div>
<p class="hm-privacy-text">
         â€» éƒ¨åˆ†è³‡æ–™åªç”¨æ–¼ç³»çµ±é…å°èˆ‡å¯¦åæ„Ÿé©—è­‰ï¼Œä¸æœƒå…¬é–‹é¡¯ç¤ºæ‚¨çš„çœŸå¯¦å§“åã€‚
       </p>
</form>
</div>
</div>
<script>
  // === Supabase defaults (prefill localStorage if missing) ===
  // NOTE: anon key is designed to be public. Do NOT use service_role key on client.
  try {
    if (!localStorage.getItem("SB_URL")) localStorage.setItem("SB_URL", "https://eqtvoxcavjgronfmalfw.supabase.co");
    if (!localStorage.getItem("SB_ANON_KEY")) localStorage.setItem("SB_ANON_KEY", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVxdHZveGNhdmpncm9uZm1hbGZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1OTMzMzQsImV4cCI6MjA4MTE2OTMzNH0.974KqoueFlUJ9V2F-hzFznxGhxvr0mK6ujlT1yauxGk");
  } catch (e) {
    console.warn("localStorage not available", e);
  }

  // ==== å‡è³‡æ–™ï¼šäººå€‘ ====
  const people = [
    {
      id: 1,
      name: "ã‚Šã‚“ã‚Šã‚“",
      ageText: "20 æ­²å¾ŒåŠ",
      desc: "æ—¥èªã€ä¸­åœ‹èªå¯â˜…",
      avatar: "https://picsum.photos/300/400?random=1",
      status: "online",
      statusText: "å·²ä¸Šç·š",
      vipLevel: 3,
      album: [
        "https://picsum.photos/400/400?random=101",
        "https://picsum.photos/400/400?random=102",
        "https://picsum.photos/400/400?random=103",
        "https://picsum.photos/400/400?random=104",
        "https://picsum.photos/400/400?random=105",
        "https://picsum.photos/400/400?random=106"
      ]
    },
    {
      id: 2,
      name: "Meow",
      ageText: "30 æ­²åˆåŠ",
      desc: "å…§æœ‰æƒ¡è²“ã€‚",
      avatar: "https://picsum.photos/300/400?random=2",
      status: "eating",
      statusText: "ç”¨é¤å»â€¦",
      vipLevel: 5,
      album: [
        "https://picsum.photos/400/400?random=201",
        "https://picsum.photos/400/400?random=202",
        "https://picsum.photos/400/400?random=203",
        "https://picsum.photos/400/400?random=204",
        "https://picsum.photos/400/400?random=205",
        "https://picsum.photos/400/400?random=206"
      ]
    },
    {
      id: 3,
      name: "Min",
      ageText: "10 æ­²å¾ŒåŠ",
      desc: "é™¤äº†ç™¼å‘†é‚„æ˜¯ç™¼å‘†ç›´åˆ°è®Šå‘†ã€‚",
      avatar: "httpsum.photos/300/400?random=3".replace("httpsum","https://pics"),
      status: "away",
      statusText: "æš«é›¢ä¸­â€¦",
      vipLevel: 1,
      album: [
        "https://picsum.photos/400/400?random=301",
        "https://picsum.photos/400/400?random=302",
        "https://picsum.photos/400/400?random=303",
        "https://picsum.photos/400/400?random=304",
        "https://picsum.photos/400/400?random=305",
        "https://picsum.photos/400/400?random=306"
      ]
    },
    {
      id: 4,
      name: "å½±å¯’",
      ageText: "30 æ­²åˆåŠ",
      desc: "å€šæ¬„è½é¢¨é›¨ï¼Œæ·¡çœ‹æ±Ÿæ¹–è·¯ã€‚",
      avatar: "https://picsum.photos/300/400?random=4",
      status: "online",
      statusText: "æƒ³èŠå¤©",
      vipLevel: 2,
      album: [
        "https://picsum.photos/400/400?random=401",
        "https://picsum.photos/400/400?random=402",
        "https://picsum.photos/400/400?random=403",
        "https://picsum.photos/400/400?random=404",
        "https://picsum.photos/400/400?random=405",
        "https://picsum.photos/400/400?random=406"
      ]
    },
    {
      id: 5,
      name: "é˜¿åˆ",
      ageText: "20 æ­²åˆåŠ",
      desc: "å–œæ­¡éœ²ç‡Ÿã€æ‹ç…§ã€çœ‹æ˜Ÿæ˜Ÿã€‚",
      avatar: "https://picsum.photos/300/400?random=5",
      status: "busy",
      statusText: "å¿™ç¢Œä¸­â€¦",
      vipLevel: 4,
      album: [
        "https://picsum.photos/400/400?random=501",
        "https://picsum.photos/400/400?random=502",
        "https://picsum.photos/400/400?random=503",
        "https://picsum.photos/400/400?random=504",
        "https://picsum.photos/400/400?random=505",
        "https://picsum.photos/400/400?random=506"
      ]
    },
    {
      id: 6,
      name: "å°è·¯",
      ageText: "30 æ­²å¾ŒåŠ",
      desc: "èµ°åœ¨è·¯ä¸Šéš¨ä¾¿äº‚æƒ³äº‹æƒ…ã€‚",
      avatar: "https://picsum.photos/300/400?random=6",
      status: "shower",
      statusText: "æ´—æ¾¡ä¸­â€¦",
      vipLevel: 1,
      album: [
        "https://picsum.photos/400/400?random=601",
        "https://picsum.photos/400/400?random=602",
        "https://picsum.photos/400/400?random=603",
        "https://picsum.photos/400/400?random=604",
        "https://picsum.photos/400/400?random=605",
        "https://picsum.photos/400/400?random=606"
      ]
    },
    {
      id: 7,
      name: "Kimi",
      ageText: "20 æ­²åˆåŠ",
      desc: "å–œæ­¡åˆ°è™•åƒåƒå–å–ã€‚",
      avatar: "https://picsum.photos/300/400?random=7",
      status: "online",
      statusText: "å·²ä¸Šç·š",
      vipLevel: 2,
      album: [
        "https://picsum.photos/400/400?random=701",
        "https://picsum.photos/400/400?random=702",
        "https://picsum.photos/400/400?random=703",
        "https://picsum.photos/400/400?random=704",
        "https://picsum.photos/400/400?random=705",
        "https://picsum.photos/400/400?random=706"
      ]
    },
    {
      id: 8,
      name: "Mori",
      ageText: "40 æ­²å‰å¾Œ",
      desc: "ç†Ÿé½¡äº¤å‹ï¼Œæ…¢æ…¢èŠã€‚",
      avatar: "https://picsum.photos/300/400?random=8",
      status: "away",
      statusText: "é›¢ç·šä¸­",
      vipLevel: 0,
      album: [
        "https://picsum.photos/400/400?random=801",
        "https://picsum.photos/400/400?random=802",
        "https://picsum.photos/400/400?random=803",
        "https://picsum.photos/400/400?random=804",
        "https://picsum.photos/400/400?random=805",
        "https://picsum.photos/400/400?random=806"
      ]
    }

  ];

// ==== äººå€‘è³‡æ–™ä¾†æºï¼ˆDemo / Supabaseï¼‰====
  let hmPeopleMode = "demo";
  let hmPeoplePool = people.slice();
  const hmPeopleCache = new Map(); // id -> person objectï¼ˆä¾› getPersonById ä½¿ç”¨ï¼‰

  function hmNormalizeProfileRow(row) {
    if (!row) return null;
    const id = row.id; // uuid
    const name = row.name || "ï¼ˆæœªå¡«å§“åï¼‰";
    const region = row.region || "";
    const avatar = row.avatar_url || ("https://picsum.photos/300/400?random=" + Math.floor(Math.random() * 9000 + 1000));
    return {
      id,
      name,
      desc: region ? ("å±…ä½åœ°ï¼š" + region) : "",
      avatar,
      status: "online",
      statusText: "å¯èŠå¤©",
      vipLevel: 0,
      album: [] // Supabase V1 æš«ä¸è™•ç†ç›¸ç°¿
    };
  }

  async function hmLoadPeopleFromSupabase() {
    try {
      const cli = await hmGetSupabaseClient();
      if (!cli) return false;

      const sessRes = await cli.auth.getSession();
      const session = sessRes && sessRes.data ? sessRes.data.session : null;
      if (!session || !session.user) return false;

      const uid = session.user.id;

      const q = await cli
        .from("profiles")
        .select("id,name,region,height,weight,avatar_url,updated_at")
        .neq("id", uid)
        .order("updated_at", { ascending: false })
        .limit(80);

      if (q.error) throw q.error;

      const rows = Array.isArray(q.data) ? q.data : [];
      const normalized = rows.map(hmNormalizeProfileRow).filter(Boolean);

      // è‹¥ç›®å‰æ²’æœ‰å…¶ä»–ä½¿ç”¨è€…ï¼Œç¶­æŒ demoï¼ˆé¿å…ç•«é¢å…¨ç©ºï¼‰
      if (normalized.length === 0) return false;

      hmPeopleMode = "supabase";
      hmPeoplePool = normalized;
      hmPeopleCache.clear();
      normalized.forEach(p => hmPeopleCache.set(p.id, p));
      return true;
    } catch (e) {
      console.warn("hmLoadPeopleFromSupabase failed:", e);
      return false;
    }
  }
  // é è¨­ç›¸ç°¿ç…§ç‰‡ï¼ˆç•¶ä½¿ç”¨è€…å°šæœªè‡ªå·±ä¸Šå‚³æ™‚ï¼Œç•¶ä½œåº•åœ–ï¼‰
  const albumPhotos = [
    "https://picsum.photos/400/400?random=901",
    "https://picsum.photos/400/400?random=902",
    "https://picsum.photos/400/400?random=903",
    "https://picsum.photos/400/400?random=904",
    "https://picsum.photos/400/400?random=905",
    "https://picsum.photos/400/400?random=906"
  ];

  const peopleGridEl = document.getElementById("peopleGrid");
  const nextBatchBtn = document.getElementById("nextBatchBtn");
  const profileDetailContent = document.getElementById("profileDetailContent");
  const topTitleEl = document.getElementById("topTitle");
  const topRightSlot = document.getElementById("topRightSlot");

  let currentBatch = [];
  let currentProfileId = null; // ç›®å‰æ­£åœ¨æŸ¥çœ‹çš„æª”æ¡ˆ idï¼ˆçµ¦ç›¸ç°¿è§£é–å¾Œé‡åˆ·ç”¨ï¼‰

  // å°é–åå–®ï¼ˆç¤ºæ„ï¼Œåƒ…å„²å­˜åœ¨å‰ç«¯ï¼‰
  let blockedIds = [];

  function hmIsBlocked(id) {
    return blockedIds.includes(id);
  }

  function shuffleArray(arr) {
    const copy = arr.slice();
    for (let i = copy.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [copy[i], copy[j]] = [copy[j], copy[i]];
    }
    return copy;
  }

  function pickRandomBatch() {
    const pool = (hmPeoplePool && hmPeoplePool.length) ? hmPeoplePool : people;
    const available = pool.filter(p => !hmIsBlocked(p.id));
    const shuffled = shuffleArray(available);
    currentBatch = shuffled.slice(0, 4);
  }

  function renderPeopleGrid() {
    if (currentBatch.length === 0 || currentBatch.every(p => hmIsBlocked(p.id))) {
      pickRandomBatch();
    }
    peopleGridEl.innerHTML = "";
    const visibleBatch = currentBatch.filter(p => !hmIsBlocked(p.id));
    currentBatch = visibleBatch;
    currentBatch.forEach(p => {
      const card = document.createElement("div");
      card.className = "people-card";
      card.onclick = () => openProfileDetail(p.id);

      const photo = document.createElement("div");
      photo.className = "people-photo";
      photo.innerHTML = '<img src="' + p.avatar + '" alt="' + p.name + '" />';

      const info = document.createElement("div");
      info.className = "people-info";

      const row1 = document.createElement("div");
      row1.className = "people-name-row";

      const nameEl = document.createElement("div");
      nameEl.className = "people-name";
      nameEl.textContent = p.name;

      const ageEl = document.createElement("div");
      ageEl.className = "people-age";
      ageEl.textContent = p.ageText;

      row1.appendChild(nameEl);
      row1.appendChild(ageEl);

      let statusClass = "status-badge";
      if (p.status === "busy") statusClass += " status-busy";
      if (p.status === "away" || p.status === "offline") statusClass += " status-away";
      if (p.status === "eating") statusClass += " status-eating";
      if (p.status === "shower") statusClass += " status-shower";

      const statusDiv = document.createElement("span");
      statusDiv.className = statusClass;
      statusDiv.innerHTML = '<span class="status-dot"></span><span>' + (p.statusText || "å·²ä¸Šç·š") + '</span>';

      const desc = document.createElement("div");
      desc.className = "people-desc";
      desc.textContent = p.desc;

      info.appendChild(row1);
      info.appendChild(statusDiv);
      info.appendChild(desc);

      card.appendChild(photo);
      card.appendChild(info);

      peopleGridEl.appendChild(card);
    });
  }

  nextBatchBtn.addEventListener("click", () => {
    pickRandomBatch();
    renderPeopleGrid();
  });

  // ===== å¥½å‹ç‹€æ…‹ & é—œä¿‚ =====
  const friendsListEl = document.getElementById("friendsList");

  let friendIds = [];        // å·²æ˜¯å¥½å‹ï¼ˆSupabaseï¼‰
  let sentRequestIds = [];      // ä½ é€å‡ºçš„å¥½å‹ç”³è«‹ï¼ˆSupabaseï¼‰
  let receivedRequestIds = [];  // æ”¶åˆ°çš„å¥½å‹ç”³è«‹ï¼ˆSupabaseï¼‰

  // Supabase å¥½å‹è³‡æ–™å¿«å–ï¼ˆä¾›æ¸…å–®/æŒ‰éˆ•ä½¿ç”¨ï¼‰
  let hmFriendItems = [];      // [{ other_id, profile }]
  let hmSentItems = [];        // [{ request_id, other_id, profile }]
  let hmReceivedItems = [];    // [{ request_id, other_id, profile }]
  let hmReqIdSentByOther = new Map();       // other_id -> request_id
  let hmReqIdReceivedByOther = new Map();   // other_id -> request_id


  // å°é– / æª¢èˆ‰ç›¸é—œï¼ˆç¤ºæ„ï¼‰
  function hmBlockUser(id) {
    if (!blockedIds.includes(id)) {
      blockedIds.push(id);
    }
    // è¢«å°é–æ™‚ï¼Œå¾å¥½å‹èˆ‡ç”³è«‹æ¸…å–®ä¸­ç§»é™¤
    friendIds = friendIds.filter(x => x !== id);
    sentRequestIds = sentRequestIds.filter(x => x !== id);
    receivedRequestIds = receivedRequestIds.filter(x => x !== id);

    // ç°¡å–®åˆ·æ–°äººå€‘èˆ‡å¥½å‹ç•«é¢ï¼ˆç¤ºæ„ï¼‰
    if (typeof renderPeopleGrid === "function") {
      currentBatch = [];
      renderPeopleGrid();
    }
    if (typeof renderFriendsPage === "function") {
      renderFriendsPage();
    }
    alert("å·²å°é–æ­¤ç”¨æˆ¶ï¼ˆDemo ç‰ˆåƒ…è¨˜éŒ„åœ¨æœ¬æ©Ÿï¼‰");
  }

  function hmReportUser(id) {
    const p = getPersonById(id);
    alert("å·²é€å‡ºå°ã€Œ" + (p ? p.name : "æ­¤ç”¨æˆ¶") + "ã€çš„èˆ‰å ±ï¼ˆDemo ç¤ºæ„ï¼‰\næ­£å¼ç‰ˆæœƒé€åˆ°å¾Œç«¯å¯©æ ¸ã€‚");
  }

  function hmBlockOrReport(id) {
    const p = getPersonById(id);
    if (!p) return;

    const choice = window.prompt(
      "è«‹é¸æ“‡å‹•ä½œï¼š\n1ï¼šå°é–æ­¤ç”¨æˆ¶\n2ï¼šåƒ…èˆ‰å ±æª¢èˆ‰\n3ï¼šå°é– + èˆ‰å ±\nï¼ˆè¼¸å…¥ 1 / 2 / 3ï¼‰",
      "1"
    );
    if (!choice) return;

    if (choice === "1") {
      hmBlockUser(id);
    } else if (choice === "2") {
      hmReportUser(id);
    } else if (choice === "3") {
      hmBlockUser(id);
      hmReportUser(id);
    } else {
      alert("æœªåŸ·è¡Œä»»ä½•å‹•ä½œã€‚");
      return;
    }

    // Demoï¼šå°é– / æª¢èˆ‰å¾Œå›åˆ°ã€Œäººå€‘ã€é 
    showPage("people");
  }

  let currentFriendTab = "friends";
  let friendTabFriendsEl = null;
  let friendTabSentEl = null;
  let friendTabReceivedEl = null;

  function getPersonById(id) {
    // Supabase æ¨¡å¼ï¼šå„ªå…ˆç”¨å¿«å–
    if (hmPeopleCache && hmPeopleCache.has(id)) return hmPeopleCache.get(id);
    // Demo fallback
    const pool = (hmPeoplePool && hmPeoplePool.length) ? hmPeoplePool : people;
    return pool.find(p => String(p.id) === String(id)) || null;
  }

  function hmGetRelation(id) {
    const key = String(id);
    if (friendIds.map(String).includes(key)) return "friend";
    if (sentRequestIds.map(String).includes(key)) return "sent";
    if (receivedRequestIds.map(String).includes(key)) return "received";
    return "none";
  }

  function createTabBadgeHTML(num) {
    if (!num) return "";
    return '<span class="friend-tab-badge">' + num + '</span>';
  }

  function updateFriendTabCounts() {
    if (!friendTabFriendsEl || !friendTabSentEl || !friendTabReceivedEl) return;
    friendTabFriendsEl.innerHTML = "å¥½å‹" + createTabBadgeHTML(friendIds.length);
    friendTabSentEl.innerHTML = "é€å‡ºç”³è«‹" + createTabBadgeHTML(sentRequestIds.length);
    friendTabReceivedEl.innerHTML = "æ”¶åˆ°ç”³è«‹" + createTabBadgeHTML(receivedRequestIds.length);
  }

  
  // ============================
  // Supabase å¥½å‹ / å°é– / èˆ‰å ±ï¼ˆV1ï¼Œèˆ‡ä½ ç›®å‰è³‡æ–™è¡¨ç›¸å®¹ï¼‰
  //
  // ä½ ç›®å‰ Supabase public schema å·²å­˜åœ¨ï¼š
  // - friend_requestsï¼šid, from_user, to_user, status, created_at
  // - friendsï¼š (è‹¥ä½ å·²å»ºç«‹ä½†æ¬„ä½ä¸åŒï¼Œä¸‹é¢ JS æœƒè‡ªå‹•å˜—è©¦ç›¸å®¹)
  // - blocksï¼šblocker_id, blocked_id, created_at
  // ï¼ˆreports è‹¥å°šæœªå»ºç«‹ï¼Œå¯å…ˆç•¥éï¼›UI ä»å¯é¡¯ç¤ºï¼Œä½†å¯«å…¥æœƒæç¤ºï¼‰
  //
  // å»ºè­° SQLï¼ˆåƒ…ä¾›åƒè€ƒï¼›ä½ è‹¥å·²å»ºç«‹ï¼Œç•¥éå³å¯ï¼‰ï¼š
  //   -- friendsï¼ˆæœ€ç°¡å–®ä¸€å°ä¸€å¥½å‹è¡¨ï¼šæ¯æ®µé—œä¿‚å­˜å…©ç­†ï¼Œæ–¹ä¾¿æŸ¥è©¢ï¼‰
  //   create table if not exists public.friends (
  //     id uuid primary key default gen_random_uuid(),
  //     user_id uuid not null references auth.users(id) on delete cascade,
  //     friend_id uuid not null references auth.users(id) on delete cascade,
  //     created_at timestamptz not null default now(),
  //     unique(user_id, friend_id)
  //   );
  //
  //   -- friend_requestsï¼ˆä½ å·²å­˜åœ¨å‰‡ç•¥éï¼‰
  //   create table if not exists public.friend_requests (
  //     id uuid primary key default gen_random_uuid(),
  //     from_user uuid not null references auth.users(id) on delete cascade,
  //     to_user uuid not null references auth.users(id) on delete cascade,
  //     status text not null default 'pending',
  //     created_at timestamptz not null default now()
  //   );
  //
  //   -- blocksï¼ˆä½ ç›®å‰æ¬„ä½ç‚º blocker_id / blocked_idï¼‰
  //   create table if not exists public.blocks (
  //     blocker_id uuid not null references auth.users(id) on delete cascade,
  //     blocked_id uuid not null references auth.users(id) on delete cascade,
  //     created_at timestamptz not null default now(),
  //     primary key (blocker_id, blocked_id)
  //   );
  //
  //   -- reportsï¼ˆå¯é¸ï¼‰
  //   create table if not exists public.reports (
  //     id uuid primary key default gen_random_uuid(),
  //     reporter_id uuid not null references auth.users(id) on delete cascade,
  //     reported_id uuid not null references auth.users(id) on delete cascade,
  //     reason text not null,
  //     details text,
  //     created_at timestamptz not null default now()
  //   );

  // ====== Schema è‡ªå‹•ç›¸å®¹ï¼ˆé¿å…ä½ è³‡æ–™è¡¨æ¬„ä½å‘½åä¸åŒé€ æˆæ•´é  JS æ›æ‰ï¼‰ ======
  const hmSchema = {
    ready: false,
    friendsTable: "friends",          // æˆ– friendshipsï¼ˆèˆŠç‰ˆï¼‰
    friendsUserCol: "user_id",
    friendsFriendCol: "friend_id",
    frTable: "friend_requests",
    frFromCol: "from_user",
    frToCol: "to_user",
    blocksTable: "blocks",
    blocksFromCol: "blocker_id",
    blocksToCol: "blocked_id",
    reportsTable: "reports",
    reportsEnabled: true
  };

  async function hmProbeSelect(cli, table, cols) {
    try {
      const res = await cli.from(table).select(cols).limit(1);
      if (res && res.error) return { ok: false, error: res.error };
      return { ok: true, data: res.data };
    } catch (e) {
      return { ok: false, error: e };
    }
  }

  async function hmDetectSchema(cli) {
    if (hmSchema.ready) return hmSchema;

    // 1) friends table
    let t = await hmProbeSelect(cli, "friends", "user_id,friend_id,created_at");
    if (t.ok) {
      hmSchema.friendsTable = "friends";
      hmSchema.friendsUserCol = "user_id";
      hmSchema.friendsFriendCol = "friend_id";
    } else {
      // fallback: friendships(user_id, friend_id)
      t = await hmProbeSelect(cli, "friendships", "user_id,friend_id,created_at");
      if (t.ok) {
        hmSchema.friendsTable = "friendships";
        hmSchema.friendsUserCol = "user_id";
        hmSchema.friendsFriendCol = "friend_id";
      } else {
        // fallback: friends(user1_id, user2_id)
        t = await hmProbeSelect(cli, "friends", "user1_id,user2_id,created_at");
        if (t.ok) {
          hmSchema.friendsTable = "friends";
          hmSchema.friendsUserCol = "user1_id";
          hmSchema.friendsFriendCol = "user2_id";
        } else {
          console.warn("Supabase friends table schema not detected; friends features will be limited.", t.error);
        }
      }
    }

    // 2) friend_requests columns
    t = await hmProbeSelect(cli, "friend_requests", "from_user,to_user,status,created_at");
    if (t.ok) {
      hmSchema.frFromCol = "from_user";
      hmSchema.frToCol = "to_user";
    } else {
      t = await hmProbeSelect(cli, "friend_requests", "requester_id,receiver_id,status,created_at");
      if (t.ok) {
        hmSchema.frFromCol = "requester_id";
        hmSchema.frToCol = "receiver_id";
      } else {
        console.warn("Supabase friend_requests schema not detected.", t.error);
      }
    }

    // 3) blocks columnsï¼ˆä½ ç›®å‰æ˜¯ blocker_id/blocked_idï¼‰
    t = await hmProbeSelect(cli, "blocks", "blocker_id,blocked_id,created_at");
    if (t.ok) {
      hmSchema.blocksFromCol = "blocker_id";
      hmSchema.blocksToCol = "blocked_id";
    } else {
      t = await hmProbeSelect(cli, "blocks", "from_user,to_user,created_at");
      if (t.ok) {
        hmSchema.blocksFromCol = "from_user";
        hmSchema.blocksToCol = "to_user";
      } else {
        console.warn("Supabase blocks schema not detected.", t.error);
      }
    }

    // 4) reports table optional
    t = await hmProbeSelect(cli, "reports", "id,reporter_id,reported_id,reason,created_at");
    hmSchema.reportsEnabled = !!t.ok;

    hmSchema.ready = true;
    return hmSchema;
  }

  async function hmGetAuthUserId(cli) {
    const sessRes = await cli.auth.getSession();
    const session = sessRes && sessRes.data ? sessRes.data.session : null;
    if (!session || !session.user) return null;
    return session.user.id;
  }

  function hmSetSupabaseHint(msg) {
    try { console.log("Supabase åŒæ­¥æç¤ºï¼š", msg); } catch (e) {}
  }

  // ====== Supabase å¥½å‹è³‡æ–™å¿«å– ======
  let hmFriendIds = new Set();
  let hmSentItems = [];     // { request_id, other_id }
  let hmReceivedItems = []; // { request_id, other_id }
  let hmBlockedIds = new Set();

  function hmGetRelation(otherId) {
    if (hmBlockedIds.has(String(otherId))) return "blocked";
    if (hmFriendIds.has(String(otherId))) return "friend";
    if (hmSentItems.some(x => String(x.other_id) === String(otherId))) return "sent";
    if (hmReceivedItems.some(x => String(x.other_id) === String(otherId))) return "received";
    return "none";
  }

  async function hmRefreshFriendsFromSupabase() {
    try {
      const cli = await hmGetSupabaseClient();
      if (!cli) return false;

      const uid = await hmGetAuthUserId(cli);
      if (!uid) { hmSetSupabaseHint("not_signed_in"); return false; }

      const sch = await hmDetectSchema(cli);

      // blocks
      hmBlockedIds = new Set();
      const bRes = await cli
        .from(sch.blocksTable)
        .select(`${sch.blocksToCol},created_at`)
        .eq(sch.blocksFromCol, uid);

      if (bRes.error) throw bRes.error;
      (bRes.data || []).forEach(r => hmBlockedIds.add(String(r[sch.blocksToCol])));

      // friends
      hmFriendIds = new Set();
      if (sch.friendsTable) {
        const fRes = await cli
          .from(sch.friendsTable)
          .select(`${sch.friendsUserCol},${sch.friendsFriendCol},created_at`);

        if (fRes.error) throw fRes.error;

        (fRes.data || []).forEach(r => {
          // æ”¯æ´ (user_id, friend_id) ä»¥åŠ (user1_id,user2_id)
          const a = r[sch.friendsUserCol];
          const b = r[sch.friendsFriendCol];
          if (!a || !b) return;
          if (String(a) === String(uid)) hmFriendIds.add(String(b));
          else if (String(b) === String(uid)) hmFriendIds.add(String(a));
        });
      }

      // friend_requests
      hmSentItems = [];
      hmReceivedItems = [];

      const sentRes = await cli
        .from(sch.frTable)
        .select(`id,${sch.frFromCol},${sch.frToCol},status,created_at`)
        .eq(sch.frFromCol, uid)
        .eq("status", "pending");

      if (sentRes.error) throw sentRes.error;

      (sentRes.data || []).forEach(r => {
        hmSentItems.push({ request_id: r.id, other_id: r[sch.frToCol] });
      });

      const recvRes = await cli
        .from(sch.frTable)
        .select(`id,${sch.frFromCol},${sch.frToCol},status,created_at`)
        .eq(sch.frToCol, uid)
        .eq("status", "pending");

      if (recvRes.error) throw recvRes.error;

      (recvRes.data || []).forEach(r => {
        hmReceivedItems.push({ request_id: r.id, other_id: r[sch.frFromCol] });
      });

      hmSetSupabaseHint("ok");
      return true;
    } catch (e) {
      console.error("Supabase friends refresh error:", e);
      hmSetSupabaseHint("error");
      return false;
    }
  }

  async function hmAddFriend(otherId) {
    const cli = await hmGetSupabaseClient();
    if (!cli) return alert("å°šæœªå»ºç«‹ Supabase clientã€‚");

    const uid = await hmGetAuthUserId(cli);
    if (!uid) return alert("è«‹å…ˆç™»å…¥å¾Œå†é€å‡ºå¥½å‹ç”³è«‹ã€‚");

    const sch = await hmDetectSchema(cli);
    const rel = hmGetRelation(otherId);
    if (rel === "blocked") return alert("ä½ å·²å°é–å°æ–¹ï¼Œç„¡æ³•é€å‡ºå¥½å‹ç”³è«‹ã€‚");
    if (rel === "friend") return alert("ä½ å€‘å·²ç¶“æ˜¯å¥½å‹äº†ã€‚");
    if (rel === "sent") return alert("ä½ å·²é€å‡ºå¥½å‹ç”³è«‹ï¼Œç­‰å¾…å°æ–¹å›æ‡‰ã€‚");
    if (rel === "received") return alert("å°æ–¹å·²é€å‡ºç”³è«‹ï¼Œä½ å¯ä»¥å»ã€Œæ”¶åˆ°ç”³è«‹ã€åŒæ„ã€‚");

    const payload = {};
    payload[sch.frFromCol] = uid;
    payload[sch.frToCol] = otherId;
    payload.status = "pending";

    const ins = await cli.from(sch.frTable).insert(payload);
    if (ins.error) return alert("é€å‡ºç”³è«‹å¤±æ•—ï¼š" + ins.error.message);

    await hmRefreshFriendsFromSupabase();
    updateFriendTabCounts && updateFriendTabCounts();
    renderFriendsList && renderFriendsList();
    renderPeople && renderPeople();
    alert("ä½ å·²é€å‡ºå¥½å‹ç”³è«‹ï¼Œç­‰å¾…å°æ–¹å›æ‡‰ã€‚");
  }

  async function hmAcceptRequest(otherId) {
    const cli = await hmGetSupabaseClient();
    if (!cli) return alert("å°šæœªå»ºç«‹ Supabase clientã€‚");

    const uid = await hmGetAuthUserId(cli);
    if (!uid) return alert("è«‹å…ˆç™»å…¥ã€‚");

    const sch = await hmDetectSchema(cli);

    // æ‰¾åˆ° request id
    const item = hmReceivedItems.find(x => String(x.other_id) === String(otherId));
    if (!item) return alert("æ‰¾ä¸åˆ°è©²ç­†ç”³è«‹ï¼ˆå¯èƒ½å·²è¢«è™•ç†ï¼‰ã€‚");

    // 1) update request -> accepted
    const upd = await cli.from(sch.frTable).update({ status: "accepted" }).eq("id", item.request_id);
    if (upd.error) return alert("åŒæ„å¤±æ•—ï¼š" + upd.error.message);

    // 2) insert friends (å…©ç­†)
    if (sch.friendsTable) {
      const a = {}; a[sch.friendsUserCol] = uid; a[sch.friendsFriendCol] = otherId;
      const b = {}; b[sch.friendsUserCol] = otherId; b[sch.friendsFriendCol] = uid;
      const fin = await cli.from(sch.friendsTable).insert([a, b]);
      if (fin.error) console.warn("Insert friends error:", fin.error);
    }

    await hmRefreshFriendsFromSupabase();
    updateFriendTabCounts && updateFriendTabCounts();
    renderFriendsList && renderFriendsList();
    renderPeople && renderPeople();
    alert("å·²åŒæ„å¥½å‹ç”³è«‹ã€‚");
  }

  async function hmRejectRequest(otherId) {
    const cli = await hmGetSupabaseClient();
    if (!cli) return alert("å°šæœªå»ºç«‹ Supabase clientã€‚");

    const uid = await hmGetAuthUserId(cli);
    if (!uid) return alert("è«‹å…ˆç™»å…¥ã€‚");

    const sch = await hmDetectSchema(cli);

    const item = hmReceivedItems.find(x => String(x.other_id) === String(otherId));
    if (!item) return alert("æ‰¾ä¸åˆ°è©²ç­†ç”³è«‹ï¼ˆå¯èƒ½å·²è¢«è™•ç†ï¼‰ã€‚");

    const upd = await cli.from(sch.frTable).update({ status: "rejected" }).eq("id", item.request_id);
    if (upd.error) return alert("æ‹’çµ•å¤±æ•—ï¼š" + upd.error.message);

    await hmRefreshFriendsFromSupabase();
    updateFriendTabCounts && updateFriendTabCounts();
    renderFriendsList && renderFriendsList();
    renderPeople && renderPeople();
    alert("å·²æ‹’çµ•å¥½å‹ç”³è«‹ã€‚");
  }

  async function hmCancelRequest(otherId) {
    const cli = await hmGetSupabaseClient();
    if (!cli) return alert("å°šæœªå»ºç«‹ Supabase clientã€‚");

    const uid = await hmGetAuthUserId(cli);
    if (!uid) return alert("è«‹å…ˆç™»å…¥ã€‚");

    const sch = await hmDetectSchema(cli);

    const item = hmSentItems.find(x => String(x.other_id) === String(otherId));
    if (!item) return alert("æ‰¾ä¸åˆ°è©²ç­†ç”³è«‹ï¼ˆå¯èƒ½å·²è¢«è™•ç†ï¼‰ã€‚");

    const upd = await cli.from(sch.frTable).update({ status: "cancelled" }).eq("id", item.request_id);
    if (upd.error) return alert("å–æ¶ˆå¤±æ•—ï¼š" + upd.error.message);

    await hmRefreshFriendsFromSupabase();
    updateFriendTabCounts && updateFriendTabCounts();
    renderFriendsList && renderFriendsList();
    renderPeople && renderPeople();
    alert("å·²å–æ¶ˆå¥½å‹ç”³è«‹ã€‚");
  }

  async function hmRemoveFriend(otherId) {
    const cli = await hmGetSupabaseClient();
    if (!cli) return alert("å°šæœªå»ºç«‹ Supabase clientã€‚");

    const uid = await hmGetAuthUserId(cli);
    if (!uid) return alert("è«‹å…ˆç™»å…¥ã€‚");

    const sch = await hmDetectSchema(cli);

    if (!confirm("ç¢ºå®šè¦è§£é™¤å¥½å‹å—ï¼Ÿ")) return;

    // åˆªæ‰å…©ç­†ï¼ˆè‹¥ä½  friends è¡¨åªå­˜ä¸€ç­†ï¼Œä¹Ÿèƒ½åˆªåˆ°å…¶ä¸­ä¸€ç­†ï¼‰
    const del1 = await cli.from(sch.friendsTable)
      .delete()
      .eq(sch.friendsUserCol, uid)
      .eq(sch.friendsFriendCol, otherId);

    const del2 = await cli.from(sch.friendsTable)
      .delete()
      .eq(sch.friendsUserCol, otherId)
      .eq(sch.friendsFriendCol, uid);

    if (del1.error) console.warn(del1.error);
    if (del2.error) console.warn(del2.error);

    await hmRefreshFriendsFromSupabase();
    updateFriendTabCounts && updateFriendTabCounts();
    renderFriendsList && renderFriendsList();
    renderPeople && renderPeople();
    alert("å·²è§£é™¤å¥½å‹ã€‚");
  }

  // ====== å°é– / è§£é™¤å°é– ======
  async function hmBlockUser(otherId) {
    const cli = await hmGetSupabaseClient();
    if (!cli) return alert("å°šæœªå»ºç«‹ Supabase clientã€‚");

    const uid = await hmGetAuthUserId(cli);
    if (!uid) return alert("è«‹å…ˆç™»å…¥ã€‚");

    const sch = await hmDetectSchema(cli);

    if (!confirm("ç¢ºå®šè¦å°é–æ­¤äººå—ï¼Ÿå°é–å¾Œä½ å°‡çœ‹ä¸åˆ°å°æ–¹ï¼Œä¸”ç„¡æ³•äº’å‹•ã€‚")) return;

    const payload = {};
    payload[sch.blocksFromCol] = uid;
    payload[sch.blocksToCol] = otherId;

    const ins = await cli.from(sch.blocksTable).insert(payload);
    if (ins.error && !String(ins.error.message || "").toLowerCase().includes("duplicate")) {
      return alert("å°é–å¤±æ•—ï¼š" + ins.error.message);
    }

    await hmRefreshFriendsFromSupabase();
    renderPeople && renderPeople();
    renderFriendsList && renderFriendsList();
    alert("å·²å°é–ã€‚");
  }

  async function hmUnblockUser(otherId) {
    const cli = await hmGetSupabaseClient();
    if (!cli) return alert("å°šæœªå»ºç«‹ Supabase clientã€‚");

    const uid = await hmGetAuthUserId(cli);
    if (!uid) return alert("è«‹å…ˆç™»å…¥ã€‚");

    const sch = await hmDetectSchema(cli);

    const del = await cli.from(sch.blocksTable)
      .delete()
      .eq(sch.blocksFromCol, uid)
      .eq(sch.blocksToCol, otherId);

    if (del.error) return alert("è§£é™¤å°é–å¤±æ•—ï¼š" + del.error.message);

    await hmRefreshFriendsFromSupabase();
    renderPeople && renderPeople();
    renderFriendsList && renderFriendsList();
    alert("å·²è§£é™¤å°é–ã€‚");
  }

  // ====== èˆ‰å ±ï¼ˆå¯é¸ï¼šreports è¡¨è‹¥ä¸å­˜åœ¨å°±æç¤ºï¼‰ ======
  async function hmReportUser(otherId, reason, details) {
    const cli = await hmGetSupabaseClient();
    if (!cli) return alert("å°šæœªå»ºç«‹ Supabase clientã€‚");

    const uid = await hmGetAuthUserId(cli);
    if (!uid) return alert("è«‹å…ˆç™»å…¥ã€‚");

    const sch = await hmDetectSchema(cli);
    if (!sch.reportsEnabled) {
      return alert("ä½ çš„ Supabase å°šæœªå»ºç«‹ reports è¡¨ã€‚å…ˆä¸ç”¨æ€¥ï¼Œä¹‹å¾Œè¦å•Ÿç”¨å†å»ºç«‹å³å¯ã€‚");
    }

    const ins = await cli.from(sch.reportsTable).insert({
      reporter_id: uid,
      reported_id: otherId,
      reason: reason || "other",
      details: details || ""
    });

    if (ins.error) return alert("èˆ‰å ±å¤±æ•—ï¼š" + ins.error.message);
    alert("å·²é€å‡ºèˆ‰å ±ï¼Œæ„Ÿè¬å›å ±ã€‚");
  }

  // ====== æ›æ¥åˆ°æ—¢æœ‰ UI è¡Œç‚ºï¼ˆè‹¥å‡½å¼å­˜åœ¨å°±è¦†è“‹ï¼‰ ======
  // ä½ åŸæœ¬çš„ UI æŒ‰éˆ•æœƒå‘¼å«é€™äº›å‡½å¼ï¼›é€™è£¡ç¢ºä¿å®ƒå€‘å­˜åœ¨ä¸”ä¸æœƒå›  schema ä¸ç¬¦æ•´é å´©æ½°
  window.hmRefreshFriendsFromSupabase = hmRefreshFriendsFromSupabase;
  window.hmAddFriend = hmAddFriend;
  window.hmAcceptRequest = hmAcceptRequest;
  window.hmRejectRequest = hmRejectRequest;
  window.hmCancelRequest = hmCancelRequest;
  window.hmRemoveFriend = hmRemoveFriend;
  window.hmBlockUser = hmBlockUser;
  window.hmUnblockUser = hmUnblockUser;
  window.hmReportUser = hmReportUser;

  // åˆæ¬¡è¼‰å…¥ï¼šä¸è¦å› ç‚ºæœªç™»å…¥å°±è®“ UI æ¶ˆå¤±
  (async function () {
    try {
      await hmRefreshFriendsFromSupabase();
      updateFriendTabCounts && updateFriendTabCounts();
      renderFriendsList && renderFriendsList();
      renderPeople && renderPeople();
    } catch (e) {
      console.warn(e);
    }
  })();


  // ==============================
  // Supabase sync (public.profiles)
  // ==============================
  // ç›®æ¨™ï¼šåœ¨ã€Œç·¨è¼¯åŸºæœ¬è³‡æ–™ã€å­˜æª”æ™‚ï¼ŒåŒæ­¥å¯«å…¥ Supabase çš„ public.profilesã€‚
  // æ–¹å¼ï¼šupsertï¼ˆä»¥ç™»å…¥è€… auth.uid() å°æ‡‰åŒä¸€ç­† profiles.idï¼‰
  // æ³¨æ„ï¼šä¸åœ¨ç¨‹å¼ç¡¬å¯« Keyï¼Œæ”¹è®€å– localStorageï¼šSB_URL / SB_ANON_KEYï¼ˆç”±æ¸¬è©¦é¢æ¿å¯«å…¥ï¼‰

  var HM_SB_URL_KEY = "SB_URL";
  var HM_SB_ANON_KEY = "SB_ANON_KEY";
  var HM_SB_SDK_URL = "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js";

  // ====== A) å¯«æ­» Supabase å°ˆæ¡ˆé€£ç·šè³‡è¨Šï¼ˆå¿…è¦æ™‚ä»å¯ç”¨ localStorage è¦†è“‹ï¼‰ ======
  // 1) Project URLï¼šå·²å¯«æ­»ç‚ºä½ ç›®å‰å°ˆæ¡ˆ
  // 2) anon public keyï¼šè‹¥ä½ ä¸æƒ³å†ç”¨æ¸¬è©¦é¢æ¿è²¼ keyï¼Œè«‹æŠŠä¸‹é¢å­—ä¸²æ›æˆä½ çš„ anon keyã€‚
  //    ï¼ˆSupabase Dashboard â†’ Project Settings â†’ API â†’ anon public keyï¼‰
  var HM_SB_DEFAULT_URL = "https://eqtvoxcavjgronfmalfw.supabase.co";
  // TODO: è«‹æŠŠé€™è£¡æ›æˆä½ çš„ anon public keyï¼ˆå¾ˆé•·ä¸€ä¸² JWTï¼‰
  var HM_SB_DEFAULT_ANON_KEY = "";

  // è‹¥ç€è¦½å™¨å°šæœªå­˜é SB_URL/SB_ANON_KEYï¼Œå…ˆç”¨å¯«æ­»çš„é è¨­å€¼è£œä¸Šï¼ˆä¹‹å¾Œä»å¯è¢«è¦†è“‹ï¼‰ã€‚
  try {
    if (!localStorage.getItem(HM_SB_URL_KEY) && HM_SB_DEFAULT_URL) {
      localStorage.setItem(HM_SB_URL_KEY, HM_SB_DEFAULT_URL);
    }
    if (!localStorage.getItem(HM_SB_ANON_KEY) && HM_SB_DEFAULT_ANON_KEY) {
      localStorage.setItem(HM_SB_ANON_KEY, HM_SB_DEFAULT_ANON_KEY);
    }
  } catch (e) { /* ignore */ }
  var hmSupabaseClient = null;
  var hmSupabaseSdkLoading = null;

  function hmSbLog(msg) {
    try {
      var el = document.getElementById("sb_log");
      if (!el) return;
      if (typeof msg === "string") el.textContent = msg;
      else el.textContent = JSON.stringify(msg, null, 2);
    } catch (e) { /* ignore */ }
  }

  function hmEnsureSupabaseSdk() {
    if (window.supabase && window.supabase.createClient) return Promise.resolve();
    if (hmSupabaseSdkLoading) return hmSupabaseSdkLoading;

    hmSupabaseSdkLoading = new Promise(function (resolve, reject) {
      var existing = document.getElementById("hm_supabase_sdk");
      if (existing) {
        // wait until ready
        var t0 = Date.now();
        var timer = setInterval(function () {
          if (window.supabase && window.supabase.createClient) {
            clearInterval(timer);
            resolve();
          }
          if (Date.now() - t0 > 15000) {
            clearInterval(timer);
            reject(new Error("Supabase SDK è¼‰å…¥é€¾æ™‚"));
          }
        }, 200);
        return;
      }

      var s = document.createElement("script");
      s.id = "hm_supabase_sdk";
      s.src = HM_SB_SDK_URL;
      s.async = true;
      s.onload = function () {
        if (window.supabase && window.supabase.createClient) resolve();
        else reject(new Error("Supabase SDK è¼‰å…¥å¾Œä»æœªæ‰¾åˆ° createClient"));
      };
      s.onerror = function () { reject(new Error("Supabase SDK è¼‰å…¥å¤±æ•—")); };
      document.head.appendChild(s);
    });

    return hmSupabaseSdkLoading;
  }

  function hmGetSupabaseClient() {
    var url = "";
    var key = "";
    try {
      url = (localStorage.getItem(HM_SB_URL_KEY) || HM_SB_DEFAULT_URL || "").trim();
      key = (localStorage.getItem(HM_SB_ANON_KEY) || HM_SB_DEFAULT_ANON_KEY || "").trim();
    } catch (e) { /* ignore */ }

    if (!url || !key) return Promise.resolve(null);
    if (hmSupabaseClient) return Promise.resolve(hmSupabaseClient);

    return hmEnsureSupabaseSdk().then(function () {
      hmSupabaseClient = window.supabase.createClient(url, key, {
        auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false }
      });
      // ç›£è½ç™»å…¥ç‹€æ…‹ï¼ˆåªæ›ä¸€æ¬¡ï¼‰
      try { hmAttachAuthListenerOnce(); } catch (e) {}
      return hmSupabaseClient;
    });
  }

  async function hmSyncProfileToSupabase(profile) {
    try {
      var cli = await hmGetSupabaseClient();
      if (!cli) {
        // æ²’è¨­å®š URL/Key å°±ä¸åšåŒæ­¥ï¼ˆé¿å…å½±éŸ¿ demo ä½¿ç”¨ï¼‰
        return { ok: false, skipped: true, reason: "no_sb_url_key" };
      }

      // å–å¾— sessionï¼ˆé¿å… missing sub claim / 403ï¼šæ²’æœ‰ session å°±ä¸è¦å‘¼å« getSessionï¼‰
      var sessRes = await cli.auth.getSession();
      if (sessRes && sessRes.error) throw sessRes.error;
      var session = (sessRes && sessRes.data) ? sessRes.data.session : null;
      if (!session || !session.user) {
        return { ok: false, skipped: true, reason: "not_signed_in" };
      }

      var uid = session.user.id;
      // è½‰å‹ï¼ˆé¿å… int æ¬„ä½å¡åˆ°å­—ä¸²ï¼‰
      var heightVal = profile.height === "" || profile.height == null ? null : Number(profile.height);
      var weightVal = profile.weight === "" || profile.weight == null ? null : Number(profile.weight);
      if (Number.isNaN(heightVal)) heightVal = null;
      if (Number.isNaN(weightVal)) weightVal = null;
       
var nameVal = (profile && profile.name != null) ? String(profile.name).trim() : "";
if (!nameVal) nameVal = null;
       
      var payload = {
        id: uid,
        name: nameVal,                 
        region: profile.region || null,
        height: heightVal,
        weight: weightVal,
        avatar_url: profile.avatar_url || null
      };

      // upsertï¼šåŒä¸€å€‹ uid æ°¸é å¯«å›åŒä¸€ç­† profiles.id
      var upsertRes = await cli
        .from("profiles")
        .upsert(payload, { onConflict: "id" })
        .select("id,name,region,height,weight,avatar_url,created_at")
        .single();

      if (upsertRes && upsertRes.error) throw upsertRes.error;

      // æ–¹ä¾¿é™¤éŒ¯ï¼šæŠŠçµæœå¯«åˆ°æ¸¬è©¦é¢æ¿ log
      hmSbLog({ ok: true, profiles_upsert: upsertRes.data });
      return { ok: true, data: upsertRes.data };
    } catch (e) {
      console.warn("åŒæ­¥ profiles åˆ° Supabase å¤±æ•—ï¼š", e);
      hmSbLog({ ok: false, error: (e && e.message) ? e.message : String(e) });
      return { ok: false, error: e };
    }
  }

  // ä¿æŒç›¸å®¹ï¼šæŸäº›èˆŠç‰ˆç¨‹å¼ç¢¼å‘¼å« hmUpsertProfileToSupabase
  // é€™è£¡ç›´æ¥ alias åˆ° hmSyncProfileToSupabaseï¼Œé¿å… ReferenceError
  window.hmUpsertProfileToSupabase = hmSyncProfileToSupabase;

  function hmSetAuthProvider(provider) {
    try {
      localStorage.setItem("hmAuthProvider", provider);
    } catch (e) {
      console.warn("ç„¡æ³•å„²å­˜ç¶å®šç³»çµ±ï¼š", e);
    }
  }

  function hmGetAuthProvider() {
    try {
      return localStorage.getItem("hmAuthProvider") || "";
    } catch (e) {
      return "";
    }
  }

  function hmBuildSocialUrl(platform, value) {
    if (!value) return null;
    const v = value.trim();
    if (!v) return null;
    if (v.startsWith("http://") || v.startsWith("https://")) {
      return v;
    }
    switch (platform) {
      case "threads":
        return "https://www.threads.net/@" + v.replace(/^@/, "");
      case "x":
        return "https://x.com/" + v.replace(/^@/, "");
      case "instagram":
        return "https://www.instagram.com/" + v.replace(/^@/, "");
      case "facebook":
        return "https://www.facebook.com/" + v;
      case "other":
      default:
        return null;
    }
  }

  
  
  function hmFillProfileForm(options) {
    const opts = options || {};
    const nameInput = document.getElementById("hm-name");
    const heightInput = document.getElementById("hm-height");
    const weightInput = document.getElementById("hm-weight");
    const regionInput = document.getElementById("hm-region");
    const threadsInput = document.getElementById("hm-threads");
    const xInput = document.getElementById("hm-x");
    const igInput = document.getElementById("hm-instagram");
    const fbInput = document.getElementById("hm-facebook");
    const otherInput = document.getElementById("hm-other");
    const agreeInput = document.getElementById("hm-agree");

    if (!nameInput) return;

    let profile = null;
    const dataStr = localStorage.getItem("hmProfileData");
    if (dataStr) {
      try {
        profile = JSON.parse(dataStr);
      } catch (e) {
        console.warn("è§£æ hmProfileData å¤±æ•—ï¼ˆfill formï¼‰ï¼š", e);
      }
    }
    profile = profile || {};

    const socials = profile.socials || {};

    // åŸºæœ¬æ¬„ä½
    nameInput.value = profile.name || "";
    heightInput.value = profile.height || "";
    weightInput.value = profile.weight || "";
    regionInput.value = profile.region || "";

    // ç¤¾ç¾¤æ¬„ä½
    threadsInput.value = socials.threads || "";
    xInput.value = socials.x || "";
    igInput.value = socials.instagram || "";
    fbInput.value = socials.facebook || "";
    otherInput.value = socials.other || "";

    const lockBasic = !!opts.lockBasic;

    // æ§åˆ¶æ˜¯å¦å¯ç·¨è¼¯
    nameInput.readOnly = lockBasic;
    heightInput.readOnly = lockBasic;
    weightInput.readOnly = lockBasic;
    regionInput.readOnly = lockBasic;

    if (agreeInput) {
      if (lockBasic) {
        // å·²å®ŒæˆåŸºæœ¬è³‡æ–™å¾Œå†æ¬¡é–‹å•Ÿï¼Œåªç·¨è¼¯ç¤¾ç¾¤å¸³è™Ÿï¼Œæ¢æ¬¾è¦–ç‚ºå·²åŒæ„
        agreeInput.checked = true;
        agreeInput.disabled = true;
      } else {
        agreeInput.disabled = false;
        agreeInput.checked = false;
      }
    }
  }


  function hmInitAvatar() {
    try {
      const imgEl = document.getElementById("myAvatarImage");
      if (!imgEl) return;
      const dataUrl = localStorage.getItem("hmAvatarImage");
      if (dataUrl) {
        imgEl.src = dataUrl;
        try {
          hmApplyAvatarToProfileCard();
        } catch (e2) {
          console.warn("åŒæ­¥å°å¤–é ­è²¼å¤±æ•—ï¼š", e2);
        }
      }
    } catch (e) {
      console.warn("åˆå§‹åŒ–é ­è²¼å¤±æ•—ï¼š", e);
    }
  }

function hmHandleAvatarFile(inputEl) {
  try {
    const imgEl = document.getElementById("myAvatarImage");
    if (!inputEl || !imgEl) return;
    const file = inputEl.files && inputEl.files[0];
    if (!file) return;

    // å…ˆç”¨ Object URL è®“å„ç¨®ç€è¦½å™¨ï¼ˆå« iOS / Androidï¼‰ç«‹å³é è¦½
    try {
      const objectUrl = URL.createObjectURL(file);
      imgEl.src = objectUrl;
      try {
        hmApplyAvatarToProfileCard();
      } catch (e3) {
        console.warn("åŒæ­¥å°å¤–é ­è²¼å¤±æ•— (object URL)ï¼š", e3);
      }
    } catch (eObj) {
      console.warn("å»ºç«‹ Object URL å¤±æ•—ï¼š", eObj);
    }

    // å†ç”¨ FileReader è®€æˆ base64ï¼Œå­˜é€² localStorageï¼Œä¾›ä¸‹æ¬¡è¼‰å…¥ä½¿ç”¨
    const reader = new FileReader();
    reader.onload = function (ev) {
      const result = ev.target && ev.target.result;
      if (!result) return;
      try {
        localStorage.setItem("hmAvatarImage", result);
      } catch (err) {
        console.warn("å„²å­˜é ­è²¼å¤±æ•—ï¼š", err);
      }
      try {
        hmApplyAvatarToProfileCard();
      } catch (e2) {
        console.warn("åŒæ­¥å°å¤–é ­è²¼å¤±æ•— (base64)ï¼š", e2);
      }
    };
    reader.readAsDataURL(file);
  } catch (e) {
    console.warn("è™•ç†é ­è²¼ä¸Šå‚³å¤±æ•—ï¼š", e);
  }
}

function hmBindAvatarUploader() {
  const imgEl = document.getElementById("myAvatarImage");
  const input = document.getElementById("myAvatarFileInput");
  const btn = document.getElementById("myAvatarChangeBtn");
  if (!imgEl || !input) return;

  // æŒ‰éˆ•ï¼šæ›´æ›é ­è²¼
  if (btn) {
    btn.onclick = function () {
      input.click();
    };
  }

  // é»æ“Šé ­åƒä¹Ÿèƒ½é–‹å•Ÿä¸Šå‚³ï¼ˆiOS / Android / Desktop é€šç”¨ï¼‰
  imgEl.onclick = function () {
    input.click();
  };

  // çµ±ä¸€èµ° hmHandleAvatarFileï¼Œç¢ºä¿å„ç’°å¢ƒä¸€è‡´
  input.onchange = function () {
    try {
      hmHandleAvatarFile(input);
    } catch (e) {
      console.warn("é ­è²¼è®Šæ›´è™•ç†å¤±æ•—ï¼š", e);
    }
  };
}

function hmApplyAvatarToProfileCard() {
    const avatarWrapper = document.querySelector(".hm-profile-avatar");
    const avatarTextEl = document.getElementById("hm-profile-avatar-text");
    if (!avatarWrapper || !avatarTextEl) return;
    const dataUrl = localStorage.getItem("hmAvatarImage");
    if (dataUrl) {
      avatarWrapper.style.backgroundImage = "url('" + dataUrl + "')";
      avatarWrapper.style.backgroundSize = "cover";
      avatarWrapper.style.backgroundPosition = "center";
      avatarWrapper.style.color = "transparent";
    } else {
      avatarWrapper.style.backgroundImage = "";
      avatarWrapper.style.backgroundSize = "";
      avatarWrapper.style.backgroundPosition = "";
      avatarWrapper.style.color = "#fff";
    }
  }

function hmInitProfileCard() {
    const dataStr = localStorage.getItem("hmProfileData");
    const nameEl = document.getElementById("hm-profile-name");
    const metaEl = document.getElementById("hm-profile-meta");
    const regionEl = document.getElementById("hm-profile-region");
    const avatarTextEl = document.getElementById("hm-profile-avatar-text");
    const socialListEl = document.getElementById("hm-profile-social-list");
    const bindEl = document.getElementById("hm-profile-bind");

    if (!nameEl || !metaEl || !regionEl || !avatarTextEl || !socialListEl) return;

    let profile = null;
    if (dataStr) {
      try {
        profile = JSON.parse(dataStr);
      } catch (e) {
        console.warn("è§£æ hmProfileData å¤±æ•—ï¼š", e);
      }
    }
    const name = profile && profile.name ? profile.name : "æœªè¨­å®šå§“å";
    const height = profile && profile.height ? profile.height : "";
    const weight = profile && profile.weight ? profile.weight : "";
    const region = profile && profile.region ? profile.region : "æœªå¡«å¯«";

    nameEl.textContent = name;
    regionEl.textContent = "å±…ä½å€åŸŸï¼š" + region;

    if (height || weight) {
      const hText = height ? height + "cm" : "èº«é«˜æœªå¡«å¯«";
      const wText = weight ? weight + "kg" : "é«”é‡æœªå¡«å¯«";
      metaEl.textContent = hText + " ï¼ " + wText;
    } else {
      metaEl.textContent = "èº«é«˜ / é«”é‡ æœªå¡«å¯«";
    }

    let avatarText = "Me";
    if (name && typeof name === "string") {
      const trimmed = name.trim();
      if (trimmed.length === 1) avatarText = trimmed;
      else if (trimmed.length >= 2) avatarText = trimmed.slice(0, 2);
    }
    avatarTextEl.textContent = avatarText;

    const provider = hmGetAuthProvider();
    if (bindEl) {
      if (!provider) {
        bindEl.textContent = "å°šæœªç¶å®šå¸³è™Ÿ";
      } else if (provider === "google") {
        bindEl.textContent = "å·²ç¶å®šï¼šGoogle å¸³è™Ÿï¼ˆç¤ºæ„ï¼‰";
      } else if (provider === "facebook") {
        bindEl.textContent = "å·²ç¶å®šï¼šFacebook å¸³è™Ÿï¼ˆç¤ºæ„ï¼‰";
      } else if (provider === "apple") {
        bindEl.textContent = "å·²ç¶å®šï¼šApple å¸³è™Ÿï¼ˆç¤ºæ„ï¼‰";
      } else {
        bindEl.textContent = "å·²ç¶å®šï¼šå…¶ä»–ç³»çµ±å¸³è™Ÿï¼ˆç¤ºæ„ï¼‰";
      }
    }

    const socials = (profile && profile.socials) || {};
    const items = [];
    const config = [
      { key: "threads", label: "Threads", short: "Th", className: "hm-social-threads" },
      { key: "x", label: "X", short: "X", className: "hm-social-x" },
      { key: "instagram", label: "IG", short: "IG", className: "hm-social-instagram" },
      { key: "facebook", label: "FB", short: "FB", className: "hm-social-facebook" },
      { key: "other", label: "å…¶ä»–", short: "?", className: "hm-social-other" }
    ];

    socialListEl.innerHTML = "";
    config.forEach((c) => {
      const rawValue = socials[c.key];
      if (!rawValue || !rawValue.trim) return;
      if (!rawValue.trim()) return;
      const url = hmBuildSocialUrl(c.key, rawValue);
      items.push({
        key: c.key,
        label: c.label,
        short: c.short,
        className: c.className,
        raw: rawValue.trim(),
        url
      });
    });

    if (items.length === 0) {
      const span = document.createElement("span");
      span.className = "hm-profile-social-empty";
      span.textContent = "ç›®å‰å°šæœªä¸²è¯ä»»ä½•ç¤¾ç¾¤å¸³è™Ÿ";
      socialListEl.appendChild(span);
    } else {
      items.forEach((item) => {
        let el;
        if (item.url) {
          el = document.createElement("a");
          el.href = item.url;
          el.target = "_blank";
          el.rel = "noopener noreferrer";
        } else {
          el = document.createElement("div");
        }

        el.className = "hm-social-chip " + item.className;

        const icon = document.createElement("span");
        icon.className = "hm-social-icon";
        icon.textContent = item.short;

        const text = document.createElement("span");
        const displayRaw = item.raw.length > 14 ? item.raw.slice(0, 13) + "..." : item.raw;
        text.textContent = item.label + "ï½œ" + displayRaw;

        el.appendChild(icon);
        el.appendChild(text);
        socialListEl.appendChild(el);
      });
    }
  }

  
  function hmInitMyProfileHeader() {
    try {
      const dataStr = localStorage.getItem("hmProfileData");
      const nameSpan = document.getElementById("myProfileName");
      const subEl = document.getElementById("myProfileSub");
      const statusTextEl = document.getElementById("myStatusText");

      if (!nameSpan || !subEl) return;

      let profile = null;
      if (dataStr) {
        try {
          profile = JSON.parse(dataStr);
        } catch (e) {
          console.warn("è§£æ hmProfileData å¤±æ•—ï¼ˆheaderï¼‰ï¼š", e);
        }
      }

      const name = profile && profile.name ? profile.name : "æœªè¨­å®šå§“å";
      const height = profile && profile.height ? profile.height : "";
      const weight = profile && profile.weight ? profile.weight : "";
      const region = profile && profile.region ? profile.region : "";

      nameSpan.textContent = name;

      let subText = "å°ç£";
      if (region) {
        subText += " Â· " + region;
      }

      if (height || weight) {
        let hw = "";
        if (height) hw += height + "cm";
        if (height && weight) hw += " / ";
        if (weight) hw += weight + "kg";
        if (hw) subText += " Â· " + hw;
      }

      if (statusTextEl && statusTextEl.textContent) {
        subText += " Â· " + statusTextEl.textContent;
      }

      subEl.textContent = subText;
    } catch (e) {
      console.warn("åˆå§‹åŒ–æˆ‘çš„è³‡æ–™é é ­æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", e);
    }
  }

// ================== VIP & æˆ‘çš„ 6 å¼µç…§ç‰‡ï¼ˆæœ¬æ©Ÿç¤ºæ„ï¼‰ ==================
  const MY_ALBUM_SLOTS = 6;
  let myAlbumPhotosCache = null;

  function hmGetVipLevel() {
    try {
      const raw = localStorage.getItem("hmVipLevel");
      const n = parseInt(raw || "0", 10);
      if (isNaN(n) || n < 0) return 0;
      if (n > 5) return 5;
      return n;
    } catch (e) {
      return 0;
    }
  }

  function hmSetVipLevel(level) {
    const lvl = Math.min(Math.max(level, 0), 5);
    try {
      localStorage.setItem("hmVipLevel", String(lvl));
    } catch (e) {}
    hmUpdateVipUI();
    renderMyAlbum();
    renderMyDiaries();
    initMoodSquare();
    if (pages.profileDetail.classList.contains("active") && currentProfileId != null) {
      openProfileDetail(currentProfileId);
    }
  }

  function hmUpdateVipUI() {
    const lvl = hmGetVipLevel();
    const badge = document.getElementById("myVipBadge");
    const textEl = document.getElementById("vipLevelText");

    if (badge) {
      if (lvl <= 0) {
        badge.style.display = "none";
        badge.textContent = "";
      } else {
        badge.style.display = "inline-flex";
        badge.textContent = "VIP" + lvl;
      }
    }

    if (textEl) {
      if (lvl <= 0) {
        textEl.textContent = "ç›®å‰ VIP ç­‰ç´šï¼šç„¡ï¼ˆDemoï¼‰";
      } else {
        textEl.textContent = "ç›®å‰ VIP ç­‰ç´šï¼šVIP" + lvl + "ï¼ˆDemoï¼‰";
      }
    }
  }

  function hmLoadAlbumPhotos() {
    if (myAlbumPhotosCache) return myAlbumPhotosCache;
    try {
      const raw = localStorage.getItem("hmMyAlbumPhotos");
      if (raw) {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed) && parsed.length === MY_ALBUM_SLOTS) {
          myAlbumPhotosCache = parsed;
          return parsed;
        }
      }
    } catch (e) {
      console.warn("è®€å–ç›¸ç°¿ç…§ç‰‡å¤±æ•—ï¼š", e);
    }
    myAlbumPhotosCache = new Array(MY_ALBUM_SLOTS).fill(null);
    return myAlbumPhotosCache;
  }

  function hmSaveAlbumPhotos() {
    try {
      localStorage.setItem("hmMyAlbumPhotos", JSON.stringify(myAlbumPhotosCache || []));
    } catch (e) {
      console.warn("å„²å­˜ç›¸ç°¿ç…§ç‰‡å¤±æ•—ï¼š", e);
    }
  }

  function hmAlbumGetUnlockUntil() {
    try {
      const raw = localStorage.getItem("hmAlbumUnlockUntil");
      const t = parseInt(raw || "0", 10);
      return isNaN(t) ? 0 : t;
    } catch (e) {
      return 0;
    }
  }

  function hmAlbumIsUnlocked() {
    if (hmGetVipLevel() > 0) return true;
    const until = hmAlbumGetUnlockUntil();
    return until > Date.now();
  }

  function hmAlbumUnlockFor30Minutes() {
    const unlockUntil = Date.now() + 30 * 60 * 1000;
    try {
      localStorage.setItem("hmAlbumUnlockUntil", String(unlockUntil));
    } catch (e) {
      console.warn("å„²å­˜ç›¸ç°¿è§£é–æ™‚é–“å¤±æ•—ï¼š", e);
    }
    alert("Demoï¼šå‡è¨­ä½ çœ‹å®Œä¸€æ®µå»£å‘Šï¼Œæ¥ä¸‹ä¾† 30 åˆ†é˜å…§ 6 å¼µç…§ç‰‡éƒ½æœƒé–‹æ”¾çµ¦é™Œç”Ÿäººèˆ‡å¥½å‹æŸ¥çœ‹ã€‚");
    renderMyAlbum();
    if (pages.profileDetail.classList.contains("active") && currentProfileId != null) {
      openProfileDetail(currentProfileId);
    }
  }

  function hmAlbumUnlock() {
    hmAlbumUnlockFor30Minutes();
  }

  function hmGetAlbumPhotoSrc(idx) {
    const photos = hmLoadAlbumPhotos();
    const fallback = albumPhotos;
    const p = photos[idx];
    if (p) return p;
    if (fallback && fallback[idx]) return fallback[idx];
    return "https://picsum.photos/400/400?random=" + (901 + idx);
  }

  function renderMyAlbum() {
    const grid = document.getElementById("myAlbumGrid");
    if (!grid) return;
    const photos = hmLoadAlbumPhotos();

    grid.innerHTML = "";

    for (let i = 0; i < MY_ALBUM_SLOTS; i++) {
      const slot = document.createElement("div");
      slot.className = "my-album-item";

      const img = document.createElement("img");
      img.alt = "æˆ‘çš„ç›¸ç°¿ç…§ç‰‡ " + (i + 1);
      if (photos[i]) {
        img.src = photos[i];
        img.style.objectFit = "cover";
      } else {
        img.style.objectFit = "contain";
      }
      slot.appendChild(img);

      const label = document.createElement("div");
      label.className = "my-album-label";
      if (i < 2) {
        label.textContent = "ç¬¬ " + (i + 1) + " å¼µ Â· å°å¤–å…è²»é è¦½";
      } else {
        label.textContent = "ç¬¬ " + (i + 1) + " å¼µ Â· å°é™Œç”Ÿäººç‚ºé–å®šç…§ç‰‡ï¼ˆéœ€è§£é–å¾Œæ‰æœƒé¡¯ç¤ºï¼‰";
      }
      slot.appendChild(label);

      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";
      fileInput.style.display = "none";
      fileInput.id = "myAlbumInput_" + i;
      slot.appendChild(fileInput);

      const uploadBtn = document.createElement("button");
      uploadBtn.type = "button";
      uploadBtn.className = "my-album-upload-btn";
      uploadBtn.textContent = photos[i] ? "æ›´æ›" : "ä¸Šå‚³";
      uploadBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        fileInput.click();
      });
      slot.appendChild(uploadBtn);

      fileInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          const result = ev.target && ev.target.result;
          if (!result) return;
          const arr = hmLoadAlbumPhotos();
          arr[i] = result;
          myAlbumPhotosCache = arr;
          hmSaveAlbumPhotos();
          renderMyAlbum();
          if (pages.profileDetail.classList.contains("active") && currentProfileId != null) {
            openProfileDetail(currentProfileId);
          }
        };
        reader.readAsDataURL(file);
      });

      grid.appendChild(slot);
    }
  }


  function hmShowAlbumAdPrompt() {
    const go = confirm("é€™ 4 å¼µç…§ç‰‡éœ€è§€çœ‹ä¸€æ®µå»£å‘Šæ‰èƒ½åœ¨ 30 åˆ†é˜å…§è§£é–ã€‚\nè¦å‰å¾€å»£å‘Šé ï¼ˆDemoï¼‰å—ï¼Ÿ");
    if (!go) return;
    window.open("https://example.com", "_blank");
    hmAlbumUnlockFor30Minutes();
  }

  function handleStrangerAlbumClick(personId, idx) {
    const vip = hmGetVipLevel();
    if (idx < 2 || vip > 0 || hmAlbumIsUnlocked()) {
      openPhotoViewer(hmGetPersonAlbumPhotoSrc(personId, idx));
    } else {
      hmShowAlbumAdPrompt();
    }
  }
  window.handleStrangerAlbumClick = handleStrangerAlbumClick;
  window.hmGetAlbumPhotoSrc = hmGetAlbumPhotoSrc;
  window.hmGetPersonAlbumPhotoSrc = hmGetPersonAlbumPhotoSrc;

  if (chatBackBtn) {
    chatBackBtn.addEventListener("click", () => {
      hideChatPanel();
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    pickRandomBatch();
    renderPeopleGrid();

    // å¥½å‹ tab å…ƒä»¶
    friendTabFriendsEl = document.querySelector('.tab-btn[data-friendtab="friends"]');
    friendTabSentEl = document.querySelector('.tab-btn[data-friendtab="sent"]');
    friendTabReceivedEl = document.querySelector('.tab-btn[data-friendtab="received"]');
    updateFriendTabCounts();

    // è‹¥å·²ç™»å…¥ï¼Œå„ªå…ˆå¾ Supabase è®€å–ã€Œäººå€‘/å¥½å‹ã€è³‡æ–™ï¼ˆå¤±æ•—å‰‡ç¶­æŒ Demoï¼‰
    (async function(){
      try { await hmAttachAuthListenerOnce(); } catch(e) {}
      try { await hmLoadPeopleFromSupabase(); } catch(e) {}
      try { await hmRefreshFriendsFromSupabase(); } catch(e) {}
      try { updateFriendTabCounts(); } catch(e) {}
      try { renderPeopleGrid(); } catch(e) {}
      try { renderFriendsList("friends"); } catch(e) {}
    })();

    renderFriendsList("friends");
    updateMyStatus();
    updateFriendNotePreview();
    renderTopRightForPage("people");
    renderRank("pop");

    // åˆå§‹åŒ– VIP & æˆ‘çš„ç…§ç‰‡
    hmUpdateVipUI();
    renderMyAlbum();
    renderMyDiaries();
    initMoodSquare();

    // åˆå§‹åŒ–ã€Œæˆ‘çš„ã€é ­è²¼ï¼ˆè®€å– & é»æ“Šä¸Šå‚³ï¼‰
    hmInitAvatar();
    hmBindAvatarUploader();

    // åˆå§‹åŒ–èŠå¤©æ¨¡çµ„
    initChatModule();

    // æˆ‘çš„æ—¥è¨˜è¼¸å…¥å…ƒä»¶ç¶å®š
    const diaryInput = document.getElementById("myDiaryInput");
    const diaryImageUpload = document.getElementById("myDiaryImageUpload");
    const diaryImageCamera = document.getElementById("myDiaryImageCamera");
    const diaryImageUploadBtn = document.getElementById("myDiaryImageUploadBtn");
    const diaryImageCameraBtn = document.getElementById("myDiaryImageCameraBtn");
    const diaryImageSize = document.getElementById("myDiaryImageSize");
    const diaryImageSizeText = document.getElementById("myDiaryImageSizeText");
    const diaryImagePreview = document.getElementById("myDiaryImagePreview");
    const diaryImagePreviewImg = document.getElementById("myDiaryImagePreviewImg");
    const diaryAddBtn = document.getElementById("myDiaryAddBtn");
    let diaryPendingImage = null;
    let diaryPendingImageSize = diaryImageSize ? (Number(diaryImageSize.value) || 80) : 80;

    function bindDiaryFileInput(inputEl) {
      if (!inputEl) return;
      inputEl.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) {
          diaryPendingImage = null;
          if (diaryImagePreview) {
            diaryImagePreview.style.display = "none";
          }
          if (diaryImagePreviewImg) {
            diaryImagePreviewImg.removeAttribute("src");
          }
          return;
        }
        const reader = new FileReader();
        reader.onload = (ev) => {
          diaryPendingImage = ev.target && ev.target.result;
          if (diaryImagePreview && diaryImagePreviewImg && diaryPendingImage) {
            diaryImagePreviewImg.src = diaryPendingImage;
            diaryImagePreview.style.display = "block";
          }
        };
        reader.readAsDataURL(file);
      });
    }

    if (diaryImageUploadBtn && diaryImageUpload) {
      diaryImageUploadBtn.addEventListener("click", () => diaryImageUpload.click());
    }
    if (diaryImageCameraBtn && diaryImageCamera) {
      diaryImageCameraBtn.addEventListener("click", () => diaryImageCamera.click());
    }

    bindDiaryFileInput(diaryImageUpload);
    bindDiaryFileInput(diaryImageCamera);

    if (diaryImageSize && diaryImageSizeText) {
      const updateDiarySizeLabel = () => {
        diaryPendingImageSize = Number(diaryImageSize.value) || 80;
        diaryImageSizeText.textContent = "ç…§ç‰‡å¤§å°ï¼š" + diaryPendingImageSize + "%";
      };
      diaryImageSize.addEventListener("input", updateDiarySizeLabel);
      updateDiarySizeLabel();
    }

    function handleDiaryAdd() {
      if (!diaryInput) return;
      const text = diaryInput.value.trim();
      if (!text && !diaryPendingImage) {
        alert("è«‹è‡³å°‘è¼¸å…¥ä¸€äº›æ–‡å­—æˆ–é¸æ“‡ä¸€å¼µåœ–ç‰‡ã€‚");
        return;
      }
      const list = hmLoadDiaries();
      const limit = hmGetDiaryLimit();
      if (list.length >= limit) {
        alert("ç›®å‰æœ€å¤šåªèƒ½å»ºç«‹ " + limit + " å‰‡æ—¥è¨˜ã€‚è‹¥è¦æ›´å¤šå¯ä»¥è€ƒæ…®å‡ç´š VIPï¼ˆDemoï¼‰ã€‚");
        return;
      }
      const now = new Date();
      const diary = {
        id: now.getTime(),
        text,
        image: diaryPendingImage,
        imageSize: diaryPendingImageSize,
        createdAt: now.toISOString()
      };
      list.push(diary);
      hmSaveDiaries(list);
      diaryInput.value = "";
      if (diaryImageUpload) diaryImageUpload.value = "";
      if (diaryImageCamera) diaryImageCamera.value = "";
      diaryPendingImage = null;
      if (diaryImagePreview) diaryImagePreview.style.display = "none";
      if (diaryImagePreviewImg) diaryImagePreviewImg.removeAttribute("src");
      renderMyDiaries();
    }

    if (diaryAddBtn) {
      diaryAddBtn.addEventListener("click", handleDiaryAdd);
    }

    const vipToggleBtn = document.getElementById("vipLevelToggleBtn");
    if (vipToggleBtn) {
      vipToggleBtn.addEventListener("click", () => {
        let lvl = hmGetVipLevel();
        lvl = (lvl + 1) % 6; // 0~5 å¾ªç’°
        hmSetVipLevel(lvl);
      });
    }

    // ç™»å…¥ / åŸºæœ¬è³‡æ–™ Modal
    const loginModal = document.getElementById("hm-login-modal");
    const profileModal = document.getElementById("hm-profile-modal");
    const form = document.getElementById("hm-profile-form");

    if (!hmHasCompletedProfile()) {
      if (loginModal) loginModal.style.display = "flex";
    }

    function handleFakeLogin(provider) {
      hmSetAuthProvider(provider);
      if (loginModal) loginModal.style.display = "none";
      if (!hmHasCompletedProfile() && profileModal) {
        // åˆæ¬¡ç¶å®šå¾Œï¼Œé–‹å•Ÿå®Œæ•´åŸºæœ¬è³‡æ–™å¡«å¯«
        const headerTitle = profileModal.querySelector(".hm-modal-header h2");
        const headerSub = profileModal.querySelector(".hm-modal-header p");
        if (headerTitle) headerTitle.textContent = "å®ŒæˆåŸºæœ¬è³‡æ–™ï¼Œé–‹å§‹é…å°";
        if (headerSub) headerSub.textContent = "ç‚ºäº†æå‡çœŸå¯¦åº¦èˆ‡é…å°å“è³ªï¼Œè«‹å…ˆå¡«å¯«ä»¥ä¸‹è³‡è¨Šã€‚";
        hmFillProfileForm({ lockBasic: false });
        profileModal.style.display = "flex";
      }
      hmInitProfileCard();
      hmInitMyProfileHeader();
    }

    const btnGoogle = document.getElementById("hm-login-google");
    const btnFacebook = document.getElementById("hm-login-facebook");
    const btnApple = document.getElementById("hm-login-apple");

    if (btnGoogle) {
      btnGoogle.addEventListener("click", () => handleFakeLogin("google"));
    }
    if (btnFacebook) {
      btnFacebook.addEventListener("click", () => handleFakeLogin("facebook"));
    }
    if (btnApple) {
      btnApple.addEventListener("click", () => handleFakeLogin("apple"));
    }

    if (form) {
      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const alreadyCompleted = hmHasCompletedProfile();

        const name = document.getElementById("hm-name").value.trim();
        const height = document.getElementById("hm-height").value.trim();
        const weight = document.getElementById("hm-weight").value.trim();
        const region = document.getElementById("hm-region").value.trim();
        const threads = document.getElementById("hm-threads").value.trim();
        const x = document.getElementById("hm-x").value.trim();
        const instagram = document.getElementById("hm-instagram").value.trim();
        const facebook = document.getElementById("hm-facebook").value.trim();
        const other = document.getElementById("hm-other").value.trim();
        const agree = document.getElementById("hm-agree").checked;

        let existingProfile = null;
        try {
          const raw = localStorage.getItem("hmProfileData");
          if (raw) existingProfile = JSON.parse(raw);
        } catch (err) {
          console.warn("è§£æç¾æœ‰ Profile å¤±æ•—ï¼š", err);
        }
        if (!existingProfile) existingProfile = {};

        if (!alreadyCompleted || !existingProfile.name || !existingProfile.height || !existingProfile.weight) {
          // ç¬¬ä¸€æ¬¡å®ŒæˆåŸºæœ¬è³‡æ–™ï¼ˆæˆ–æœ¬æ©Ÿè³‡æ–™ç¼ºå¤±ï¼‰ï¼Œéœ€è¦å®Œæ•´é©—è­‰
          if (!name) {
            alert("è«‹å¡«å¯«ç¨±å‘¼ï¼ˆæš±ç¨±ï¼‰");
            return;
          }
          if (!height || !weight) {
            alert("èº«é«˜èˆ‡é«”é‡ç‚ºå¿…å¡«æ¬„ä½");
            return;
          }
          if (!agree) {
            alert("è«‹å‹¾é¸åŒæ„æœå‹™æ¢æ¬¾èˆ‡éš±ç§æ”¿ç­–");
            return;
          }
        } else {
          // å·²å®ŒæˆåŸºæœ¬è³‡æ–™å¾Œå†æ¬¡é–‹å•Ÿï¼Œåªå…è¨±ä¿®æ”¹ç¤¾ç¾¤å¸³è™Ÿ
          // ä¸å†å¼·åˆ¶æª¢æŸ¥ç¨±å‘¼ / èº«é«˜ / é«”é‡
        }

        let profileData;
        if (!alreadyCompleted || !existingProfile.name || !existingProfile.height || !existingProfile.weight) {
          // åˆæ¬¡å»ºç«‹æˆ–è£œé½Šç¼ºæ¼ï¼Œå…¨éƒ¨å¯«å…¥
          profileData = {
            name,
            height,
            weight,
            region,
            socials: { threads, x, instagram, facebook, other },
            createdAt: existingProfile.createdAt || new Date().toISOString()
          };
        } else {
  // å·²å®ŒæˆåŸºæœ¬è³‡æ–™å¾Œï¼šä»å…è¨±æŠŠ name/height/weight/region åŒæ­¥å¯«å› Supabase
  // ï¼ˆé¿å… Supabase é‚£ç­† name ä»ç‚º NULL æ™‚æ°¸é è£œä¸ä¸Šï¼‰
  profileData = Object.assign({}, existingProfile, {
    name,
    height,
    weight,
    region,
    socials: { threads, x, instagram, facebook, other }
  });
}


        hmSaveProfileData(profileData);

        // åŒæ­¥å¯«å…¥ Supabase public.profilesï¼ˆä»¥ auth.uid() ç•¶ä½œ idï¼Œä½¿ç”¨ upsertï¼‰
        // è‹¥å°šæœªè¨­å®š SB_URL/SB_ANON_KEY æˆ–å°šæœªç™»å…¥ï¼Œæœƒè‡ªå‹•ç•¥éï¼Œä¸å½±éŸ¿æœ¬åœ° Demo æµç¨‹ã€‚
        try {
          const sbRes = await hmUpsertProfileToSupabase(profileData);
          if (sbRes && sbRes.ok) {
            console.log("å·²åŒæ­¥è‡³ Supabase profilesï¼š", sbRes.data);
          } else if (sbRes && sbRes.skipped) {
            console.log("Supabase åŒæ­¥ç•¥éï¼š", sbRes.reason);
          }
        } catch (err) {
          console.warn("Supabase profiles åŒæ­¥å¤±æ•—ï¼ˆä¸å½±éŸ¿æœ¬åœ° Demoï¼‰ï¼š", err);
        }
        if (profileModal) profileModal.style.display = "none";

        hmInitProfileCard();
        hmInitMyProfileHeader();
        console.log(alreadyCompleted ? "HeartMeet ç¤¾ç¾¤è³‡æ–™å·²æ›´æ–°ï¼š" : "HeartMeet åŸºæœ¬è³‡æ–™å·²å®Œæˆï¼š", profileData);
      });
    }

    hmInitProfileCard();
    hmInitMyProfileHeader();
    hmInitAvatar();
    hmBindAvatarUploader();

    const editBtn = document.getElementById("hm-profile-edit-btn");
    if (editBtn && profileModal) {
      editBtn.addEventListener("click", function () {
        const isCompleted = hmHasCompletedProfile();
        const headerTitle = profileModal.querySelector(".hm-modal-header h2");
        const headerSub = profileModal.querySelector(".hm-modal-header p");

        if (isCompleted) {
          if (headerTitle) headerTitle.textContent = "ç·¨è¼¯ç¤¾ç¾¤å¸³è™Ÿ";
          if (headerSub) headerSub.textContent = "åŸºæœ¬è³‡æ–™ï¼ˆç¨±å‘¼ã€èº«é«˜ã€é«”é‡ã€å±…ä½å€åŸŸï¼‰å·²é–å®šï¼Œå¦‚éœ€ä¿®æ”¹è«‹åˆªé™¤å¸³è™Ÿé‡æ–°å»ºç«‹ã€‚æœ¬ç•«é¢åƒ…ä¾›è£œä¸Šæˆ–èª¿æ•´ç¤¾ç¾¤å¸³è™Ÿã€‚";
          hmFillProfileForm({ lockBasic: true });
        } else {
          if (headerTitle) headerTitle.textContent = "å®ŒæˆåŸºæœ¬è³‡æ–™ï¼Œé–‹å§‹é…å°";
          if (headerSub) headerSub.textContent = "ç‚ºäº†æå‡çœŸå¯¦åº¦èˆ‡é…å°å“è³ªï¼Œè«‹å…ˆå¡«å¯«ä»¥ä¸‹è³‡è¨Šã€‚";
          hmFillProfileForm({ lockBasic: false });
        }

        profileModal.style.display = "flex";
      });
    }

    const logoutBtn = document.getElementById("hm-logout-btn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", function () {
        if (!confirm("ç¢ºå®šè¦ç™»å‡ºä¸¦æ¸…é™¤æœ¬æ©Ÿçš„æš«å­˜è³‡æ–™å—ï¼Ÿ\nï¼ˆåŒ…å«åŸºæœ¬è³‡æ–™ã€ç¶å®šç³»çµ±ã€VIP ç­‰ç´šèˆ‡ç›¸ç°¿ç…§ç‰‡ Demo è³‡æ–™ï¼‰")) {
          return;
        }
        try {
          localStorage.removeItem("hmProfileData");
          localStorage.removeItem("hmProfileCompleted");
          localStorage.removeItem("hmAuthProvider");
          localStorage.removeItem("hmVipLevel");
          localStorage.removeItem("hmMyAlbumPhotos");
          localStorage.removeItem("hmAlbumUnlockUntil");
          localStorage.removeItem("hmAvatarImage");
          sessionStorage.removeItem("hmAlbumUnlocked");
        } catch (e) {
          console.warn("ç™»å‡ºæ™‚æ¸…é™¤ localStorage / sessionStorage å¤±æ•—ï¼š", e);
        }
        location.reload();
      });
    }
  });
 </script>

<script>
document.addEventListener("change", function (e) {
  const input = e.target;
  if (
    input.type === "file" &&
    (input.id.includes("photo") || input.id.includes("diary"))
  ) {
    let preview = input.parentElement.querySelector(".photo-preview");
    if (!preview) {
      preview = document.createElement("div");
      preview.className = "photo-preview";
      preview.style.display = "flex";
      preview.style.flexWrap = "wrap";
      preview.style.gap = "8px";
      preview.style.padding = "10px 0";
      input.parentElement.appendChild(preview);
    }
    preview.innerHTML = "";

    const files = input.files;
    if (!files || files.length === 0) return;

    [...files].forEach((file) => {
      if (!file.type.startsWith("image/")) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = document.createElement("img");
        img.src = ev.target.result;
        img.style.width = "90px";
        img.style.height = "90px";
        img.style.objectFit = "cover";
        img.style.borderRadius = "12px";
        img.style.boxShadow = "0 2px 6px rgba(0,0,0,0.15)";
        preview.appendChild(img);
      };
      reader.readAsDataURL(file);
    });
  }
});
</script>
   
<!-- Supabase Test Panel (safe loader) -->
<!--<script src="./supabase-panel-loader.js">-->

</body>
</html>
