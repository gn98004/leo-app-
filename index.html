<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>心遇 XinYou - Public Profile MVP（Supabase）</title>
  <link rel="stylesheet" href="./styles.css" />
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">心遇</div>
      <div class="meta">
        <div class="title">Public Profile MVP（跨帳號同步驗證版）</div>
        <div class="subtitle">Profiles / Photos（Avatar+Album）/ Diaries（公開日記）/ Friend Requests</div>
      </div>
    </div>

    <div class="session">
      <div class="pill" id="pillStatus">尚未初始化</div>
      <button class="btn ghost" id="btnSignOutTop" disabled>登出 Email</button>
    </div>
  </header>

  <main class="layout">
    <nav class="sidebar" id="tabs">
      <button class="tab active" data-tab="tab-test">Supabase Test Panel</button>
      <button class="tab" data-tab="tab-auth">登入 / 註冊</button>
      <button class="tab" data-tab="tab-profile" disabled>填寫資料</button>
      <button class="tab" data-tab="tab-photos" disabled>大頭貼 / 相簿</button>
      <button class="tab" data-tab="tab-diaries" disabled>我的日記</button>
      <button class="tab" data-tab="tab-encounter" disabled>巧遇 / 公開檔案</button>
      <button class="tab" data-tab="tab-friends" disabled>好友 / 請求</button>

      <div class="sidebar-footer">
        <div class="hint">
          <div class="hint-title">驗收流程</div>
          <ol>
            <li>登入 A → 填 gender/age_range</li>
            <li>上傳大頭貼 / 相簿</li>
            <li>新增公開日記（is_public）</li>
            <li>登出 → 登入 B</li>
            <li>B 在巧遇點開 A：可看到資料 / 大頭貼 / 相簿 / 公開日記</li>
            <li>點「加好友」可送出請求，A 可在「好友/請求」接受</li>
          </ol>
        </div>
      </div>
    </nav>

    <section class="content">
      <!-- Test panel -->
      <section class="panel" id="tab-test">
        <h2>Supabase Test Panel</h2>
        <p class="muted">填入 SUPABASE_URL / ANON_KEY 後初始化。資料會保存在本機瀏覽器 localStorage，避免你每次改程式。</p>

        <div class="grid2">
          <div class="field">
            <label>SUPABASE_URL</label>
            <input id="sbUrl" placeholder="https://xxxx.supabase.co" autocomplete="off" />
          </div>
          <div class="field">
            <label>ANON_KEY</label>
            <input id="sbKey" placeholder="eyJhbGciOi..." autocomplete="off" />
          </div>
        </div>

        <div class="row">
          <button class="btn" id="btnInit">初始化</button>
          <button class="btn ghost" id="btnClearCfg">清除本機設定</button>
        </div>

        <div class="card">
          <div class="card-title">狀態</div>
          <pre class="log" id="logInit"></pre>
        </div>

        <div class="card">
          <div class="card-title">必要後端（SQL / Bucket）</div>
          <ul class="muted">
            <li>請先在 Supabase SQL Editor 執行 <code>/sql/01_schema.sql</code> 與 <code>/sql/02_rls.sql</code></li>
            <li>Storage 建議建立 bucket：<code>photos</code>，並設為 <strong>Public</strong>（方便前端直接顯示圖片）</li>
          </ul>
        </div>
      </section>

      <!-- Auth -->
      <section class="panel hidden" id="tab-auth">
        <h2>登入 / 註冊</h2>

        <div class="grid2">
          <div class="card">
            <div class="card-title">註冊</div>
            <div class="field">
              <label>Email</label>
              <input id="signUpEmail" placeholder="you@example.com" autocomplete="username" />
            </div>
            <div class="field">
              <label>Password</label>
              <input id="signUpPassword" type="password" placeholder="至少 6 碼" autocomplete="new-password" />
            </div>
            <button class="btn" id="btnSignUp" disabled>註冊</button>
            <div class="muted small">若你已開啟 Email Confirm，需先到信箱完成驗證。</div>
          </div>

          <div class="card">
            <div class="card-title">登入</div>
            <div class="field">
              <label>Email</label>
              <input id="signInEmail" placeholder="you@example.com" autocomplete="username" />
            </div>
            <div class="field">
              <label>Password</label>
              <input id="signInPassword" type="password" placeholder="你的密碼" autocomplete="current-password" />
            </div>
            <button class="btn" id="btnSignIn" disabled>登入</button>
            <div class="row allowwrap">
              <button class="btn ghost" id="btnSignOut" disabled>登出 Email</button>
              <button class="btn ghost" id="btnSession" disabled>顯示 Session</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Auth Log</div>
          <pre class="log" id="logAuth"></pre>
        </div>
      </section>

      <!-- Profile -->
      <section class="panel hidden" id="tab-profile">
        <h2>填寫資料（profiles）</h2>

        <div class="grid2">
          <div class="card">
            <div class="card-title">我的資料</div>

            <div class="grid2">
              <div class="field">
                <label>性別 gender</label>
                <select id="profileGender">
                  <option value="">（未填）</option>
                  <option value="male">男</option>
                  <option value="female">女</option>
                </select>
              </div>

              <div class="field">
                <label>年齡層 age_range</label>
                <select id="profileAgeRange">
                  <option value="">（未填）</option>
                  <option value="18-20">18–20</option>
                  <option value="20-25">20–25</option>
                  <option value="25-30">25–30</option>
                  <option value="30-35">30–35</option>
                  <option value="35-40">35–40</option>
                  <option value="40-45">40–45</option>
                  <option value="45-50">45–50</option>
                  <option value="50+">50+</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label>公開暱稱 display_name（可選）</label>
              <input id="profileDisplayName" placeholder="例如：小狼" autocomplete="off" />
            </div>

            <div class="row">
              <button class="btn" id="btnSaveProfile">儲存 / 更新</button>
              <button class="btn ghost" id="btnReloadProfile">重新讀取</button>
            </div>

            <div class="muted small">資料寫入：profiles（upsert）。跨帳號讀取：巧遇頁用 profiles + photos + diaries 組合顯示。</div>
          </div>

          <div class="card">
            <div class="card-title">目前 profiles 資料（raw）</div>
            <pre class="log" id="logProfile"></pre>
          </div>
        </div>
      </section>

      <!-- Photos -->
      <section class="panel hidden" id="tab-photos">
        <h2>大頭貼 / 相簿同步（photos + storage）</h2>

        <div class="grid2">
          <div class="card">
            <div class="card-title">上傳照片</div>

            <div class="field">
              <label>選擇圖片</label>
              <input id="photoFile" type="file" accept="image/*" />
            </div>

            <div class="row">
              <label class="checkbox">
                <input type="checkbox" id="photoIsAvatar" />
                設為大頭貼（is_avatar=true）
              </label>
            </div>

            <div class="row">
              <button class="btn" id="btnUploadPhoto">上傳</button>
              <button class="btn ghost" id="btnRefreshPhotos">重新整理</button>
            </div>

            <div class="muted small">
              規則：<code>is_avatar=true</code> 為大頭貼；其餘為相簿。若新上傳設為大頭貼，系統會先把舊的大頭貼全部設為 false。
            </div>
          </div>

          <div class="card">
            <div class="card-title">我的大頭貼</div>
            <div class="avatarWrap" id="myAvatar"></div>
            <div class="divider"></div>
            <div class="card-title">我的相簿</div>
            <div class="gallery" id="myAlbum"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Photos Log</div>
          <pre class="log" id="logPhotos"></pre>
        </div>
      </section>

      <!-- Diaries -->
      <section class="panel hidden" id="tab-diaries">
        <h2>日記（diaries）</h2>

        <div class="grid2">
          <div class="card">
            <div class="card-title">新增日記</div>

            <div class="field">
              <label>標題</label>
              <input id="diaryTitle" placeholder="今天想說…" />
            </div>

            <div class="field">
              <label>內容</label>
              <textarea id="diaryBody" rows="6" placeholder="寫點什麼…"></textarea>
            </div>

            <div class="row">
              <label class="checkbox">
                <input type="checkbox" id="diaryIsPublic" />
                公開（is_public=true）
              </label>
            </div>

            <div class="row">
              <button class="btn" id="btnCreateDiary">新增</button>
              <button class="btn ghost" id="btnRefreshDiaries">重新整理</button>
            </div>

            <div class="muted small">
              公開日記：其他登入者可讀取（RLS：<code>is_public=true</code>）。
            </div>
          </div>

          <div class="card">
            <div class="card-title">我的日記清單</div>
            <div id="myDiaries" class="stack"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Diaries Log</div>
          <pre class="log" id="logDiaries"></pre>
        </div>
      </section>

      <!-- Encounter -->
      <section class="panel hidden" id="tab-encounter">
        <h2>巧遇 / 公開檔案（跨帳號同步驗證核心）</h2>

        <div class="grid2">
          <div class="card">
            <div class="row between">
              <div>
                <div class="card-title">用戶列表（排除自己）</div>
                <div class="muted small">點選任一用戶查看公開檔案：profiles + avatar + album + 公開日記</div>
              </div>
              <button class="btn ghost" id="btnRefreshUsers">重新整理</button>
            </div>
            <div id="usersList" class="stack"></div>
          </div>

          <div class="card" id="publicProfileCard">
            <div class="row between">
              <div>
                <div class="card-title">公開檔案</div>
                <div class="muted small" id="publicProfileHint">請從左側選擇一位用戶</div>
              </div>
              <button class="btn" id="btnAddFriend" disabled>加好友</button>
            </div>

            <div class="publicHeader">
              <div class="avatarLarge" id="publicAvatar"></div>
              <div class="publicMeta" id="publicMeta"></div>
            </div>

            <div class="divider"></div>
            <div class="card-title">相簿</div>
            <div class="gallery" id="publicAlbum"></div>

            <div class="divider"></div>
            <div class="card-title">公開日記</div>
            <div id="publicDiaries" class="stack"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Encounter Log</div>
          <pre class="log" id="logEncounter"></pre>
        </div>
      </section>

      <!-- Friends -->
      <section class="panel hidden" id="tab-friends">
        <h2>好友 / 請求（friend_requests）</h2>

        <div class="grid2">
          <div class="card">
            <div class="row between">
              <div>
                <div class="card-title">收到的好友請求</div>
                <div class="muted small">接受後狀態變更為 accepted</div>
              </div>
              <button class="btn ghost" id="btnRefreshIncoming">重新整理</button>
            </div>
            <div id="incomingRequests" class="stack"></div>
          </div>

          <div class="card">
            <div class="row between">
              <div>
                <div class="card-title">我送出的好友請求</div>
                <div class="muted small">pending / accepted / rejected / canceled</div>
              </div>
              <button class="btn ghost" id="btnRefreshOutgoing">重新整理</button>
            </div>
            <div id="outgoingRequests" class="stack"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Friends Log</div>
          <pre class="log" id="logFriends"></pre>
        </div>
      </section>
    </section>
  </main>

  <footer class="footer">
    <div>本版本專注修正：①大頭貼同步 ②相簿同步與對外同步 ③加好友按鈕失效 ④公開日記跨帳號讀取</div>
  </footer>

  <script src="./app.js"></script>
</body>
</html>
