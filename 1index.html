<script>
  // ========= å‡è³‡æ–™ï¼šäººå€‘ =========
  const people = [
    {
      id: 1,
      uid: "people-1",
      name: "ã‚Šã‚“ã‚Šã‚“",
      ageText: "20 æ­²å¾ŒåŠ",
      desc: "æ—¥èªã€ä¸­åœ‹èªå¯â˜…",
      avatar: "https://picsum.photos/300/400?random=1",
      status: "online",
      statusText: "å·²ä¸Šç·š"
    },
    {
      id: 2,
      uid: "people-2",
      name: "Meow",
      ageText: "30 æ­²åˆåŠ",
      desc: "å…§æœ‰æƒ¡è²“ã€‚",
      avatar: "https://picsum.photos/300/400?random=2",
      status: "eating",
      statusText: "ç”¨é¤å»â€¦"
    },
    {
      id: 3,
      uid: "people-3",
      name: "Min",
      ageText: "10 æ­²å¾ŒåŠ",
      desc: "é™¤äº†ç™¼å‘†é‚„æ˜¯ç™¼å‘†ç›´åˆ°è®Šå‘†ã€‚",
      avatar: "https://picsum.photos/300/400?random=3",
      status: "away",
      statusText: "æš«é›¢ä¸­â€¦"
    },
    {
      id: 4,
      uid: "people-4",
      name: "å½±å¯’",
      ageText: "30 æ­²åˆåŠ",
      desc: "å€šæ¬„è½é¢¨é›¨ï¼Œæ·¡çœ‹æ±Ÿæ¹–è·¯ã€‚",
      avatar: "https://picsum.photos/300/400?random=4",
      status: "online",
      statusText: "æƒ³èŠå¤©"
    },
    {
      id: 5,
      uid: "people-5",
      name: "é˜¿åˆ",
      ageText: "20 æ­²åˆåŠ",
      desc: "å–œæ­¡éœ²ç‡Ÿã€æ‹ç…§ã€çœ‹æ˜Ÿæ˜Ÿã€‚",
      avatar: "https://picsum.photos/300/400?random=5",
      status: "busy",
      statusText: "å¿™ç¢Œä¸­â€¦"
    },
    {
      id: 6,
      uid: "people-6",
      name: "å°è·¯",
      ageText: "30 æ­²å¾ŒåŠ",
      desc: "èµ°åœ¨è·¯ä¸Šéš¨ä¾¿äº‚æƒ³äº‹æƒ…ã€‚",
      avatar: "https://picsum.photos/300/400?random=6",
      status: "shower",
      statusText: "æ´—æ¾¡ä¸­â€¦"
    },
    {
      id: 7,
      uid: "people-7",
      name: "Kimi",
      ageText: "20 æ­²åˆåŠ",
      desc: "å–œæ­¡åˆ°è™•åƒåƒå–å–ã€‚",
      avatar: "https://picsum.photos/300/400?random=7",
      status: "online",
      statusText: "å·²ä¸Šç·š"
    },
    {
      id: 8,
      uid: "people-8",
      name: "Mori",
      ageText: "40 æ­²å‰å¾Œ",
      desc: "ç†Ÿé½¡äº¤å‹ï¼Œæ…¢æ…¢èŠã€‚",
      avatar: "https://picsum.photos/300/400?random=8",
      status: "away",
      statusText: "é›¢ç·šä¸­"
    }
  ];

  const albumPhotos = [
    "https://picsum.photos/400/400?random=901",
    "https://picsum.photos/400/400?random=902",
    "https://picsum.photos/400/400?random=903",
    "https://picsum.photos/400/400?random=904",
    "https://picsum.photos/400/400?random=905",
    "https://picsum.photos/400/400?random=906"
  ];

  // ========= å…¨åŸŸè®Šæ•¸ï¼ˆå…ˆå®£å‘Šï¼ŒDOMContentLoaded å†è³¦å€¼ï¼‰ =========
  let peopleGridEl;
  let nextBatchBtn;
  let profileDetailContent;
  let topTitleEl;
  let topRightSlot;

  let friendsListEl;
  let chatMessagesEl;
  let chatInputEl;
  let chatSendBtn;
  let stickerBar;
  let stickerToggle;
  let chatWrapper;
  let chatUploadBtn;
  let chatFileInput;

  let statusSelect;
  let myStatusBadge;
  let myStatusText;
  let myProfileSub;

  let friendNoteInput;
  let friendNotePreview;

  const pages = {
    people: null,
    profileDetail: null,
    friends: null,
    rank: null,
    chat: null,
    me: null
  };

  let rankPyramidEl;
  let rankListEl;

  let currentBatch = [];
  let currentRankTab = "pop";
  let currentFriendTab = "friends";
  let currentProfileUser = null;
  let currentChatUser = null;

  // ========= å¥½å‹ç³»çµ±ç‹€æ…‹ =========
  let friendState = {
    friends: [],
    sent: [],
    received: [
      {
        uid: "seed-1",
        user: {
          uid: "seed-1",
          id: null,
          name: "Demo ç”¨æˆ¶A",
          ageText: "20 å¤šæ­²",
          desc: "é€™æ˜¯ä¸€å€‹ç¤ºç¯„ç”¨çš„å¥½å‹ç”³è«‹ã€‚",
          avatar: "https://picsum.photos/200/200?random=333",
          status: "online",
          statusText: "å·²ä¸Šç·š"
        },
        status: "pending"
      }
    ]
  };

  // ========= æ’è¡Œæ¦œå‡è³‡æ–™ =========
  const rankData = {
    pop: [
      { pos: 1, title: "King", name: "Sunny", city: "å°åŒ—", age: "20+", score: 9820, avatar: "https://picsum.photos/200/200?random=201" },
      { pos: 2, title: "Princess", name: "Amy", city: "é«˜é›„", age: "25+", score: 9130, avatar: "https://picsum.photos/200/200?random=202" },
      { pos: 3, title: "Prince", name: "Max", city: "æ–°åŒ—", age: "22+", score: 8990, avatar: "https://picsum.photos/200/200?random=203" },
      { pos: 4, title: "Duke", name: "Lynn", city: "å°ä¸­", age: "23+", score: 8500, avatar: "https://picsum.photos/200/200?random=204" },
      { pos: 5, title: "Duke", name: "Zero", city: "æ¡ƒåœ’", age: "20+", score: 8420, avatar: "https://picsum.photos/200/200?random=205" },
      { pos: 6, title: "Duchess", name: "Mika", city: "å°å—", age: "27+", score: 8300, avatar: "https://picsum.photos/200/200?random=206" },
      { pos: 7, title: "Marquis", name: "é˜¿å“²", city: "æ–°ç«¹", age: "28+", score: 7900, avatar: "https://picsum.photos/200/200?random=207" },
      { pos: 8, title: "Baron", name: "å°è‘‰", city: "åŸºéš†", age: "24+", score: 7600, avatar: "https://picsum.photos/200/200?random=208" }
    ],
    receive: [
      { pos: 1, title: "Queen", name: "Rin", city: "å°åŒ—", age: "21+", score: 10010, avatar: "https://picsum.photos/200/200?random=211" },
      { pos: 2, title: "Princess", name: "Nana", city: "æ–°åŒ—", age: "26+", score: 9200, avatar: "https://picsum.photos/200/200?random=212" },
      { pos: 3, title: "Duke", name: "Ken", city: "é«˜é›„", age: "29+", score: 8800, avatar: "https://picsum.photos/200/200?random=213" },
      { pos: 4, title: "Duchess", name: "Sasa", city: "æ¡ƒåœ’", age: "23+", score: 8400, avatar: "https://picsum.photos/200/200?random=214" }
    ],
    send: [
      { pos: 1, title: "King", name: "Leo", city: "å°ä¸­", age: "30+", score: 11000, avatar: "https://picsum.photos/200/200?random=221" },
      { pos: 2, title: "Prince", name: "Sean", city: "å°åŒ—", age: "24+", score: 9600, avatar: "https://picsum.photos/200/200?random=222" },
      { pos: 3, title: "Duke", name: "Kai", city: "æ–°åŒ—", age: "27+", score: 9000, avatar: "https://picsum.photos/200/200?random=223" },
      { pos: 4, title: "Baron", name: "ç±³ç³•", city: "èŠ±è“®", age: "32+", score: 8200, avatar: "https://picsum.photos/200/200?random=224" }
    ]
  };

  // ========= å…±ç”¨å°å·¥å…· =========
  function shuffleArray(arr) {
    const copy = arr.slice();
    for (let i = copy.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [copy[i], copy[j]] = [copy[j], copy[i]];
    }
    return copy;
  }

  function showPage(pageName) {
    Object.keys(pages).forEach(k => {
      if (pages[k]) {
        pages[k].classList.toggle("active", k === pageName);
      }
    });
    // åº•éƒ¨ Nav é«˜äº®åŒæ­¥
    document.querySelectorAll(".nav-item").forEach(item => {
      const page = item.getAttribute("data-page");
      const active = (page === pageName) || (pageName === "profileDetail" && page === "people");
      item.classList.toggle("active", active);
    });
    // é ‚éƒ¨æ¨™é¡Œ
    if (pageName === "people") topTitleEl.textContent = "äººå€‘ Â· å¿ƒé‡ XinYou";
    if (pageName === "friends") topTitleEl.textContent = "å¥½å‹";
    if (pageName === "rank") topTitleEl.textContent = "æ’è¡Œæ¦œ";
    if (pageName === "chat" && currentChatUser) topTitleEl.textContent = currentChatUser.name + " Â· èŠå¤©";
    if (pageName === "chat" && !currentChatUser) topTitleEl.textContent = "èŠå¤©";
    if (pageName === "me") topTitleEl.textContent = "æˆ‘çš„æª”æ¡ˆ";

    renderTopRightForPage(pageName === "profileDetail" ? "people" : pageName);
  }

  function renderTopRightForPage(pageName) {
    if (!topRightSlot) return;
    topRightSlot.innerHTML = "";
    if (pageName === "me") {
      const btn = document.createElement("button");
      btn.className = "icon-button";
      btn.innerHTML = `
        <svg class="icon-gear" viewBox="0 0 20 20" fill="none">
          <path d="M9.999 12.5a2.5 2.5 0 1 0 0-5.001 2.5 2.5 0 0 0 0 5z" stroke="#4B5563" stroke-width="1.3" />
          <path d="M15.167 8.583a5.53 5.53 0 0 0-.11-.44l1.16-1.174a.55.55 0 0 0 .09-.648l-1.1-1.905a.55.55 0 0 0-.628-.26l-1.62.49a5.43 5.43 0 0 0-.77-.44l-.25-1.68A.55.55 0 0 0 11.41 2h-2.2a.55.55 0 0 0-.546.46l-.25 1.68a5.42 5.42 0 0 0-.77.44l-1.62-.49a.55.55 0 0 0-.629.26L4.295 5.3a.55.55 0 0 0 .09.649l1.16 1.173c-.05.144-.087.291-.11.441L4.5 8.999a.55.55 0 0 0-.5.546v2.91c0 .29.219.53.5.546l1.935.12c.034.145.077.288.129.429l-1.178 1.24a.55.55 0 0 0-.067.659l1.2 1.856a.55.55 0 0 0 .622.239l1.74-.56c.13.073.263.14.4.2l.27 1.78a.55.55 0 0 0 .545.46h2.2a.55.55 0 0 0 .545-.46l.27-1.78c.137-.06.27-.127.4-.2l1.74.56a.55.55 0 0 0 .622-.239l1.2-1.857a.55.55 0 0 0-.068-.658l-1.177-1.24c.052-.141.095-.284.129-.429l1.935-.12a.55.55 0 0 0 .5-.547v-2.91a.55.55 0 0 0-.5-.546L15.167 8.583z" stroke="#4B5563" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      `;
      btn.addEventListener("click", () => {
        alert("è¨­å®šé¢æ¿ä¹‹å¾Œæœƒæ¥ä¸ŠçœŸæ­£çš„åŠŸèƒ½ï¼ˆç›®å‰ç‚ºç¤ºæ„ï¼‰ã€‚");
      });
      topRightSlot.appendChild(btn);
    }
  }

  // ========= äººå€‘ï¼ˆå·§é‡ï¼‰ =========
  function pickRandomBatch() {
    const shuffled = shuffleArray(people);
    currentBatch = shuffled.slice(0, 4);
  }

  function renderStatusBadge(p) {
    let statusClass = "status-badge";
    if (p.status === "busy") statusClass += " status-busy";
    if (p.status === "away" || p.status === "offline") statusClass += " status-away";
    if (p.status === "eating") statusClass += " status-eating";
    if (p.status === "shower") statusClass += " status-shower";
    return `<span class="${statusClass}"><span class="status-dot"></span><span>${p.statusText || "å·²ä¸Šç·š"}</span></span>`;
  }

  function renderPeopleGrid() {
    if (!peopleGridEl) return;
    if (currentBatch.length === 0) pickRandomBatch();
    peopleGridEl.innerHTML = "";
    currentBatch.forEach(p => {
      const card = document.createElement("div");
      card.className = "people-card";

      const photo = document.createElement("div");
      photo.className = "people-photo";
      photo.innerHTML = `<img src="${p.avatar}" alt="${p.name}" />`;
      // ä¾ä½ è¦æ±‚ï¼šé»ã€Œç…§ç‰‡ã€é€²å…¥å°å¤–è³‡æ–™
      photo.addEventListener("click", (e) => {
        e.stopPropagation();
        openProfileDetailWithUser(p);
      });

      const info = document.createElement("div");
      info.className = "people-info";
      const row1 = document.createElement("div");
      row1.className = "people-name-row";
      row1.innerHTML = `
        <div class="people-name">${p.name}</div>
        <div class="people-age">${p.ageText}</div>
      `;
      const statusDiv = document.createElement("div");
      statusDiv.innerHTML = renderStatusBadge(p);
      const desc = document.createElement("div");
      desc.className = "people-desc";
      desc.textContent = p.desc;

      info.appendChild(row1);
      info.appendChild(statusDiv.firstChild);
      info.appendChild(desc);

      card.appendChild(photo);
      card.appendChild(info);

      // å¡ç‰‡å…¶ä»–ç©ºç™½è™•é»ä¹Ÿå¯ä»¥é€²å…¥å°å¤–è³‡æ–™
      card.addEventListener("click", () => openProfileDetailWithUser(p));

      peopleGridEl.appendChild(card);
    });
  }

  // ========= å¥½å‹ç³»çµ±ï¼šé—œä¿‚åˆ¤æ–·èˆ‡æ“ä½œ =========
  function getRelationship(uid) {
    if (!uid) return "none";
    if (friendState.friends.some(x => x.uid === uid)) return "friend";

    const s = friendState.sent.find(x => x.uid === uid);
    if (s) {
      if (s.status === "pending") return "sentPending";
      if (s.status === "accepted") return "friend";
      if (s.status === "rejected") return "sentRejected";
    }
    const r = friendState.received.find(x => x.uid === uid);
    if (r) {
      if (r.status === "pending") return "receivedPending";
      if (r.status === "accepted") return "friend";
      if (r.status === "rejected") return "receivedRejected";
    }
    return "none";
  }

  function sendFriendRequestForCurrent() {
    const u = currentProfileUser;
    if (!u || !u.uid) return;
    const rel = getRelationship(u.uid);
    if (rel === "friend") {
      alert("ä½ å€‘å·²ç¶“æ˜¯å¥½å‹ã€‚");
      return;
    }
    if (rel === "sentPending") {
      alert("å·²é€å‡ºå¥½å‹ç”³è«‹ï¼Œç­‰å¾…å°æ–¹å›è¦†ã€‚");
      return;
    }

    friendState.sent.push({
      uid: u.uid,
      user: { ...u },
      status: "pending"
    });
    alert("å·²é€å‡ºå¥½å‹ç”³è«‹ï¼ˆç¤ºæ„ï¼‰ï¼Œå°æ–¹åŒæ„å¾Œæœƒå‡ºç¾åœ¨å¥½å‹åˆ—è¡¨ã€‚");
    updateFriendBadges();
    renderFriendsList(currentFriendTab);
    setupProfileDetailActionButtons(); // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
  }

  function acceptFriend(uid) {
    const r = friendState.received.find(x => x.uid === uid);
    if (!r) return;
    r.status = "accepted";

    if (!friendState.friends.some(x => x.uid === uid)) {
      friendState.friends.push({ uid, user: { ...r.user } });
    }
    const s = friendState.sent.find(x => x.uid === uid);
    if (s) s.status = "accepted";

    updateFriendBadges();
    renderFriendsList(currentFriendTab);
    setupProfileDetailActionButtons();
  }

  function rejectFriend(uid) {
    const r = friendState.received.find(x => x.uid === uid);
    if (!r) return;
    r.status = "rejected";
    const s = friendState.sent.find(x => x.uid === uid);
    if (s) s.status = "rejected";

    updateFriendBadges();
    renderFriendsList(currentFriendTab);
    setupProfileDetailActionButtons();
  }

  function updateFriendBadges() {
    const pendingReceived = friendState.received.filter(x => x.status === "pending").length;
    const pendingSent = friendState.sent.filter(x => x.status === "pending").length;

    document.querySelectorAll("[data-friendtab]").forEach(btn => {
      const type = btn.getAttribute("data-friendtab");
      let label = "å¥½å‹";
      if (type === "sent") label = "é€å‡ºç”³è«‹";
      if (type === "received") label = "æ”¶åˆ°ç”³è«‹";

      let badgeHtml = "";
      if (type === "received" && pendingReceived > 0) {
        badgeHtml = `<span style="
          display:inline-flex;
          min-width:16px;
          height:16px;
          align-items:center;
          justify-content:center;
          background:#ef4444;
          color:#fff;
          border-radius:999px;
          font-size:11px;
          margin-left:4px;
          padding:0 4px;
        ">${pendingReceived}</span>`;
      }
      if (type === "sent" && pendingSent > 0) {
        badgeHtml = `<span style="
          display:inline-flex;
          min-width:16px;
          height:16px;
          align-items:center;
          justify-content:center;
          background:#ef4444;
          color:#fff;
          border-radius:999px;
          font-size:11px;
          margin-left:4px;
          padding:0 4px;
        ">${pendingSent}</span>`;
      }

      btn.innerHTML = label + badgeHtml;
    });
  }

  // ========= ç›¸ç‰‡ Viewer & é€ç¦®å‹•ç•« =========
  function openPhotoViewer(src) {
    const viewer = document.getElementById("photoViewer");
    if (!viewer) return;
    const img = viewer.querySelector("img");
    if (!img) return;
    img.src = src;
    viewer.classList.add("show");
  }
  function closeViewer() {
    const viewer = document.getElementById("photoViewer");
    if (!viewer) return;
    viewer.classList.remove("show");
  }
  window.openPhotoViewer = openPhotoViewer;
  window.closeViewer = closeViewer;

  function spawnHeart(x, y) {
    const h = document.createElement("div");
    h.className = "gift-heart";
    h.textContent = "ğŸ’—";
    h.style.position = "fixed";
    h.style.left = x + "px";
    h.style.top = y + "px";
    h.style.fontSize = "32px";
    h.style.pointerEvents = "none";
    h.style.transition = "transform 1s ease-out, opacity 1s ease-out";
    document.body.appendChild(h);
    requestAnimationFrame(() => {
      h.style.transform = "translateY(-60px)";
      h.style.opacity = "0";
    });
    setTimeout(() => h.remove(), 1000);
  }
  function sendGiftAnimation(el) {
    const rect = el.getBoundingClientRect();
    spawnHeart(rect.left + rect.width / 2, rect.top);
    alert("é€™é‚Šä¹‹å¾Œæœƒæ‰“é–‹é€ç¦®ç‰©é¢æ¿ã€‚");
  }
  function sendGiftAnimationFromHeader(btn) {
    const rect = btn.getBoundingClientRect();
    spawnHeart(rect.left + rect.width / 2, rect.top);
    alert("é€™é‚Šä¹‹å¾Œæœƒæ‰“é–‹é€ç¦®ç‰©é¢æ¿ã€‚");
  }
  function setAsAvatar(idx) {
    const newAvatar = albumPhotos[idx];
    const avatarImg = document.querySelector(".profile-avatar img");
    if (avatarImg) avatarImg.src = newAvatar;
    alert("å·²æŠŠé€™å¼µç…§ç‰‡è¨­ç‚ºé ­è²¼ï¼ï¼ˆåƒ…ç¤ºæ„ï¼‰");
  }
  window.sendGiftAnimation = sendGiftAnimation;
  window.sendGiftAnimationFromHeader = sendGiftAnimationFromHeader;
  window.setAsAvatar = setAsAvatar;

  // ========= æˆ‘çš„ç‹€æ…‹ & å¥½å‹é™å®šå°èª =========
  function updateMyStatus() {
    if (!statusSelect || !myStatusBadge || !myStatusText || !myProfileSub) return;
    const val = statusSelect.value;
    let text = "å·²ä¸Šç·š";
    let cls = "status-badge";

    if (val === "online") text = "å·²ä¸Šç·š";
    if (val === "busy") { text = "å¿™ç¢Œä¸­â€¦"; cls += " status-busy"; }
    if (val === "eating") { text = "ç”¨é¤å»â€¦"; cls += " status-eating"; }
    if (val === "shower") { text = "æ´—æ¾¡ä¸­â€¦"; cls += " status-shower"; }
    if (val === "away") { text = "æš«é›¢ä¸­â€¦"; cls += " status-away"; }
    if (val === "offline") { text = "é›¢ç·šä¸­"; cls += " status-away"; }
    if (val === "chatty") text = "æƒ³èŠå¤©";

    myStatusBadge.className = cls;
    myStatusText.textContent = text;
    myProfileSub.textContent = "å°ç£ Â· 30 æ­²å·¦å³ Â· " + text;
  }

  function updateFriendNotePreview() {
    if (!friendNoteInput || !friendNotePreview) return;
    const t = friendNoteInput.value.trim() || "ï¼ˆå°šæœªè¨­å®šï¼‰";
    friendNotePreview.innerHTML = '<span class="label">å¥½å‹é™å®šï¼š</span>' + t;
  }

  // ========= èŠå¤© =========
  function sendChat() {
    if (!chatInputEl || !chatMessagesEl) return;
    const text = chatInputEl.value.trim();
    if (!text) return;
    const row = document.createElement("div");
    row.className = "bubble-row me";
    const bubble = document.createElement("div");
    bubble.className = "bubble me";
    bubble.textContent = text;
    row.appendChild(bubble);
    chatMessagesEl.appendChild(row);
    chatInputEl.value = "";
    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
  }

  function sendImageBubble(src) {
    if (!chatMessagesEl) return;
    const row = document.createElement("div");
    row.className = "bubble-row me";
    const bubble = document.createElement("div");
    bubble.className = "bubble me";
    const img = document.createElement("img");
    img.src = src;
    img.alt = "image";
    img.addEventListener("click", () => openPhotoViewer(src));
    bubble.appendChild(img);
    row.appendChild(bubble);
    chatMessagesEl.appendChild(row);
    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
  }

  function startChatWithUser(user) {
    currentChatUser = user;
    showPage("chat");
    if (topTitleEl) {
      topTitleEl.textContent = user.name + " Â· èŠå¤©";
    }
    if (!chatMessagesEl) return;
    // é–‹æ–°å°è©±æ™‚æ¸…ä¸€ç‰ˆï¼Œçµ¦æç¤ºè¨Šæ¯
    chatMessagesEl.innerHTML = "";
    const row = document.createElement("div");
    row.className = "bubble-row";
    const bubble = document.createElement("div");
    bubble.className = "bubble them";
    bubble.innerHTML = `ä½ æ­£åœ¨èˆ‡ <b>${user.name}</b> èŠå¤©ï¼ˆç¤ºæ„ç”¨ï¼Œå°šæœªä¸²æ¥çœŸå¯¦ä¼ºæœå™¨ï¼‰ã€‚`;
    row.appendChild(bubble);
    chatMessagesEl.appendChild(row);
  }

  // ========= æˆ‘çš„ç›¸ç°¿ï¼VIP =========
  const MY_ALBUM_SLOTS = 6;
  let myAlbumPhotosCache = null;

  function hmHasCompletedProfile() {
    try {
      return localStorage.getItem("hmProfileCompleted") === "true";
    } catch (e) {
      return false;
    }
  }

  function hmSaveProfileData(data) {
    try {
      localStorage.setItem("hmProfileData", JSON.stringify(data));
      localStorage.setItem("hmProfileCompleted", "true");
    } catch (e) { }
  }

  function hmSetAuthProvider(provider) {
    try {
      localStorage.setItem("hmAuthProvider", provider);
    } catch (e) { }
  }

  function hmGetAuthProvider() {
    try {
      return localStorage.getItem("hmAuthProvider") || "";
    } catch (e) {
      return "";
    }
  }

  function hmBuildSocialUrl(platform, value) {
    if (!value) return null;
    const v = value.trim();
    if (!v) return null;
    if (v.startsWith("http://") || v.startsWith("https://")) return v;
    switch (platform) {
      case "threads": return "https://www.threads.net/@" + v.replace(/^@/, "");
      case "x": return "https://x.com/" + v.replace(/^@/, "");
      case "instagram": return "https://www.instagram.com/" + v.replace(/^@/, "");
      case "facebook": return "https://www.facebook.com/" + v;
      default: return null;
    }
  }

  function hmInitProfileCard() {
    const dataStr = localStorage.getItem("hmProfileData");
    const nameEl = document.getElementById("hm-profile-name");
    const metaEl = document.getElementById("hm-profile-meta");
    const regionEl = document.getElementById("hm-profile-region");
    const avatarTextEl = document.getElementById("hm-profile-avatar-text");
    const socialListEl = document.getElementById("hm-profile-social-list");
    const bindEl = document.getElementById("hm-profile-bind");
    if (!nameEl || !metaEl || !regionEl || !avatarTextEl || !socialListEl) return;

    let profile = null;
    if (dataStr) {
      try { profile = JSON.parse(dataStr); } catch (e) { }
    }
    const name = profile && profile.name ? profile.name : "æœªè¨­å®šå§“å";
    const height = profile && profile.height ? profile.height : "";
    const weight = profile && profile.weight ? profile.weight : "";
    const region = profile && profile.region ? profile.region : "æœªå¡«å¯«";

    nameEl.textContent = name;
    regionEl.textContent = "å±…ä½å€åŸŸï¼š" + region;

    if (height || weight) {
      const hText = height ? height + "cm" : "èº«é«˜æœªå¡«å¯«";
      const wText = weight ? weight + "kg" : "é«”é‡æœªå¡«å¯«";
      metaEl.textContent = hText + " ï¼ " + wText;
    } else {
      metaEl.textContent = "èº«é«˜ / é«”é‡ æœªå¡«å¯«";
    }

    let avatarText = "Me";
    if (name && typeof name === "string") {
      const trimmed = name.trim();
      if (trimmed.length === 1) avatarText = trimmed;
      else if (trimmed.length >= 2) avatarText = trimmed.slice(0, 2);
    }
    avatarTextEl.textContent = avatarText;

    const provider = hmGetAuthProvider();
    if (bindEl) {
      if (!provider) bindEl.textContent = "å°šæœªç¶å®šå¸³è™Ÿ";
      else if (provider === "google") bindEl.textContent = "å·²ç¶å®šï¼šGoogle å¸³è™Ÿï¼ˆç¤ºæ„ï¼‰";
      else if (provider === "facebook") bindEl.textContent = "å·²ç¶å®šï¼šFacebook å¸³è™Ÿï¼ˆç¤ºæ„ï¼‰";
      else if (provider === "apple") bindEl.textContent = "å·²ç¶å®šï¼šApple å¸³è™Ÿï¼ˆç¤ºæ„ï¼‰";
      else bindEl.textContent = "å·²ç¶å®šï¼šå…¶ä»–ç³»çµ±å¸³è™Ÿï¼ˆç¤ºæ„ï¼‰";
    }

    const socials = (profile && profile.socials) || {};
    const items = [];
    const config = [
      { key: "threads", label: "Threads", short: "Th", className: "hm-social-threads" },
      { key: "x", label: "X", short: "X", className: "hm-social-x" },
      { key: "instagram", label: "IG", short: "IG", className: "hm-social-instagram" },
      { key: "facebook", label: "FB", short: "FB", className: "hm-social-facebook" },
      { key: "other", label: "å…¶ä»–", short: "?", className: "hm-social-other" }
    ];

    socialListEl.innerHTML = "";
    config.forEach(c => {
      const rawValue = socials[c.key];
      if (!rawValue || !rawValue.trim) return;
      if (!rawValue.trim()) return;
      const url = hmBuildSocialUrl(c.key, rawValue);
      items.push({
        key: c.key, label: c.label, short: c.short, className: c.className,
        raw: rawValue.trim(), url
      });
    });

    if (!items.length) {
      const span = document.createElement("span");
      span.className = "hm-profile-social-empty";
      span.textContent = "ç›®å‰å°šæœªä¸²è¯ä»»ä½•ç¤¾ç¾¤å¸³è™Ÿ";
      socialListEl.appendChild(span);
    } else {
      items.forEach(item => {
        let el;
        if (item.url) {
          el = document.createElement("a");
          el.href = item.url;
          el.target = "_blank";
          el.rel = "noopener noreferrer";
        } else {
          el = document.createElement("div");
        }
        el.className = "hm-social-chip " + item.className;

        const icon = document.createElement("span");
        icon.className = "hm-social-icon";
        icon.textContent = item.short;

        const text = document.createElement("span");
        const displayRaw = item.raw.length > 14 ? item.raw.slice(0, 13) + "..." : item.raw;
        text.textContent = item.label + "ï½œ" + displayRaw;

        el.appendChild(icon);
        el.appendChild(text);
        socialListEl.appendChild(el);
      });
    }
  }

  function hmGetVipLevel() {
    try {
      const raw = localStorage.getItem("hmVipLevel");
      const n = parseInt(raw || "0", 10);
      if (isNaN(n) || n < 0) return 0;
      if (n > 5) return 5;
      return n;
    } catch (e) {
      return 0;
    }
  }
  function hmSetVipLevel(level) {
    const lvl = Math.min(Math.max(level, 0), 5);
    try { localStorage.setItem("hmVipLevel", String(lvl)); } catch (e) { }
    hmUpdateVipUI();
    renderMyAlbum();
  }
  function hmUpdateVipUI() {
    const lvl = hmGetVipLevel();
    const badge = document.getElementById("myVipBadge");
    const textEl = document.getElementById("vipLevelText");
    if (badge) {
      if (lvl <= 0) { badge.style.display = "none"; badge.textContent = ""; }
      else { badge.style.display = "inline-flex"; badge.textContent = "VIP" + lvl; }
    }
    if (textEl) {
      if (lvl <= 0) textEl.textContent = "ç›®å‰ VIP ç­‰ç´šï¼šç„¡ï¼ˆDemoï¼‰";
      else textEl.textContent = "ç›®å‰ VIP ç­‰ç´šï¼šVIP" + lvl + "ï¼ˆDemoï¼‰";
    }
  }

  function hmLoadAlbumPhotos() {
    if (myAlbumPhotosCache) return myAlbumPhotosCache;
    try {
      const raw = localStorage.getItem("hmMyAlbumPhotos");
      if (raw) {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed) && parsed.length === MY_ALBUM_SLOTS) {
          myAlbumPhotosCache = parsed;
          return parsed;
        }
      }
    } catch (e) { }
    myAlbumPhotosCache = new Array(MY_ALBUM_SLOTS).fill(null);
    return myAlbumPhotosCache;
  }
  function hmSaveAlbumPhotos() {
    try {
      localStorage.setItem("hmMyAlbumPhotos", JSON.stringify(myAlbumPhotosCache || []));
    } catch (e) { }
  }
  function hmAlbumIsUnlocked() {
    if (hmGetVipLevel() > 0) return true;
    try {
      return sessionStorage.getItem("hmAlbumUnlocked") === "true";
    } catch (e) {
      return false;
    }
  }
  function hmAlbumUnlock() {
    try { sessionStorage.setItem("hmAlbumUnlocked", "true"); } catch (e) { }
    alert("Demoï¼šå‡è¨­ä½ çœ‹å®Œä¸€æ®µå»£å‘Šï¼Œç¾åœ¨æš«æ™‚è§£é– 4 å¼µç…§ç‰‡ï¼Œé‡æ–°æ•´ç†æˆ–é—œé–‰ç€è¦½å™¨å¾Œæœƒå†é–å›å»ã€‚");
    renderMyAlbum();
  }

  function renderMyAlbum() {
    const grid = document.getElementById("myAlbumGrid");
    if (!grid) return;
    const photos = hmLoadAlbumPhotos();
    const vip = hmGetVipLevel();
    const unlocked = hmAlbumIsUnlocked();

    grid.innerHTML = "";
    for (let i = 0; i < MY_ALBUM_SLOTS; i++) {
      const isFree = i < 2;
      const isLocked = !isFree && vip === 0 && !unlocked;
      const slot = document.createElement("div");
      slot.className = "my-album-item";

      const img = document.createElement("img");
      img.id = "myAlbumImg_" + i;
      if (photos[i]) img.src = photos[i];
      else img.style.opacity = "0.3";
      slot.appendChild(img);

      const label = document.createElement("div");
      label.className = "my-album-slot-label";
      label.textContent = isFree ? `ç¬¬ ${i + 1} å¼µ Â· å…è²»é è¦½` : `ç¬¬ ${i + 1} å¼µ Â· éœ€è§£é–`;
      slot.appendChild(label);

      const fileInput = document.createElement("input");
      fileInput.type = "file";
      fileInput.accept = "image/*";
      fileInput.style.display = "none";
      fileInput.id = "myAlbumInput_" + i;
      slot.appendChild(fileInput);

      const uploadBtn = document.createElement("button");
      uploadBtn.type = "button";
      uploadBtn.className = "my-album-upload-btn";
      uploadBtn.textContent = photos[i] ? "æ›´æ›" : "ä¸Šå‚³";
      uploadBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        fileInput.click();
      });
      slot.appendChild(uploadBtn);

      fileInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (ev) {
          const result = ev.target.result;
          if (!result) return;
          const arr = hmLoadAlbumPhotos();
          arr[i] = result;
          myAlbumPhotosCache = arr;
          hmSaveAlbumPhotos();
          renderMyAlbum();
        };
        reader.readAsDataURL(file);
      });

      slot.addEventListener("click", () => {
        const src = photos[i];
        if (src) openPhotoViewer(src);
      });

      if (isLocked) {
        const overlay = document.createElement("div");
        overlay.className = "my-album-lock-overlay";
        overlay.innerHTML = `
          <div>ğŸ”’ é–å®šç…§ç‰‡<br>è§€çœ‹ä¸€æ¬¡å»£å‘Šå³å¯æš«æ™‚è§£é– 4 å¼µç…§ç‰‡</div>
        `;
        overlay.style.position = "absolute";
        overlay.style.inset = "0";
        overlay.style.background = "rgba(0,0,0,0.55)";
        overlay.style.display = "flex";
        overlay.style.flexDirection = "column";
        overlay.style.alignItems = "center";
        overlay.style.justifyContent = "center";
        overlay.style.color = "#fff";
        overlay.style.fontSize = "13px";
        overlay.style.textAlign = "center";
        overlay.style.borderRadius = "12px";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "my-album-lock-btn";
        btn.textContent = "è§€çœ‹å»£å‘Šæš«æ™‚è§£é–ï¼ˆDemoï¼‰";
        btn.style.marginTop = "8px";
        btn.style.padding = "6px 12px";
        btn.style.borderRadius = "999px";
        btn.style.border = "none";
        btn.style.background = "#f97316";
        btn.style.color = "#fff";
        btn.style.fontSize = "13px";
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          hmAlbumUnlock();
        });
        overlay.appendChild(btn);
        slot.style.position = "relative";
        slot.appendChild(overlay);
      }

      grid.appendChild(slot);
    }
  }

  function hmLoadMyAvatar() {
    try { return localStorage.getItem("hmMyAvatar") || ""; } catch (e) { return ""; }
  }
  function hmSaveMyAvatar(dataUrl) {
    try { localStorage.setItem("hmMyAvatar", dataUrl); } catch (e) { }
  }
  function hmInitMyAvatar() {
    const img = document.getElementById("myProfileAvatarImg");
    const stored = hmLoadMyAvatar();
    if (img && stored) img.src = stored;
  }

  // ========= é™Œç”Ÿäººç›¸ç°¿è§£é–ï¼ˆ1~2 å¼µå…è²»ï¼Œ3~6 å¼µéœ€çœ‹å»£å‘Šæˆ– VIPï¼‰ =========
  function isProfileAlbumUnlocked() {
    // è§€è€… VIP > 0 â†’ å…¨é–‹æ”¾
    if (hmGetVipLevel() > 0) return true;

    try {
      const raw = sessionStorage.getItem("hmProfileAlbumUnlockedUntil");
      if (!raw) return false;
      const expire = parseInt(raw, 10);
      if (isNaN(expire)) return false;
      return Date.now() < expire;
    } catch (e) {
      return false;
    }
  }

  function unlockProfileAlbum() {
    const expire = Date.now() + 30 * 60 * 1000; // 30 åˆ†é˜
    try {
      sessionStorage.setItem("hmProfileAlbumUnlockedUntil", String(expire));
    } catch (e) { }

    alert("å·²è§£é–æ­¤ç”¨æˆ¶ç›¸ç°¿ï¼Œ30 åˆ†é˜å…§å¯è§€çœ‹å…¨éƒ¨ç…§ç‰‡ï¼ˆDemoï¼‰ã€‚");

    // é‡æ–° render ç•¶å‰å°å¤–è³‡æ–™é 
    if (currentProfileUser) {
      openProfileDetailWithUser(currentProfileUser);
    }
  }
  window.unlockProfileAlbum = unlockProfileAlbum;

  // ========= è©³ç´°æª”æ¡ˆï¼ˆå°å¤–è³‡æ–™ï¼‰ =========
  function openProfileDetail(id) {
    const p = people.find(x => x.id === id);
    if (!p) return;
    openProfileDetailWithUser(p);
  }

  function openProfileDetailWithUser(user) {
    // ç¢ºä¿ user.uid å­˜åœ¨
    const u = { ...user };
    if (!u.uid) {
      u.uid = u.id ? "people-" + u.id : "user-" + Date.now();
    }
    currentProfileUser = u;

    const statusBadgeHtml = renderStatusBadge(u);
    const vipLevelForUserDisplay = (u.id || 1) % 5 + 1; // åªæ˜¯é¡¯ç¤ºç”¨çš„ VIP
    const viewerVipLevel = hmGetVipLevel ? hmGetVipLevel() : 0;
    const profileAlbumUnlocked = isProfileAlbumUnlocked();

    // å»ºç«‹é™Œç”Ÿäººç›¸ç°¿ HTMLï¼š1~2 å¼µå…è²»ï¼Œ3~6 å¼µä¾ç…§ VIP / è§£é–ç‹€æ…‹åˆ¤æ–·
    let albumHtml = "";
    albumPhotos.forEach((src, idx) => {
      const photoIndex = idx + 1;
      const isFree = photoIndex <= 2; // ç¬¬ 1ã€2 å¼µå…è²»
      const canView = isFree || viewerVipLevel > 0 || profileAlbumUnlocked;

      if (canView) {
        albumHtml += `
          <div class="album-item" onclick="openPhotoViewer('${src}')">
            <img src="${src}" alt="photo${photoIndex}" />
            <button class="set-cover-btn"
              onclick="event.stopPropagation(); setAsAvatar(${idx})">è¨­ç‚ºé ­è²¼</button>
            <div class="album-gift-btn"
              onclick="event.stopPropagation(); sendGiftAnimation(this)">ğŸ’ é€ç¦®</div>
          </div>
        `;
      } else {
        albumHtml += `
          <div class="album-item" onclick="unlockProfileAlbum()" style="position:relative; cursor:pointer;">
            <img src="${src}" alt="photo${photoIndex}"
              style="filter: blur(6px); opacity: 0.7; border-radius: 12px;" />
            <div style="
              position:absolute; inset:0;
              background:rgba(0,0,0,0.55);
              display:flex; flex-direction:column;
              align-items:center; justify-content:center;
              color:#fff; font-size:13px; text-align:center;
              padding:8px; border-radius:12px;">
              <div>
                ğŸ”’ é–å®šç…§ç‰‡ï¼ˆç¬¬ ${photoIndex} å¼µï¼‰<br>
                è§€çœ‹ 1 å‰‡å°å»£å‘Šå³å¯è§£é– 30 åˆ†é˜å…§å…¨éƒ¨ç…§ç‰‡ï¼ˆDemoï¼‰
              </div>
              <button type="button"
                style="margin-top:8px; padding:6px 12px; border-radius:999px; border:none; background:#f97316; color:#fff; font-size:13px;"
                onclick="event.stopPropagation(); unlockProfileAlbum();">
                â–¶ è§€çœ‹å»£å‘Šè§£é–
              </button>
            </div>
          </div>
        `;
      }
    });

    if (!profileDetailContent) return;

    profileDetailContent.innerHTML = `
      <div class="profile-header">
        <div class="profile-row-main">
          <div class="profile-avatar" onclick="openPhotoViewer('${u.avatar}')">
            <img src="${u.avatar}" alt="${u.name}" />
          </div>
          <div>
            <div class="profile-name">${u.name}</div>
            <div class="profile-sub">${u.ageText || "å¹´é½¡æœªè¨­å®š"} Â· å°ç£ Â· æš«ç„¡æ›´å¤šä»‹ç´¹</div>
            <div style="margin-top:6px; font-size:15px;">${statusBadgeHtml}</div>
          </div>
        </div>
        <div class="profile-actions">
          <button class="btn" id="profileBlockBtn">å°é– / åˆªé™¤</button>
          <button class="btn btn-primary" id="profileFriendOrChatBtn"></button>
        </div>
      </div>

      <div class="section">
        <div class="profile-cta-row">
          <div class="profile-vip-label">
            <span>â­ VIP${vipLevelForUserDisplay} ç”¨æˆ¶ï¼ˆç¤ºæ„ï¼‰</span>
          </div>
          <button class="big-cta-btn primary" onclick="sendGiftAnimationFromHeader(this)">ğŸ é€ç¦®ç‰©</button>
        </div>
      </div>

      <div class="section">
        <div class="section-title">ç›¸ç°¿ï¼ˆ1ï½2 å¼µå…è²»ï¼Œå…¶é¤˜ä¾ VIP / è§£é–ï¼‰</div>
        <div class="album-grid">
          ${albumHtml}
        </div>
        <div class="album-note">
          ç›¸ç°¿åƒ…ç¤ºæ„ï¼Œæ­£å¼ç‰ˆå¯ä»¥ä¸Šå‚³è‡ªå·±çš„ç…§ç‰‡ã€è¨­å®šå¯è¦‹ç¯„åœèˆ‡è§£é–æ–¹å¼ã€‚
        </div>
      </div>

      <div class="section">
        <div class="section-title">åŸºæœ¬è³‡æ–™</div>
        <table class="info-table">
          <tr><td class="info-key">æš±ç¨±</td><td class="info-value">${u.name}</td></tr>
          <tr><td class="info-key">æ€§åˆ¥</td><td class="info-value">æœªè¨­å®š</td></tr>
          <tr><td class="info-key">å¹´é½¡å±¤</td><td class="info-value">${u.ageText || "æœªè¨­å®š"}</td></tr>
          <tr><td class="info-key">åœ‹å®¶</td><td class="info-value">å°ç£</td></tr>
          <tr><td class="info-key">åœ°å€</td><td class="info-value">æœªè¨­å®š</td></tr>
          <tr><td class="info-key">è‡ªæˆ‘ä»‹ç´¹</td><td class="info-value">${u.desc || ""}</td></tr>
        </table>
      </div>

      <div class="section">
        <div class="section-title">è‡ªä»‹æ—¥è¨˜ï¼ˆç¤ºæ„ï¼‰</div>
        <div class="diary-list">
          <div class="diary-item">
            <div class="diary-date">2025-11-25</div>
            <div>é€™è£¡ä¹‹å¾Œå¯ä»¥é¡¯ç¤ºå°æ–¹çš„ 5 ç¯‡ä»£è¡¨æ—¥è¨˜ï¼Œè®“äººæ›´äº†è§£ä»–ã€‚</div>
          </div>
        </div>
      </div>
    `;

    showPage("profileDetail");
    if (topTitleEl) topTitleEl.textContent = u.name;

    setupProfileDetailActionButtons();
  }

  function setupProfileDetailActionButtons() {
    const btn = document.getElementById("profileFriendOrChatBtn");
    if (!btn || !currentProfileUser) return;
    const uid = currentProfileUser.uid;
    const rel = getRelationship(uid);

    btn.disabled = false;
    btn.textContent = "";

    if (rel === "friend") {
      btn.textContent = "1 å° 1 èŠå¤©";
      btn.onclick = () => startChatWithUser(currentProfileUser);
    } else if (rel === "sentPending") {
      btn.textContent = "å·²é€å‡ºå¥½å‹ç”³è«‹";
      btn.disabled = true;
      btn.onclick = null;
    } else if (rel === "receivedPending") {
      btn.textContent = "åŒæ„å¥½å‹ç”³è«‹";
      btn.onclick = () => acceptFriend(uid);
    } else if (rel === "sentRejected" || rel === "receivedRejected") {
      btn.textContent = "å·²æ‹’çµ• / ç„¡æ³•åŠ å¥½å‹";
      btn.disabled = true;
      btn.onclick = null;
    } else {
      btn.textContent = "åŠ å…¥å¥½å‹";
      btn.onclick = () => sendFriendRequestForCurrent();
    }
  }

  // ========= å¥½å‹åˆ—è¡¨ï¼ˆ3 åˆ†é ï¼‰ =========
  function renderFriendsList(type) {
    currentFriendTab = type;
    if (!friendsListEl) return;
    friendsListEl.innerHTML = "";

    let list = [];
    if (type === "friends") list = friendState.friends;
    else if (type === "sent") list = friendState.sent;
    else list = friendState.received;

    if (!list.length) {
      const empty = document.createElement("div");
      empty.style.padding = "16px";
      empty.style.fontSize = "14px";
      empty.style.color = "#9ca3af";
      empty.textContent =
        type === "friends"
          ? "ç›®å‰é‚„æ²’æœ‰å¥½å‹ï¼Œå¾ã€å·§é‡ã€æˆ–ã€æ’è¡Œæ¦œã€è©¦è‘—åŠ çœ‹çœ‹å§ã€‚"
          : type === "sent"
          ? "ç›®å‰æ²’æœ‰é€å‡ºçš„å¥½å‹ç”³è«‹ã€‚"
          : "ç›®å‰æ²’æœ‰æ”¶åˆ°å¥½å‹ç”³è«‹ã€‚";
      friendsListEl.appendChild(empty);
      return;
    }

    list.forEach(entry => {
      const { user, status } = entry;
      const uid = entry.uid;

      const li = document.createElement("li");
      li.className = "list-item";
      li.dataset.uid = uid;

      const statusHtml = renderStatusBadge(user);

      let statusRowHtml = "";
      if (type === "friends") {
        statusRowHtml = `
          <div class="item-row3">
            <span class="label">å¥½å‹é™å®šï¼š</span>${friendNoteInput && friendNoteInput.value.trim() || "ä»Šå¤©å¥½é›£éï¼Œå¸Œæœ›èƒ½æœ‰å¥½å¤©æ°£å‡ºç¾ã€‚"}
          </div>
        `;
      } else {
        let stText = "å¾…å›è¦†";
        if (status === "accepted") stText = "å·²åŒæ„";
        if (status === "rejected") stText = "å·²æ‹’çµ•";
        statusRowHtml = `
          <div class="item-row3">
            <span class="label">ç”³è«‹ç‹€æ…‹ï¼š</span><span class="friend-status-text">${stText}</span>
            ${
              type === "received" && status === "pending"
                ? `<div style="margin-top:6px;">
                    <button type="button" class="friend-accept-btn" style="margin-right:6px; font-size:13px; padding:4px 8px; border-radius:999px; border:1px solid #22c55e; background:#ecfdf5; color:#166534;">åŒæ„</button>
                    <button type="button" class="friend-reject-btn" style="font-size:13px; padding:4px 8px; border-radius:999px; border:1px solid #ef4444; background:#fef2f2; color:#b91c1c;">æ‹’çµ•</button>
                  </div>`
                : ""
            }
          </div>
        `;
      }

      li.innerHTML = `
        <div class="avatar">
          <img src="${user.avatar}" alt="${user.name}" />
        </div>
        <div class="item-main">
          <div class="item-row1">
            <div class="item-row1-left">
              <span class="item-name">${user.name}</span>
              <span class="item-mood">${type === "friends" ? "ğŸ˜Š" : "ğŸ¤"}</span>
            </div>
            ${statusHtml}
          </div>
          <div class="item-row2">${user.desc || "æš«ç„¡è‡ªæˆ‘ä»‹ç´¹ã€‚"}</div>
          ${statusRowHtml}
        </div>
      `;

      // é»æ•´åˆ— â†’ çœ‹å°å¤–è³‡æ–™
      li.addEventListener("click", (e) => {
        const target = e.target;
        // å¦‚æœæ˜¯æŒ‰ä¸‹æ¥å— / æ‹’çµ•æŒ‰éˆ•ï¼Œä¸è¦è·³ profile
        if (target.classList.contains("friend-accept-btn") || target.classList.contains("friend-reject-btn")) {
          return;
        }
        openProfileDetailWithUser(user);
      });

      // é ­åƒå¯æ”¾å¤§
      const av = li.querySelector(".avatar img");
      if (av) {
        av.addEventListener("click", (e) => {
          e.stopPropagation();
          openPhotoViewer(av.src);
        });
      }

      // å¥½å‹é™å®šå°èª â†’ ç›´æ¥é–‹èŠå¤©ï¼ˆåªåœ¨ã€Œå¥½å‹ã€åˆ†é ï¼‰
      if (type === "friends") {
        const row3 = li.querySelector(".item-row3");
        if (row3) {
          row3.style.cursor = "pointer";
          row3.addEventListener("click", (e) => {
            e.stopPropagation();
            startChatWithUser(user);
          });
        }
      }

      // æ”¶åˆ°ç”³è«‹ â†’ åŒæ„ / æ‹’çµ•
      if (type === "received") {
        const acceptBtn = li.querySelector(".friend-accept-btn");
        const rejectBtn = li.querySelector(".friend-reject-btn");
        if (acceptBtn) {
          acceptBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            acceptFriend(uid);
          });
        }
        if (rejectBtn) {
          rejectBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            rejectFriend(uid);
          });
        }
      }

      friendsListEl.appendChild(li);
    });
  }

  // ========= æ’è¡Œæ¦œ =========
  function renderRank(type) {
    if (!rankPyramidEl || !rankListEl) return;
    const data = rankData[type] || [];
    if (!data.length) {
      rankPyramidEl.innerHTML = "<div style='font-size:14px; color:#9ca3af; text-align:center;'>æš«ç„¡æ’åè³‡æ–™</div>";
      rankListEl.innerHTML = "";
      return;
    }
    const king = data[0];
    const second = data[1];
    const third = data[2];
    const fourth = data[3];
    const fifth = data[4];
    const sixth = data[5];
    const rest = data.slice(6);

    let pyramidHtml = `
      <div class="rank-row">
        <div class="rank-card">
          <div class="rank-badge">
            <span class="icon">ğŸ‘‘</span>
            <span>${king.title}</span>
          </div>
          <div class="rank-avatar-wrap king">
            <div class="rank-avatar">
              <img src="${king.avatar}" alt="${king.name}" />
            </div>
          </div>
          <div class="rank-name">${king.name}</div>
          <div class="rank-sub">${king.city} Â· ${king.age}</div>
        </div>
      </div>
    `;

    pyramidHtml += `
      <div class="rank-row">
        ${
          second
            ? `
        <div class="rank-card">
          <div class="rank-avatar-wrap">
            <div class="rank-avatar medium">
              <img src="${second.avatar}" alt="${second.name}" />
            </div>
          </div>
          <div class="rank-name">${second.name}</div>
          <div class="rank-sub">${second.title} Â· ${second.city}</div>
        </div>`
            : ""
        }
        ${
          third
            ? `
        <div class="rank-card">
          <div class="rank-avatar-wrap">
            <div class="rank-avatar medium">
              <img src="${third.avatar}" alt="${third.name}" />
            </div>
          </div>
          <div class="rank-name">${third.name}</div>
          <div class="rank-sub">${third.title} Â· ${third.city}</div>
        </div>`
            : ""
        }
      </div>
    `;

    pyramidHtml += `<div class="rank-row">`;
    [fourth, fifth, sixth].forEach(item => {
      if (!item) return;
      pyramidHtml += `
        <div class="rank-card">
          <div class="rank-avatar-wrap">
            <div class="rank-avatar small">
              <img src="${item.avatar}" alt="${item.name}" />
            </div>
          </div>
          <div class="rank-name">${item.name}</div>
          <div class="rank-sub">${item.title} Â· ${item.city}</div>
        </div>
      `;
    });
    pyramidHtml += `</div>`;
    rankPyramidEl.innerHTML = pyramidHtml;

    rankListEl.innerHTML = "";
    rest.forEach(item => {
      const li = document.createElement("div");
      li.className = "rank-list-item";
      li.innerHTML = `
        <div class="rank-pos">${item.pos}</div>
        <div class="rank-list-avatar">
          <img src="${item.avatar}" alt="${item.name}" />
        </div>
        <div class="rank-list-main">
          <div class="rank-list-name">${item.name} Â· ${item.title}</div>
          <div class="rank-list-sub">${item.city} Â· ${item.age}</div>
        </div>
        <div class="rank-score">${item.score} åˆ†</div>
      `;
      const av = li.querySelector(".rank-list-avatar img");
      if (av) {
        av.addEventListener("click", (e) => {
          e.stopPropagation();
          openPhotoViewer(av.src);
        });
      }
      rankListEl.appendChild(li);
    });
  }

  // ========= ç™»å‡ºåŠŸèƒ½ =========
  function hmLogout() {
    try {
      localStorage.removeItem("hmProfileCompleted");
      localStorage.removeItem("hmProfileData");
      localStorage.removeItem("hmAuthProvider");
      localStorage.removeItem("hmVipLevel");
      localStorage.removeItem("hmMyAlbumPhotos");
      localStorage.removeItem("hmMyAvatar");
      sessionStorage.removeItem("hmAlbumUnlocked");
      sessionStorage.removeItem("hmProfileAlbumUnlockedUntil");
    } catch (e) {}

    alert("å·²ç™»å‡ºå¸³è™Ÿï¼Œå°‡å›åˆ°ç¶å®šè¦–çª—ï¼ˆDemoï¼‰ã€‚");
    location.reload();
  }

  // ========= DOMContentLoaded åˆå§‹åŒ– =========
  document.addEventListener("DOMContentLoaded", function () {
    // æŠ“ DOM å…ƒç´ 
    peopleGridEl = document.getElementById("peopleGrid");
    nextBatchBtn = document.getElementById("nextBatchBtn");
    profileDetailContent = document.getElementById("profileDetailContent");
    topTitleEl = document.getElementById("topTitle");
    topRightSlot = document.getElementById("topRightSlot");

    friendsListEl = document.getElementById("friendsList");
    chatMessagesEl = document.getElementById("chatMessages");
    chatInputEl = document.getElementById("chatInput");
    chatSendBtn = document.getElementById("chatSendBtn");
    stickerBar = document.getElementById("stickerBar");
    stickerToggle = document.getElementById("stickerToggle");
    chatWrapper = document.getElementById("chatWrapper");
    chatUploadBtn = document.getElementById("chatUploadBtn");
    chatFileInput = document.getElementById("chatFileInput");

    statusSelect = document.getElementById("statusSelect");
    myStatusBadge = document.getElementById("myStatusBadge");
    myStatusText = document.getElementById("myStatusText");
    myProfileSub = document.getElementById("myProfileSub");

    friendNoteInput = document.getElementById("friendNoteInput");
    friendNotePreview = document.getElementById("friendNotePreview");

    pages.people = document.getElementById("page-people");
    pages.profileDetail = document.getElementById("page-profileDetail");
    pages.friends = document.getElementById("page-friends");
    pages.rank = document.getElementById("page-rank");
    pages.chat = document.getElementById("page-chat");
    pages.me = document.getElementById("page-me");

    rankPyramidEl = document.getElementById("rankPyramid");
    rankListEl = document.getElementById("rankList");

    // å·§é‡åˆå§‹åŒ–
    pickRandomBatch();
    renderPeopleGrid();

    if (nextBatchBtn) {
      nextBatchBtn.addEventListener("click", () => {
        pickRandomBatch();
        renderPeopleGrid();
      });
    }

    // å¥½å‹åˆ—è¡¨åˆå§‹åŒ–
    renderFriendsList("friends");
    updateFriendBadges();

    // ç‹€æ…‹ï¼†å¥½å‹é™å®šæ–‡å­—
    updateMyStatus();
    updateFriendNotePreview();

    if (statusSelect) {
      statusSelect.addEventListener("change", updateMyStatus);
    }
    if (friendNoteInput) {
      friendNoteInput.addEventListener("input", updateFriendNotePreview);
    }

    renderTopRightForPage("people");
    renderRank("pop");
    hmUpdateVipUI();
    renderMyAlbum();
    hmInitMyAvatar();

    // èŠå¤©äº‹ä»¶
    if (chatSendBtn) {
      chatSendBtn.addEventListener("click", sendChat);
    }
    if (chatInputEl) {
      chatInputEl.addEventListener("keydown", e => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendChat();
        }
      });
    }

    if (stickerToggle && stickerBar) {
      stickerToggle.addEventListener("click", () => {
        stickerBar.classList.toggle("show");
      });
      const stickerBtns = stickerBar.querySelectorAll(".sticker-btn");
      stickerBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          const emo = btn.textContent;
          if (chatInputEl) {
            chatInputEl.value += emo;
            chatInputEl.focus();
          }
        });
      });
    }

    if (chatUploadBtn && chatFileInput) {
      chatUploadBtn.addEventListener("click", () => chatFileInput.click());
      chatFileInput.addEventListener("change", (e) => {
        const files = Array.from(e.target.files || []);
        files.forEach(file => {
          if (!file.type.startsWith("image/")) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            const src = ev.target.result;
            if (!src) return;
            sendImageBubble(src);
          };
          reader.readAsDataURL(file);
        });
        chatFileInput.value = "";
      });
    }

    const themePills = document.querySelectorAll(".chat-theme-pill");
    themePills.forEach(pill => {
      pill.addEventListener("click", () => {
        themePills.forEach(p => p.classList.remove("active"));
        pill.classList.add("active");
        const theme = pill.getAttribute("data-theme");
        if (chatWrapper) {
          chatWrapper.className = "chat-wrapper chat-theme-" + theme;
        }
      });
    });

    // å¥½å‹åˆ†é åˆ‡æ›
    document.querySelectorAll("[data-friendtab]").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll("[data-friendtab]").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const type = btn.getAttribute("data-friendtab");
        renderFriendsList(type);
      });
    });

    // æ’è¡Œæ¦œåˆ†é åˆ‡æ›
    document.querySelectorAll("[data-ranktab]").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll("[data-ranktab]").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentRankTab = btn.getAttribute("data-ranktab");
        renderRank(currentRankTab);
      });
    });

    // åº•éƒ¨å°è¦½
    document.querySelectorAll(".nav-item").forEach(item => {
      item.addEventListener("click", () => {
        const page = item.getAttribute("data-page");
        showPage(page);
      });
    });

    // æˆ‘çš„å¤§é ­è²¼ä¸Šå‚³ + æ”¾å¤§
    const myAvatarImg = document.getElementById("myProfileAvatarImg");
    const myAvatarInput = document.getElementById("myAvatarInput");
    const myAvatarEditBtn = document.getElementById("myAvatarEditBtn");

    if (myAvatarImg) {
      myAvatarImg.addEventListener("click", () => {
        if (myAvatarImg.src) openPhotoViewer(myAvatarImg.src);
      });
    }
    if (myAvatarEditBtn && myAvatarInput && myAvatarImg) {
      myAvatarEditBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        myAvatarInput.click();
      });
      myAvatarInput.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          const src = ev.target.result;
          if (!src) return;
          myAvatarImg.src = src;
          hmSaveMyAvatar(src);
        };
        reader.readAsDataURL(file);
        myAvatarInput.value = "";
      });
    }

    // VIP Demo åˆ‡æ›
    const vipToggleBtn = document.getElementById("vipLevelToggleBtn");
    if (vipToggleBtn) {
      vipToggleBtn.addEventListener("click", () => {
        let lvl = hmGetVipLevel();
        lvl = (lvl + 1) % 6; // 0~5
        hmSetVipLevel(lvl);
      });
    }

    // ç™»å…¥ / åŸºæœ¬è³‡æ–™ Modal
    const loginModal = document.getElementById("hm-login-modal");
    const profileModal = document.getElementById("hm-profile-modal");
    const form = document.getElementById("hm-profile-form");

    if (!hmHasCompletedProfile()) {
      if (loginModal) loginModal.style.display = "flex";
    }

    function handleFakeLogin(provider) {
      hmSetAuthProvider(provider);
      if (loginModal) loginModal.style.display = "none";
      if (!hmHasCompletedProfile() && profileModal) profileModal.style.display = "flex";
      hmInitProfileCard();
    }

    const btnGoogle = document.getElementById("hm-login-google");
    const btnFacebook = document.getElementById("hm-login-facebook");
    const btnApple = document.getElementById("hm-login-apple");
    if (btnGoogle) btnGoogle.addEventListener("click", () => handleFakeLogin("google"));
    if (btnFacebook) btnFacebook.addEventListener("click", () => handleFakeLogin("facebook"));
    if (btnApple) btnApple.addEventListener("click", () => handleFakeLogin("apple"));

    if (form) {
      form.addEventListener("submit", function (e) {
        e.preventDefault();
        const name = document.getElementById("hm-name").value.trim();
        const height = document.getElementById("hm-height").value.trim();
        const weight = document.getElementById("hm-weight").value.trim();
        const region = document.getElementById("hm-region").value.trim();
        const threads = document.getElementById("hm-threads").value.trim();
        const x = document.getElementById("hm-x").value.trim();
        const instagram = document.getElementById("hm-instagram").value.trim();
        const facebook = document.getElementById("hm-facebook").value.trim();
        const other = document.getElementById("hm-other").value.trim();
        const agree = document.getElementById("hm-agree").checked;

        if (!name) { alert("è«‹å¡«å¯«ç¨±å‘¼ï¼ˆæš±ç¨±ï¼‰"); return; }
        if (!height || !weight) { alert("èº«é«˜èˆ‡é«”é‡ç‚ºå¿…å¡«æ¬„ä½"); return; }
        if (!agree) { alert("è«‹å‹¾é¸åŒæ„æœå‹™æ¢æ¬¾èˆ‡éš±ç§æ”¿ç­–"); return; }

        const profileData = {
          name, height, weight, region,
          socials: { threads, x, instagram, facebook, other },
          createdAt: new Date().toISOString()
        };
        hmSaveProfileData(profileData);
        if (profileModal) profileModal.style.display = "none";
        hmInitProfileCard();
      });
    }

    hmInitProfileCard();
    const editBtn = document.getElementById("hm-profile-edit-btn");
    if (editBtn && profileModal) {
      editBtn.addEventListener("click", function () {
        profileModal.style.display = "flex";
      });
    }

    // ã€Œæˆ‘çš„è³‡æ–™ã€é æœ€ä¸‹æ–¹è‡ªå‹•æ’å…¥ç™»å‡ºæŒ‰éˆ•
    if (pages.me) {
      const logoutWrap = document.createElement("div");
      logoutWrap.style.marginTop = "24px";
      logoutWrap.style.textAlign = "center";
      logoutWrap.innerHTML = `
        <button id="hm-logout-btn"
          style="padding:10px 20px; border-radius:999px; border:1px solid #d1d5db; background:#fff; font-size:14px;">
          ç™»å‡ºå¸³è™Ÿ
        </button>
      `;
      pages.me.appendChild(logoutWrap);

      const logoutBtn = document.getElementById("hm-logout-btn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", hmLogout);
      }
    }
  });
</script>
